generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated/client"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  //directUrl = env("DIRECT_URL")
}

enum ConsentScope {
  VIEW
  STORE
  SHARE
}

enum ConsentStatus {
  GRANTED
  WITHDRAWN
}

enum RtbfStatus {
  REQUESTED
  IN_REVIEW
  APPROVED
  REJECTED
  FULFILLED
}

enum EncounterType {
  OPD
  IPD
  ER
}

enum FacilityCategory {
  SERVICE
  CLINICAL
  SUPPORT
}

enum SpecialtyKind {
  SPECIALTY
  SUPER_SPECIALTY
}

enum BedState {
  VACANT
  OCCUPIED
  CLEANING
  MAINTENANCE
}

enum OutboxStatus {
  PENDING
  PROCESSING
  SENT
  FAILED
}

// ---------------- Service Catalog (Orderables) ----------------

enum CareContext {
  OPD
  IPD
  ER
  OT
  DAYCARE
  TELECONSULT
  HOMECARE
}

enum ServiceItemType {
  DIAGNOSTIC_LAB
  DIAGNOSTIC_IMAGING
  PROCEDURE
  NURSING
  THERAPY
  BED_CHARGE
  ADMIN
  PACKAGE
  OTHER
}

enum ServiceItemLifecycleStatus {
  DRAFT
  IN_REVIEW
  APPROVED
  PUBLISHED
  DEPRECATED
}

enum ServiceCatalogueScope {
  ENTERPRISE
  BRANCH
}

enum ServiceCatalogueStatus {
  DRAFT
  IN_REVIEW
  APPROVED
  PUBLISHED
  RETIRED
}

enum CatalogueChannel {
  DEFAULT
  QUICK_ORDER
  ORDER_SET
  OT_PICKLIST
}

enum ResourceRequirementKind {
  UNIT_RESOURCE_TYPE
  EQUIPMENT_TAG
  SERVICE_POINT_TAG
}

model Organization {
  id   String @id @default(cuid())
  code String @unique @db.VarChar(32)
  name String @db.VarChar(160)

  isActive Boolean @default(true)

  branches Branch[]
  staff    Staff[]

  // Compliance Infrastructure
  nabhTemplates        NabhTemplate[]
  complianceWorkspaces ComplianceWorkspace[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
}

model Branch {
  id   String @id @default(cuid())
  code String @unique @db.VarChar(32)
  name String
  city String

  // Organization (hospital group / chain)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  // Soft lifecycle toggle (preferred over delete)
  isActive Boolean @default(true)

  // ---- Required identity/legal (enforced at API layer; DB allows null for backfill) ----
  legalEntityName String? @db.VarChar(160)

  // Address (store as full text + PIN; keep city separately for quick filtering)
  address String? @db.VarChar(240)
  pinCode String? @db.VarChar(10)
  state   String? @db.VarChar(80)
  country String? @db.VarChar(80)

  // Contact
  contactPhone1 String? @db.VarChar(20)
  contactPhone2 String? @db.VarChar(20)
  contactEmail  String? @db.VarChar(120)

  // Statutory / registrations
  gstNumber            String? @db.VarChar(15)
  panNumber            String? @db.VarChar(10)
  clinicalEstRegNumber String? @db.VarChar(64)
  rohiniId             String? @db.VarChar(64)
  hfrId                String? @db.VarChar(64) // ABDM (auto-populated after registration)

  // Optional branding + public links
  logoUrl         String?   @db.VarChar(500)
  website         String?   @db.VarChar(200)
  socialLinks     Json?
  accreditations  Json? // e.g. ["NABH","JCI"]
  bedCount        Int?
  establishedDate DateTime?

  // Branch settings (defaults are India-centric but configurable)
  defaultCurrency      String  @default("INR") @db.VarChar(8)
  timezone             String  @default("Asia/Kolkata") @db.VarChar(64)
  fiscalYearStartMonth Int     @default(4)
  workingHours         Json? // flexible schema for future (text or structured)
  emergency24x7        Boolean @default(true)
  multiLanguageSupport Boolean @default(false)
  supportedLanguages   Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  departments                Department[]
  users                      User[]
  patients                   Patient[]
  wards                      Ward[]
  tariffPlans                TariffPlan[]
  // Advanced billing setup (branch-scoped)
  taxCodes                   TaxCode[]
  payers                     Payer[]
  payerContracts             PayerContract[]
  assets                     Asset[]
  specialties                Specialty[]
  homeStaff                  Staff[]                     @relation("StaffHomeBranch")
  primaryStaff               Staff[]                     @relation("StaffPrimaryBranch")
  staffAssignments           StaffAssignment[]
  userRoleBindings           UserRoleBinding[]
  staffDocuments             StaffDocument[]
  staffProviderProfiles      StaffProviderProfile[]
  staffPrivilegeGrants       StaffPrivilegeGrant[]
  staffOnboardingItems       StaffOnboardingItem[]
  staffCompliancePacks       StaffCompliancePack[]
  staffComplianceAssignments StaffComplianceAssignment[]
  // Approvals (opposite relations)
  approvalRequests           ApprovalRequest[]

  // HR Ops / Workforce Management
  staffRosters       StaffRoster[]
  staffAttendances   StaffAttendance[]
  staffLeaveRequests StaffLeaveRequest[]
  staffTrainings     StaffTrainingRecord[]
  staffSeparations   StaffSeparation[]
  Encounter          Encounter[]
  Bed                Bed[]
  Admission          Admission[]

  // Facilities enabled for this branch (multi-select from FacilityCatalog)
  branchFacilities BranchFacility[]
  rooms            Room[]
  // Opposite relations (required for Prisma validation)
  statutoryCases   StatutoryCase[]
  auditEvents      AuditEvent[]

  // ✅ Policy Governance (opposite relations)
  policyVersions        PolicyVersion[]       @relation("PolicyVersion_Branch")
  policyVersionBranches PolicyVersionBranch[] @relation("PolicyTarget_Branch")

  // ---------------- Infrastructure (Setup Studio) ----------------
  locationNodes           LocationNode[]
  branchUnitTypes         BranchUnitType[]
  units                   Unit[]
  unitRooms               UnitRoom[]
  unitResources           UnitResource[]
  procedureBookings       ProcedureBooking[]
  equipmentAssets         EquipmentAsset[]
  chargeMasterItems       ChargeMasterItem[]
  serviceItems            ServiceItem[]
  serviceCatalogues       ServiceCatalogue[]
  serviceChargeMappings   ServiceChargeMapping[]
  fixItTasks              FixItTask[]
  bulkImportJobs          BulkImportJob[]
  goLiveReports           GoLiveReport[]
  diagnosticServicePoints DiagnosticServicePoint[]
  diagnosticCapabilities  DiagnosticCapability[]

  otSuites OtSuite[] @relation("OtSuite_Branch")

  infraConfig                 BranchInfraConfig?
  EquipmentPlacement          EquipmentPlacement[]
  EquipmentMovement           EquipmentMovement[]
  EquipmentDocument           EquipmentDocument[]
  EquipmentContract           EquipmentContract[]
  EquipmentMaintenanceTask    EquipmentMaintenanceTask[]
  EquipmentComplianceEvidence EquipmentComplianceEvidence[]
  GovernedChangeRequest       GovernedChangeRequest[]
  ServicePackage              ServicePackage[]
  OrderSet                    OrderSet[]
  ServiceItemStandardMapping  ServiceItemStandardMapping[]
  ServiceAvailabilityCalendar ServiceAvailabilityCalendar[]
  ExternalDirectorySource     ExternalDirectorySource[]
  ExternalDirectoryMapping    ExternalDirectoryMapping[]

  // Financial Config (Module 3.13)
  governmentSchemes GovernmentSchemeConfig[]
  pricingTiers      PatientPricingTier[]

  // Pharmacy Infrastructure
  pharmacyStores    PharmacyStore[]
  drugMasters       DrugMaster[]
  formularies       Formulary[]
  pharmSuppliers    PharmSupplier[]
  drugCategoryNodes DrugCategoryNode[]

  // Insurance Claims Transaction Layer
  insurancePolicies       PatientInsurancePolicy[]
  insuranceCases          InsuranceCase[]
  preauthRequests         PreauthRequest[]
  insuranceClaims         Claim[]
  insuranceDocuments      InsuranceDocument[]
  payerIntegrationConfigs PayerIntegrationConfig[]
  paymentAdvices          PaymentAdvice[]
  gatewayTransactions     GatewayTransaction[]
  payerDocumentTemplates  PayerDocumentTemplate[]

  // Compliance Infrastructure
  complianceWorkspaces ComplianceWorkspace[]

  // Blood Bank Module
  bloodBankFacility      BloodBankFacility?
  bbComponentMasters     BloodComponentMaster[]
  bbEquipment            BloodBankEquipment[]
  bbReagents             BloodBankReagent[]
  bbTariffConfigs        BBTariffConfig[]
  bbDonors               Donor[]
  bbBloodUnits           BloodUnit[]
  bbBloodRequests        BloodRequest[]
  bbBloodIssues          BloodIssue[]
  bbTransfusionRecords   TransfusionRecord[]
  bbQCRecords            QualityControlRecord[]
  bbDonationCamps        BloodDonationCamp[]
  bbMTPSessions          MTPSession[]
  bbMSBOSConfigs         MSBOSConfig[]
  notifications          Notification[]
  bbTransfersFrom        BloodUnitTransfer[] @relation("BBTransferFromBranch")
  bbTransfersTo          BloodUnitTransfer[] @relation("BBTransferToBranch")
  bbLookbackCases        BloodLookbackCase[]
  bbReportRuns           BBReportRun[]
}

model FacilityCatalog {
  id       String           @id @default(cuid())
  code     String           @unique @db.VarChar(48)
  name     String           @db.VarChar(160)
  category FacilityCategory

  isActive  Boolean @default(true)
  sortOrder Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Branch enablement (multi-select)
  branchLinks BranchFacility[]

  // Departments created under this facility
  departments     Department[]
  StaffAssignment StaffAssignment[]

  @@index([category, isActive, sortOrder])
}

model BranchFacility {
  id String @id @default(cuid())

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  facilityId String
  facility   FacilityCatalog @relation(fields: [facilityId], references: [id], onDelete: Cascade)

  isEnabled Boolean  @default(true)
  enabledAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([branchId, facilityId])
  @@index([branchId, isEnabled])
  @@index([facilityId, isEnabled])
}

model Department {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  facilityId String
  facility   FacilityCatalog @relation(fields: [facilityId], references: [id])
  code       String
  name       String

  headStaffId String?
  headStaff   Staff?  @relation("DepartmentHead", fields: [headStaffId], references: [id], onDelete: SetNull)

  // Optional department hierarchy (enforced in service layer)
  parentDepartmentId String?
  parentDepartment   Department?  @relation("DepartmentHierarchy", fields: [parentDepartmentId], references: [id], onDelete: SetNull)
  childDepartments   Department[] @relation("DepartmentHierarchy")

  isActive Boolean @default(true)

  // Soft deactivation metadata (required by deactivation flows)
  deactivatedAt       DateTime?
  deactivationReason  String?   @db.VarChar(500)
  deactivatedByUserId String?
  deactivatedByUser   User?     @relation("DepartmentDeactivatedBy", fields: [deactivatedByUserId], references: [id], onDelete: SetNull)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  doctorAssignments DepartmentDoctor[]

  staffAssignments      StaffAssignment[]
  staffProviderProfiles StaffProviderProfile[]
  facilityType          FacilityCategory       @default(CLINICAL)
  costCenterCode        String?                @db.VarChar(64)
  extensions            Json?
  operatingHours        Json?

  locations DepartmentLocation[]

  // ✅ Many-to-many link to specialties (single source of truth for mapping)
  departmentSpecialties DepartmentSpecialty[]

  // ---------------- Infrastructure (Setup Studio) ----------------
  units             Unit[]
  equipmentOwned    EquipmentAsset[]   @relation("EquipmentOwnerDepartment")
  serviceItems      ServiceItem[]
  serviceCatalogues ServiceCatalogue[]
  OrderSet          OrderSet[]

  // BRD: department code unique within branch (not per facility)
  @@unique([branchId, code], name: "branchId_departmentCode")
  @@index([branchId, facilityId, isActive])
  @@index([branchId, isActive])
  @@index([deactivatedByUserId])
}

model DepartmentLocation {
  id String @id @default(cuid())

  departmentId String
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  locationNodeId String
  locationNode   LocationNode @relation(fields: [locationNodeId], references: [id], onDelete: Cascade)

  isPrimary Boolean @default(false)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([departmentId, locationNodeId])
  @@index([departmentId, isActive])
  @@index([locationNodeId, isActive])
}

model DepartmentDoctor {
  id String @id @default(cuid())

  departmentId String
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)

  isPrimary  Boolean  @default(false)
  assignedAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([departmentId, staffId])
  @@index([departmentId])
  @@index([staffId])
}

model DepartmentSpecialty {
  id String @id @default(cuid())

  departmentId String
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  specialtyId String
  specialty   Specialty @relation(fields: [specialtyId], references: [id], onDelete: Cascade)
  isPrimary   Boolean   @default(false)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([departmentId, specialtyId])
  @@index([departmentId, isActive])
  @@index([specialtyId, isActive])
}

model Specialty {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  code String
  name String

  kind SpecialtyKind @default(SPECIALTY)

  isActive Boolean @default(true)

  departmentLinks       DepartmentSpecialty[]
  staffAssignments      StaffAssignment[]
  staffProviderProfiles StaffProviderProfile[]
  serviceItems          ServiceItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([branchId, code])
  @@index([branchId, isActive])
}

enum UserSource {
  ADMIN
  STAFF
  MANUAL
  SYSTEM
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum StaffTitle {
  DR
  MR
  MS
  MRS
  PROF
  OTHER
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum BloodGroup {
  A_POS
  A_NEG
  B_POS
  B_NEG
  O_POS
  O_NEG
  AB_POS
  AB_NEG
  BOMBAY
  RARE_OTHER
}

enum MaritalStatus {
  SINGLE
  MARRIED
  DIVORCED
  SEPARATED
  WIDOWED
}

enum StaffType {
  DOCTOR_CONSULTANT
  DOCTOR_RESIDENT
  DOCTOR_INTERN
  NURSE_HEAD
  NURSE_STAFF
  NURSE_TRAINEE
  TECHNICIAN_LAB
  TECHNICIAN_RADIOLOGY
  TECHNICIAN_OT
  TECHNICIAN_DIALYSIS
  TECHNICIAN_ANESTHESIA
  PHARMACIST
  PHARMACIST_ASSISTANT
  PHYSIOTHERAPIST
  DIETICIAN
  COUNSELOR
  RECEPTIONIST
  CASHIER
  HOUSEKEEPING
  SECURITY
  ADMIN_STAFF
  OTHER
}

enum StaffEmploymentType {
  PERMANENT
  CONTRACT
  CONSULTANT
  VISITING
  LOCUM
  INTERN
  TRAINEE
  VENDOR
  OTHER
}

enum StaffEmploymentStatus {
  ACTIVE
  ON_LEAVE
  SUSPENDED
  RESIGNED
  TERMINATED
  RETIRED
  OFFBOARDED
}

enum StaffVerificationStatus {
  UNVERIFIED
  PENDING
  VERIFIED
  REJECTED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum StaffShiftType {
  MORNING
  EVENING
  NIGHT
  ROTATIONAL
  CUSTOM
}

enum StaffRosterStatus {
  DRAFT
  ACTIVE
  PUBLISHED
  CANCELLED
}

enum StaffAttendanceStatus {
  PRESENT
  ABSENT
  LEAVE
  HALF_DAY
  LATE
  HOLIDAY
  WEEK_OFF
}

enum StaffLeaveStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  CANCELLED
  WITHDRAWN
}

enum ApprovalRequestStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum ApprovalEntityType {
  STAFF_LEAVE
  STAFF_ATTENDANCE_CORRECTION
  STAFF_ROSTER_PUBLISH
  STAFF_ONBOARDING_SUBMIT
}

enum ApprovalApproverKind {
  DEPARTMENT_HEAD
  BRANCH_ROLE
  GLOBAL_ROLE
  SPECIFIC_USER
}

enum ApprovalStepStatus {
  PENDING
  APPROVED
  REJECTED
  SKIPPED
  CANCELLED
}

enum StaffTrainingStatus {
  ENROLLED
  COMPLETED
  FAILED
  DROPPED
}

enum StaffAppraisalStatus {
  DRAFT
  SUBMITTED
  REVIEWED
  APPROVED
}

enum StaffCredentialStatus {
  VALID
  EXPIRING_SOON
  EXPIRED
  RENEWED
}

enum StaffCredentialAlertStage {
  D90
  D60
  D30
  D15
  D7
  D0
  POST_7
  POST_30
}

enum StaffAlertDeliveryStatus {
  PENDING
  SENT
  CANCELLED
  FAILED
}

enum StaffCategory {
  CLINICAL     @map("MEDICAL")
  NON_CLINICAL @map("NON_MEDICAL")
}

enum StaffStatus {
  ACTIVE
  SUSPENDED
  OFFBOARDED
}

enum StaffEngagementType {
  EMPLOYEE
  CONSULTANT
  VISITING
  LOCUM
  CONTRACTOR
  INTERN
  TRAINEE
  VENDOR
}

enum StaffAssignmentType {
  PERMANENT
  TEMPORARY
  ROTATION
  VISITING
  LOCUM
  CONTRACTOR
  DEPUTATION
  TRANSFER
}

enum StaffAssignmentStatus {
  ACTIVE
  PLANNED
  SUSPENDED
  ENDED
}

enum StaffCredentialType {
  MEDICAL_REG
  NURSING_REG
  PHARMACY_REG
  TECH_CERT
  OTHER
}

enum StaffCredentialVerificationStatus {
  UNVERIFIED
  PENDING
  VERIFIED
  REJECTED
}

enum StaffIdentifierType {
  AADHAAR
  PAN
  PASSPORT
  HPR_ID
  OTHER
}

enum StaffOnboardingStatus {
  DRAFT
  IN_REVIEW
  ACTIVE
}

enum StaffDocumentType {
  PROFILE_PHOTO
  SIGNATURE
  STAMP
  ID_PROOF
  EDUCATION_DEGREE
  TRAINING_CERTIFICATE
  EMPLOYMENT_CONTRACT
  MEDICAL_REG_EVIDENCE
  OTHER
}

enum StaffDocumentVerificationStatus {
  UNVERIFIED
  PENDING
  VERIFIED
  REJECTED
}

enum StaffOnboardingItemType {
  DOCUMENT
  CREDENTIAL
  IDENTIFIER
  ASSIGNMENT
  SYSTEM_ACCESS
  PRIVILEGE
  OTHER
}

enum StaffOnboardingItemStatus {
  PENDING
  DONE
  WAIVED
  REJECTED
}

enum StaffPrivilegeArea {
  OPD
  IPD
  ER
  OT
  ICU
  DIAGNOSTICS
  LAB
  RADIOLOGY
  PHARMACY
  BILLING
  ADMIN
}

enum StaffPrivilegeAction {
  VIEW
  ORDER
  PRESCRIBE
  PERFORM
  ATTEST
  DISCHARGE
  SIGN
  APPROVE
  OTHER
}

enum StaffPrivilegeTargetType {
  NONE
  SERVICE_ITEM
  DIAGNOSTIC_ITEM
  ORDER_SET
  OTHER
}

enum StaffPrivilegeStatus {
  ACTIVE
  SUSPENDED
  REVOKED
  EXPIRED
}

enum StaffComplianceRequirementKind {
  DOCUMENT
  CREDENTIAL
  IDENTIFIER
}

enum StaffComplianceAssignmentStatus {
  ACTIVE
  INACTIVE
}

model Staff {
  id String @id @default(cuid())

  // Enterprise staff code (optional in real world, but kept required here for backward compatibility)
  empCode String @unique @db.VarChar(32)

  // Display name (enterprise master)
  name String @db.VarChar(160)

  // Default designation (assignment may override)
  designation String @db.VarChar(120)

  // Structured identity (workflow-aligned; source of truth for UI + validations)
  title       StaffTitle?
  firstName   String?     @db.VarChar(80)
  middleName  String?     @db.VarChar(80)
  lastName    String?     @db.VarChar(80)
  displayName String?     @db.VarChar(160)

  dateOfBirth   DateTime?
  gender        Gender?
  bloodGroup    BloodGroup?
  maritalStatus MaritalStatus?

  primaryPhone   String? @db.VarChar(20)
  secondaryPhone String? @db.VarChar(20)
  personalEmail  String? @db.VarChar(120)
  officialEmail  String? @db.VarChar(120)

  emergencyContact Json?
  currentAddress   Json?
  permanentAddress Json?
  isSameAsCurrent  Boolean @default(false)

  staffType        StaffType?
  employmentType   StaffEmploymentType?
  employmentStatus StaffEmploymentStatus?

  joiningDate       DateTime?
  confirmationDate  DateTime?
  probationEndDate  DateTime?
  contractStartDate DateTime?
  contractEndDate   DateTime?

  defaultShiftType    StaffShiftType?
  isFullTime          Boolean?
  workingHoursPerWeek Int?
  weeklyOffDays       Json?

  hasSystemAccess Boolean @default(false)

  isAvailableForAppointment Boolean @default(false)
  isAvailableForDuty        Boolean @default(true)
  canPrescribe              Boolean @default(false)
  canAdmitPatients          Boolean @default(false)
  canPerformSurgery         Boolean @default(false)

  hprVerificationStatus  StaffVerificationStatus?
  hprLastVerifiedAt      DateTime?
  hprVerificationPayload Json?

  category       StaffCategory       @default(NON_CLINICAL)
  engagementType StaffEngagementType @default(EMPLOYEE)
  status         StaffStatus         @default(ACTIVE)

  phone String? @db.VarChar(20)
  email String? @db.VarChar(120)

  // Organization (hospital group) + primary branch (multi-branch sharing)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  primaryBranchId String?
  primaryBranch   Branch? @relation("StaffPrimaryBranch", fields: [primaryBranchId], references: [id], onDelete: SetNull)

  // Legacy anchor (kept for back-compat; prefer primaryBranchId)
  homeBranchId String?
  homeBranch   Branch? @relation("StaffHomeBranch", fields: [homeBranchId], references: [id], onDelete: SetNull)

  // Reporting line (optional)
  reportingToStaffId String?
  reportingTo        Staff?  @relation("StaffReportingLine", fields: [reportingToStaffId], references: [id], onDelete: SetNull)
  directReports      Staff[] @relation("StaffReportingLine")

  // ABDM/HPR identifier (optional; can also be stored as identifier)
  hprId String? @unique @db.VarChar(64)

  isActive         Boolean   @default(true)
  // Suspension tracking (BRD FR6.2)
  suspendedAt      DateTime?
  suspendedUntil   DateTime?
  suspensionReason String?   @db.VarChar(240)

  // Optional profile notes
  notes             String?
  personalDetails   Json?
  contactDetails    Json?
  employmentDetails Json?
  medicalDetails    Json?
  systemAccess      Json?

  // Onboarding workflow (ops readiness)
  onboardingStatus            StaffOnboardingStatus @default(DRAFT)
  onboardingStartedAt         DateTime?
  onboardingCompletedAt       DateTime?
  onboardingCompletedByUserId String?
  onboardingCompletedByUser   User?                 @relation("StaffOnboardingCompletedBy", fields: [onboardingCompletedByUserId], references: [id], onDelete: SetNull)

  // Convenience pointers (documents still live in StaffDocument vault)
  profilePhotoDocumentId String?        @unique
  profilePhotoDocument   StaffDocument? @relation("StaffProfilePhoto", fields: [profilePhotoDocumentId], references: [id], onDelete: SetNull)

  signatureDocumentId String?        @unique
  signatureDocument   StaffDocument? @relation("StaffSignatureDoc", fields: [signatureDocumentId], references: [id], onDelete: SetNull)

  stampDocumentId String?        @unique
  stampDocument   StaffDocument? @relation("StaffStampDoc", fields: [stampDocumentId], references: [id], onDelete: SetNull)

  // PCPNDT / compliance marker (BRD FR5.3)
  isUsgAuthorized       Boolean   @default(false)
  usgAuthorizedAt       DateTime?
  usgAuthorizedByUserId String?
  usgAuthorizedByUser   User?     @relation("StaffUsgAuthorizedBy", fields: [usgAuthorizedByUserId], references: [id], onDelete: SetNull)
  usgAuthorizationNotes String?   @db.VarChar(240)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Assignments (multi-branch postings)
  assignments StaffAssignment[]

  // Credentialing & identifiers
  credentials StaffCredential[]
  identifiers StaffIdentifier[]

  // Documents + onboarding + privileging + provider profile (enterprise-grade staff backbone)
  documents             StaffDocument[]             @relation("StaffDocuments")
  onboardingItems       StaffOnboardingItem[]
  privilegeGrants       StaffPrivilegeGrant[]       @relation("StaffPrivilegeGrants")
  providerProfiles      StaffProviderProfile[]      @relation("StaffProviderProfiles")
  complianceAssignments StaffComplianceAssignment[]

  // HR Ops / Workforce Management
  rosters       StaffRoster[]
  attendances   StaffAttendance[]
  leaveRequests StaffLeaveRequest[]
  trainings     StaffTrainingRecord[]
  separations   StaffSeparation[]
  healthRecords StaffHealthRecord[]

  // User linkage (preferred 1:1)
  user User? @relation("StaffUserLink")

  // Existing relations kept for compatibility
  doctorAssignments        DepartmentDoctor[]
  headedDepartments        Department[]               @relation("DepartmentHead")
  EquipmentMaintenanceTask EquipmentMaintenanceTask[]

  // Merge audit
  mergeSourceLogs StaffMergeLog[] @relation("StaffMergeSource")
  mergeTargetLogs StaffMergeLog[] @relation("StaffMergeTarget")

  // Pharmacy Infrastructure
  pharmacyStoresInCharge PharmacyStore[] @relation("PharmacistInCharge")

  // Insurance relations
  treatingCases InsuranceCase[] @relation("InsuranceCase_TreatingDoctor")

  // Compliance Infrastructure relations
  hprLinks                     HprProfessionalLink[] @relation("HprStaffLink")
  hprVerifications             HprProfessionalLink[] @relation("HprVerifiedBy")
  nabhOwnedItems               NabhWorkspaceItem[]   @relation("NabhOwner")
  nabhVerifiedItems            NabhWorkspaceItem[]   @relation("NabhVerifiedBy")
  evidenceUploads              EvidenceArtifact[]    @relation("EvidenceUploader")
  capaOwned                    CapaAction[]          @relation("CapaOwner")
  complianceApprovalsRequested ComplianceApproval[]  @relation("ComplianceApprovalRequestedBy")
  complianceApprovalsDecided   ComplianceApproval[]  @relation("ComplianceApprovalDecidedBy")
  complianceAuditLogs          ComplianceAuditLog[]  @relation("ComplianceAuditActor")

  @@index([name])
  @@index([displayName])
  @@index([phone])
  @@index([primaryPhone])
  @@index([email])
  @@index([personalEmail])
  @@index([status, isActive])
  @@index([primaryBranchId])
  @@index([category])
  @@index([engagementType])
  @@index([isUsgAuthorized])
  @@index([suspendedUntil])
  @@index([onboardingStatus])
  @@index([onboardingCompletedAt])
}

model StaffAssignment {
  id String @id @default(cuid())

  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  facilityId String?
  facility   FacilityCatalog? @relation(fields: [facilityId], references: [id], onDelete: SetNull)

  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  specialtyId String?
  specialty   Specialty? @relation(fields: [specialtyId], references: [id], onDelete: SetNull)

  unitId String?
  unit   Unit?   @relation(fields: [unitId], references: [id], onDelete: SetNull)

  // Branch-local employee code (if different across branches)
  branchEmpCode String? @db.VarChar(32)

  // Assignment-specific designation (may differ across branches)
  designation String? @db.VarChar(120)

  // Assignment-local role label (may differ per branch)
  role String? @db.VarChar(100)

  assignmentType StaffAssignmentType   @default(PERMANENT)
  status         StaffAssignmentStatus @default(ACTIVE)

  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?

  isPrimary Boolean @default(false)

  // Multi-branch availability & OPD configuration
  daysAvailable              Json? // Array<DayOfWeek>
  workingHours               Json? // { [day]: { startTime,endTime,breakStart?,breakEnd? } }
  opdConfiguration           Json? // { slotDuration,maxSlotsPerDay,consultationRooms: string[] }
  consultationChargeOverride Decimal? @db.Decimal(10, 2)

  // Administrative / approval workflow
  isActive         Boolean        @default(true)
  requiresApproval Boolean        @default(false)
  approvalStatus   ApprovalStatus @default(APPROVED)

  assignedByUserId String?
  assignedByUser   User?     @relation("StaffAssignmentAssignedBy", fields: [assignedByUserId], references: [id], onDelete: SetNull)
  assignedAt       DateTime?

  approvedByUserId String?
  approvedByUser   User?     @relation("StaffAssignmentApprovedBy", fields: [approvedByUserId], references: [id], onDelete: SetNull)
  approvedAt       DateTime?
  approvalNotes    String?   @db.VarChar(240)

  // Branch-level clinical privileges
  canAdmitPatients  Boolean @default(false)
  canPerformSurgery Boolean @default(false)
  hasOTPrivileges   Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Optional tie-back for access bindings
  userRoleBindings     UserRoleBinding[]
  staffDocuments       StaffDocument[]
  staffPrivilegeGrants StaffPrivilegeGrant[]

  @@unique([staffId, branchId])
  @@index([staffId, status])
  @@index([branchId, status])
  @@index([departmentId, status])
  @@index([specialtyId, status])
  @@index([effectiveTo])
  @@index([isPrimary])
  @@index([requiresApproval, approvalStatus])
  @@index([approvalStatus])
}

model UserRoleBinding {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  roleVersionId String
  roleVersion   RoleTemplateVersion @relation(fields: [roleVersionId], references: [id], onDelete: Cascade)

  staffAssignmentId String?
  staffAssignment   StaffAssignment? @relation(fields: [staffAssignmentId], references: [id], onDelete: SetNull)

  isPrimary Boolean @default(false)
  isActive  Boolean @default(true)

  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, branchId, roleVersionId, staffAssignmentId])
  @@index([userId, isActive])
  @@index([branchId, isActive])
  @@index([roleVersionId, isActive])
  @@index([effectiveTo])
}

model StaffCredential {
  id String @id @default(cuid())

  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)

  type      StaffCredentialType @default(OTHER)
  authority String?             @db.VarChar(120)

  registrationNumber String? @db.VarChar(64)

  validFrom DateTime?
  validTo   DateTime?

  // Computed lifecycle (kept explicit for filtering + alerts)
  status               StaffCredentialStatus @default(VALID)
  isCritical           Boolean               @default(false)
  renewalRequired      Boolean               @default(false)
  renewalWindowDays    Int?
  lastStatusComputedAt DateTime?

  verificationStatus StaffCredentialVerificationStatus @default(UNVERIFIED)
  verifiedAt         DateTime?
  verifiedByUserId   String?
  verifiedByUser     User?                             @relation(fields: [verifiedByUserId], references: [id], onDelete: SetNull)

  // Legacy single URL (keep for back-compat). Prefer StaffCredentialEvidence -> StaffDocument
  documentUrl String?

  evidences StaffCredentialEvidence[]
  alerts    StaffCredentialAlert[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([staffId, type])
  @@index([validTo])
  @@index([verificationStatus])
}

model StaffIdentifier {
  id String @id @default(cuid())

  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)

  type StaffIdentifierType @default(OTHER)

  // DPDP-safe storage: store hash + last4 only
  valueHash  String  @db.VarChar(128)
  valueLast4 String? @db.VarChar(8)

  issuedBy String?   @db.VarChar(120)
  issuedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([type, valueHash])
  @@index([staffId, type])
}

model StaffDocument {
  id String @id @default(cuid())

  staffId String
  staff   Staff  @relation("StaffDocuments", fields: [staffId], references: [id], onDelete: Cascade)

  // Optional: branch/assignment scoping (some docs are enterprise-wide, some are branch-local)
  branchId String?
  branch   Branch? @relation(fields: [branchId], references: [id], onDelete: SetNull)

  staffAssignmentId String?
  staffAssignment   StaffAssignment? @relation(fields: [staffAssignmentId], references: [id], onDelete: SetNull)

  type        StaffDocumentType @default(OTHER)
  title       String?           @db.VarChar(160)
  description String?

  refNo     String?   @db.VarChar(80)
  issuedBy  String?   @db.VarChar(120)
  issuedAt  DateTime?
  validFrom DateTime?
  validTo   DateTime?

  // Storage pointer (S3/minio/local file service)
  fileUrl       String  @db.VarChar(512)
  fileMime      String? @db.VarChar(120)
  fileSizeBytes Int?
  checksum      String? @db.VarChar(128)

  tags     Json?
  isActive Boolean @default(true)

  uploadedByUserId String?
  uploadedByUser   User?   @relation("StaffDocumentUploadedBy", fields: [uploadedByUserId], references: [id], onDelete: SetNull)

  verificationStatus StaffDocumentVerificationStatus @default(UNVERIFIED)
  verifiedAt         DateTime?
  verifiedByUserId   String?
  verifiedByUser     User?                           @relation("StaffDocumentVerifiedBy", fields: [verifiedByUserId], references: [id], onDelete: SetNull)
  verificationNotes  String?                         @db.VarChar(240)

  // Back-relations for convenience pointers on Staff
  profilePhotoFor Staff? @relation("StaffProfilePhoto")
  signatureFor    Staff? @relation("StaffSignatureDoc")
  stampFor        Staff? @relation("StaffStampDoc")

  // Evidence links
  credentialEvidences StaffCredentialEvidence[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([staffId, type])
  @@index([branchId, type])
  @@index([staffAssignmentId])
  @@index([validTo])
  @@index([verificationStatus])
  @@index([isActive])
}

model StaffCredentialEvidence {
  id String @id @default(cuid())

  staffCredentialId String
  staffCredential   StaffCredential @relation(fields: [staffCredentialId], references: [id], onDelete: Cascade)

  staffDocumentId String
  staffDocument   StaffDocument @relation(fields: [staffDocumentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([staffCredentialId, staffDocumentId])
  @@index([staffCredentialId])
  @@index([staffDocumentId])
}

model StaffCredentialAlert {
  id String @id @default(cuid())

  staffCredentialId String
  staffCredential   StaffCredential @relation(fields: [staffCredentialId], references: [id], onDelete: Cascade)

  stage       StaffCredentialAlertStage
  scheduledAt DateTime
  status      StaffAlertDeliveryStatus  @default(PENDING)
  sentAt      DateTime?

  // Optional outbox integration
  outboxEventId String?
  outboxEvent   OutboxEvent? @relation(fields: [outboxEventId], references: [id], onDelete: SetNull)

  error String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([staffCredentialId, stage])
  @@index([status, scheduledAt])
}

model ApprovalRequest {
  id String @id @default(cuid())

  entityType ApprovalEntityType
  entityId   String

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  status      ApprovalRequestStatus @default(PENDING)
  currentStep Int                   @default(1)

  createdByUserId String?
  createdByUser   User?   @relation("ApprovalRequestCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  steps ApprovalStep[]

  meta              Json?
  // Opposite relation for leave approvals (optional 1:1)
  staffLeaveRequest StaffLeaveRequest? @relation("LeaveRequestApproval")
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  @@unique([entityType, entityId])
  @@index([branchId, status])
  @@index([createdByUserId])
}

model ApprovalStep {
  id String @id @default(cuid())

  approvalRequestId String
  approvalRequest   ApprovalRequest @relation(fields: [approvalRequestId], references: [id], onDelete: Cascade)

  stepOrder Int

  approverKind     ApprovalApproverKind
  approverRoleCode String?              @db.VarChar(64) // for BRANCH_ROLE/GLOBAL_ROLE
  approverUserId   String? // for SPECIFIC_USER
  approverUser     User?                @relation("ApprovalStepApproverUser", fields: [approverUserId], references: [id], onDelete: SetNull)

  status ApprovalStepStatus @default(PENDING)

  actedAt       DateTime?
  actedByUserId String?
  actedByUser   User?     @relation("ApprovalStepActedByUser", fields: [actedByUserId], references: [id], onDelete: SetNull)

  remarks String? @db.VarChar(240)
  meta    Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([approvalRequestId, stepOrder])
  @@index([approvalRequestId, status])
}

model StaffRoster {
  id String @id @default(cuid())

  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  periodStart DateTime
  periodEnd   DateTime

  status StaffRosterStatus @default(DRAFT)
  meta   Json?

  entries StaffRosterEntry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([branchId, periodStart])
  @@index([staffId, periodStart])
}

model StaffRosterEntry {
  id String @id @default(cuid())

  rosterId String
  roster   StaffRoster @relation(fields: [rosterId], references: [id], onDelete: Cascade)

  startAt   DateTime
  endAt     DateTime
  shiftType StaffShiftType?
  meta      Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([startAt])
  @@index([rosterId, startAt])
}

model StaffAttendance {
  id String @id @default(cuid())

  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  date   DateTime              @db.Date
  status StaffAttendanceStatus @default(PRESENT)

  checkInAt  DateTime?
  checkOutAt DateTime?
  source     Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([staffId, branchId, date])
  @@index([branchId, date])
  @@index([staffId, date])
}

model StaffLeaveRequest {
  id String @id @default(cuid())

  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  leaveType String   @db.VarChar(80)
  startDate DateTime @db.Date
  endDate   DateTime @db.Date
  reason    String?  @db.VarChar(240)

  status StaffLeaveStatus @default(DRAFT)

  reportingManagerApproval         ApprovalStatus @default(PENDING)
  reportingManagerApprovedByUserId String?
  reportingManagerApprovedByUser   User?          @relation("StaffLeaveRMApprovedBy", fields: [reportingManagerApprovedByUserId], references: [id], onDelete: SetNull)
  reportingManagerApprovedAt       DateTime?

  hrApproval         ApprovalStatus @default(PENDING)
  hrApprovedByUserId String?
  hrApprovedByUser   User?          @relation("StaffLeaveHRApprovedBy", fields: [hrApprovedByUserId], references: [id], onDelete: SetNull)
  hrApprovedAt       DateTime?

  meta              Json?
  approvalRequestId String?          @unique
  approvalRequest   ApprovalRequest? @relation("LeaveRequestApproval", fields: [approvalRequestId], references: [id], onDelete: SetNull)

  submittedAt DateTime?
  decidedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([branchId, startDate])
  @@index([staffId, status])
}

model StaffTrainingRecord {
  id String @id @default(cuid())

  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)

  branchId String?
  branch   Branch? @relation(fields: [branchId], references: [id], onDelete: SetNull)

  programName String  @db.VarChar(160)
  provider    String? @db.VarChar(160)

  status      StaffTrainingStatus @default(ENROLLED)
  completedAt DateTime?
  score       Decimal?            @db.Decimal(5, 2)

  evidenceDocumentId String? // Link to StaffDocument.id (kept as scalar to avoid strong coupling)
  meta               Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([staffId, status])
  @@index([branchId, status])
}

model StaffSeparation {
  id String @id @default(cuid())

  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)

  branchId String?
  branch   Branch? @relation(fields: [branchId], references: [id], onDelete: SetNull)

  separationDate DateTime @db.Date
  reason         String?  @db.VarChar(240)
  meta           Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([staffId, separationDate])
  @@index([branchId, separationDate])
}

model StaffHealthRecord {
  id String @id @default(cuid())

  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)

  recordedAt DateTime @default(now())
  meta       Json?

  @@index([staffId, recordedAt])
}

model StaffProviderProfile {
  id String @id @default(cuid())

  staffId String
  staff   Staff  @relation("StaffProviderProfiles", fields: [staffId], references: [id], onDelete: Cascade)

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  isActive Boolean @default(true)

  // Branch/provider code used in scheduling/billing integrations
  providerCode String? @db.VarChar(32)
  displayName  String? @db.VarChar(160)

  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  specialtyId String?
  specialty   Specialty? @relation(fields: [specialtyId], references: [id], onDelete: SetNull)

  // Hooks for future modules (keep flexible)
  consultationModes Json?
  schedulingProfile Json?
  billingProfile    Json?
  clinicalProfile   Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([staffId, branchId])
  @@index([branchId, isActive])
  @@index([departmentId])
  @@index([specialtyId])
}

model StaffPrivilegeGrant {
  id String @id @default(cuid())

  staffId String
  staff   Staff  @relation("StaffPrivilegeGrants", fields: [staffId], references: [id], onDelete: Cascade)

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  staffAssignmentId String?
  staffAssignment   StaffAssignment? @relation(fields: [staffAssignmentId], references: [id], onDelete: SetNull)

  area   StaffPrivilegeArea
  action StaffPrivilegeAction

  // Optional: scope to a specific target (procedure/service/test/order set)
  targetType StaffPrivilegeTargetType @default(NONE)
  targetId   String?                  @db.VarChar(80)
  targetMeta Json?

  status StaffPrivilegeStatus @default(ACTIVE)

  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?

  grantedByUserId String?
  grantedByUser   User?   @relation("StaffPrivilegeGrantedBy", fields: [grantedByUserId], references: [id], onDelete: SetNull)

  notes String? @db.VarChar(240)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([staffId, branchId, area, action])
  @@index([branchId, status])
  @@index([effectiveTo])
  @@index([targetType, targetId])
  @@index([staffAssignmentId])
}

model StaffOnboardingItem {
  id String @id @default(cuid())

  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)

  branchId String?
  branch   Branch? @relation(fields: [branchId], references: [id], onDelete: SetNull)

  type        StaffOnboardingItemType
  title       String                  @db.VarChar(160)
  description String?

  status     StaffOnboardingItemStatus @default(PENDING)
  isRequired Boolean                   @default(true)

  dueAt DateTime?

  completedAt       DateTime?
  completedByUserId String?
  completedByUser   User?     @relation("StaffOnboardingItemCompletedBy", fields: [completedByUserId], references: [id], onDelete: SetNull)

  meta Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([staffId, status])
  @@index([branchId, status])
  @@index([type, status])
  @@index([dueAt])
}

model StaffCompliancePack {
  id String @id @default(cuid())

  name        String  @db.VarChar(160)
  description String?

  // Applicability (optional)
  category       StaffCategory?
  roleTemplateId String?
  roleTemplate   RoleTemplate?  @relation(fields: [roleTemplateId], references: [id], onDelete: SetNull)

  branchId String?
  branch   Branch? @relation(fields: [branchId], references: [id], onDelete: SetNull)

  isActive Boolean @default(true)

  requirements StaffComplianceRequirement[]
  assignments  StaffComplianceAssignment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([roleTemplateId])
  @@index([branchId])
  @@index([isActive])
}

model StaffComplianceRequirement {
  id String @id @default(cuid())

  packId String
  pack   StaffCompliancePack @relation(fields: [packId], references: [id], onDelete: Cascade)

  kind        StaffComplianceRequirementKind
  title       String                         @db.VarChar(160)
  isMandatory Boolean                        @default(true)

  // One of these based on kind
  documentType   StaffDocumentType?
  credentialType StaffCredentialType?
  identifierType StaffIdentifierType?

  // Optional renewal expectations
  renewalRequired   Boolean @default(false)
  renewalWindowDays Int?

  meta Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([packId, kind])
  @@index([documentType])
  @@index([credentialType])
  @@index([identifierType])
}

model StaffComplianceAssignment {
  id String @id @default(cuid())

  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)

  packId String
  pack   StaffCompliancePack @relation(fields: [packId], references: [id], onDelete: Cascade)

  // Optional branch scoping for packs applied only in certain branches
  branchId String?
  branch   Branch? @relation(fields: [branchId], references: [id], onDelete: SetNull)

  status StaffComplianceAssignmentStatus @default(ACTIVE)

  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?

  assignedByUserId String?
  assignedByUser   User?   @relation("StaffComplianceAssignedBy", fields: [assignedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([staffId, packId, branchId])
  @@index([staffId, status])
  @@index([packId, status])
  @@index([branchId, status])
  @@index([effectiveTo])
}

model StaffMergeLog {
  id String @id @default(cuid())

  sourceStaffId String
  sourceStaff   Staff  @relation("StaffMergeSource", fields: [sourceStaffId], references: [id], onDelete: Restrict)

  targetStaffId String
  targetStaff   Staff  @relation("StaffMergeTarget", fields: [targetStaffId], references: [id], onDelete: Restrict)

  reason String? @db.VarChar(240)
  notes  String?

  mergedByUserId String?
  mergedByUser   User?   @relation(fields: [mergedByUserId], references: [id], onDelete: SetNull)

  mergedAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sourceStaffId])
  @@index([targetStaffId])
}

model User {
  id    String @id @default(cuid())
  email String @unique
  name  String

  // Keep a simple role string for UI/back-compat (your code references this)
  role String @default("BRANCH_ADMIN")

  phone    String?
  branchId String?
  branch   Branch? @relation(fields: [branchId], references: [id])

  staffId String? @unique
  staff   Staff?  @relation("StaffUserLink", fields: [staffId], references: [id])

  isActive Boolean @default(true)

  // Origin of the account (used to hide staff-managed users from IAM list by default)
  source UserSource @default(ADMIN)

  /// Authorization version. Increment whenever role/branch/status changes so
  /// cached principals (and sessions) can be invalidated deterministically.
  authzVersion Int @default(1)

  passwordHash       String?
  mustChangePassword Boolean @default(false)

  passwordResetToken                 String?                     @unique
  passwordResetExpires               DateTime?
  roleVersionId                      String?
  roleVersion                        RoleTemplateVersion?        @relation("UserRoleVersion", fields: [roleVersionId], references: [id])
  usgAuthorizedStaff                 Staff[]                     @relation("StaffUsgAuthorizedBy")
  completedStaffOnboardings          Staff[]                     @relation("StaffOnboardingCompletedBy")
  grantedStaffPrivilegeGrants        StaffPrivilegeGrant[]       @relation("StaffPrivilegeGrantedBy")
  completedStaffOnboardingItems      StaffOnboardingItem[]       @relation("StaffOnboardingItemCompletedBy")
  assignedStaffComplianceAssignments StaffComplianceAssignment[] @relation("StaffComplianceAssignedBy")
  assignedStaffAssignments           StaffAssignment[]           @relation("StaffAssignmentAssignedBy")
  approvedStaffAssignments           StaffAssignment[]           @relation("StaffAssignmentApprovedBy")
  rmApprovedLeaveRequests            StaffLeaveRequest[]         @relation("StaffLeaveRMApprovedBy")
  hrApprovedLeaveRequests            StaffLeaveRequest[]         @relation("StaffLeaveHRApprovedBy")

  // Multi-branch role bindings (Doctor@BranchA, Doctor@BranchB, ...)
  roleBindings UserRoleBinding[]

  createdRoleVersions RoleTemplateVersion[] @relation("RoleVersionCreatedBy")
  auditEventsAsActor  AuditEvent[]          @relation("AuditActor")

  // Opposite relation for department deactivation metadata
  deactivatedDepartments   Department[]   @relation("DepartmentDeactivatedBy")
  // ---- Deactivation actor back-relations (infra) ----
  deactivatedUnits         Unit[]         @relation("UnitDeactivatedBy")
  deactivatedUnitRooms     UnitRoom[]     @relation("UnitRoomDeactivatedBy")
  deactivatedUnitResources UnitResource[] @relation("UnitResourceDeactivatedBy")

  // Policy governance opposite relations
  policyVersionsCreatedBy   PolicyVersion[] @relation("PolicyVersionCreatedBy")
  policyVersionsSubmittedBy PolicyVersion[] @relation("PolicyVersionSubmittedBy")
  policyVersionsApprovedBy  PolicyVersion[] @relation("PolicyVersionApprovedBy")
  policyVersionsRejectedBy  PolicyVersion[] @relation("PolicyVersionRejectedBy")
  policyVersionsRetiredBy   PolicyVersion[] @relation("PolicyVersionRetiredBy")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Approvals (opposite relations)
  createdApprovalRequests ApprovalRequest[] @relation("ApprovalRequestCreatedBy")
  approvalStepsAsApprover ApprovalStep[]    @relation("ApprovalStepApproverUser")
  approvalStepsAsActor    ApprovalStep[]    @relation("ApprovalStepActedByUser")

  // ---------------- Infrastructure (Setup Studio) ----------------
  createdLocationRevisions        LocationNodeRevision[]    @relation("LocationRevisionCreatedBy")
  createdImportJobs               BulkImportJob[]           @relation("ImportJobCreatedBy")
  // ---------------- Service Catalog (Orderables) ----------------
  createdServiceItems             ServiceItem[]             @relation("ServiceItemCreatedBy")
  updatedServiceItems             ServiceItem[]             @relation("ServiceItemUpdatedBy")
  createdServiceItemVersions      ServiceItemVersion[]      @relation("ServiceItemVersionCreatedBy")
  createdServiceCatalogues        ServiceCatalogue[]        @relation("ServiceCatalogueCreatedBy")
  updatedServiceCatalogues        ServiceCatalogue[]        @relation("ServiceCatalogueUpdatedBy")
  createdServiceCatalogueVersions ServiceCatalogueVersion[] @relation("ServiceCatalogueVersionCreatedBy")
  submittedServiceItems           ServiceItem[]             @relation("ServiceItemSubmittedBy")
  approvedServiceItems            ServiceItem[]             @relation("ServiceItemApprovedBy")
  publishedServiceItems           ServiceItem[]             @relation("ServiceItemPublishedBy")

  submittedServiceCatalogues    ServiceCatalogue[]      @relation("ServiceCatalogueSubmittedBy")
  approvedServiceCatalogues     ServiceCatalogue[]      @relation("ServiceCatalogueApprovedBy")
  publishedServiceCatalogues    ServiceCatalogue[]      @relation("ServiceCataloguePublishedBy")
  assignedFixIts                FixItTask[]             @relation("FixItAssignedTo")
  createdBookings               ProcedureBooking[]      @relation("BookingCreatedBy")
  createdGoLiveReports          GoLiveReport[]          @relation("GoLiveCreatedBy")
  createdDiagnosticPackVersions DiagnosticPackVersion[] @relation("DiagnosticPackVersionCreatedBy")

  // ---------------- Service Packages (Bundles) ----------------
  createdServicePackages        ServicePackage[]        @relation("ServicePackageCreatedBy")
  updatedServicePackages        ServicePackage[]        @relation("ServicePackageUpdatedBy")
  submittedServicePackages      ServicePackage[]        @relation("ServicePackageSubmittedBy")
  approvedServicePackages       ServicePackage[]        @relation("ServicePackageApprovedBy")
  publishedServicePackages      ServicePackage[]        @relation("ServicePackagePublishedBy")
  createdServicePackageVersions ServicePackageVersion[] @relation("ServicePackageVersionCreatedBy")

  // ---------------- Order Sets (Clinical Presets) ----------------
  createdOrderSets        OrderSet[]        @relation("OrderSetCreatedBy")
  updatedOrderSets        OrderSet[]        @relation("OrderSetUpdatedBy")
  submittedOrderSets      OrderSet[]        @relation("OrderSetSubmittedBy")
  approvedOrderSets       OrderSet[]        @relation("OrderSetApprovedBy")
  publishedOrderSets      OrderSet[]        @relation("OrderSetPublishedBy")
  createdOrderSetVersions OrderSetVersion[] @relation("OrderSetVersionCreatedBy")

  // ---------------- Tariffs (Rates) ----------------
  createdTariffRates TariffRate[] @relation("TariffRateCreatedBy")

  // ---------------- Equipment Register (Infrastructure) ----------------
  createdEquipmentRevisions        EquipmentAssetRevision[]      @relation("EquipmentRevisionCreatedBy")
  createdEquipmentPlacements       EquipmentPlacement[]          @relation("EquipmentPlacementCreatedBy")
  movedEquipmentMovements          EquipmentMovement[]           @relation("EquipmentMovedBy")
  uploadedEquipmentDocuments       EquipmentDocument[]           @relation("EquipmentDocUploadedBy")
  createdEquipmentContracts        EquipmentContract[]           @relation("EquipmentContractCreatedBy")
  createdEquipmentMaintenanceTasks EquipmentMaintenanceTask[]    @relation("EquipmentMaintCreatedBy")
  verifiedEquipmentEvidences       EquipmentComplianceEvidence[] @relation("EquipmentEvidenceVerifiedBy")

  // ---------------- Governance (Maker–Checker) ----------------
  governedChangeRequestsCreated   GovernedChangeRequest[] @relation("GovernedChangeCreatedBy")
  governedChangeRequestsSubmitted GovernedChangeRequest[] @relation("GovernedChangeSubmittedBy")
  governedChangeRequestsApproved  GovernedChangeRequest[] @relation("GovernedChangeApprovedBy")
  governedChangeRequestsRejected  GovernedChangeRequest[] @relation("GovernedChangeRejectedBy")
  staffDocumentsUploaded          StaffDocument[]         @relation("StaffDocumentUploadedBy")
  staffDocumentsVerified          StaffDocument[]         @relation("StaffDocumentVerifiedBy")
  StaffCredential                 StaffCredential[]
  StaffMergeLog                   StaffMergeLog[]

  // ---------------- Pharmacy Infrastructure ----------------
  publishedFormularies Formulary[]          @relation("FormularyPublisher")
  narcoticsPerformed   NarcoticsRegister[]  @relation("NarcoticsPerformedBy")
  drugLicensesUploaded DrugLicenseHistory[] @relation("DrugLicenseUploader")

  // ---------------- Financial Config (Module 3.13) ----------------
  approvedPriceChanges   ServicePriceHistory[] @relation("PriceHistoryApprovedBy")
  createdPriceChanges    ServicePriceHistory[] @relation("PriceHistoryCreatedBy")
  approvedPayerContracts PayerContract[]       @relation("PayerContractApprovedBy")

  // ---------------- Insurance Claims Transaction Layer ----------------
  verifiedPolicies         PatientInsurancePolicy[] @relation("PolicyVerifiedBy")
  assignedInsuranceCases   InsuranceCase[]          @relation("InsuranceCase_AssignedTo")
  submittedPreauths        PreauthRequest[]         @relation("Preauth_SubmittedBy")
  preauthQueriesRaised     PreauthQuery[]           @relation("PreauthQuery_QueriedBy")
  preauthQueriesResponded  PreauthQuery[]           @relation("PreauthQuery_RespondedBy")
  submittedClaims          Claim[]                  @relation("Claim_SubmittedBy")
  createdClaimVersions     ClaimVersion[]           @relation("ClaimVersion_CreatedBy")
  uploadedInsuranceDocs    InsuranceDocument[]      @relation("InsDoc_UploadedBy")
  verifiedInsuranceDocs    InsuranceDocument[]      @relation("InsDoc_VerifiedBy")
  reconciledPaymentAdvices PaymentAdvice[]          @relation("PaymentAdvice_ReconciledBy")
  notificationsToUser      Notification[]           @relation("NotificationToUser")
  notificationsAckBy       Notification[]           @relation("NotificationAckBy")
  notificationsResolvedBy  Notification[]           @relation("NotificationResolvedBy")
  notificationReads        NotificationRead[]
  notificationPreference   NotificationPreference?
  bbTransfersCreatedBy     BloodUnitTransfer[]      @relation("BBTransferCreatedBy")
  bbTransfersDispatchedBy  BloodUnitTransfer[]      @relation("BBTransferDispatchedBy")
  bbTransfersReceivedBy    BloodUnitTransfer[]      @relation("BBTransferReceivedBy")
  bbLookbacksCreatedBy     BloodLookbackCase[]      @relation("BBLookbackCreatedBy")
  bbLookbacksClosedBy      BloodLookbackCase[]      @relation("BBLookbackClosedBy")
  bbReportRunsCreatedBy    BBReportRun[]            @relation("BBReportRunCreatedBy")
  bbReportRunsSubmittedBy  BBReportRun[]            @relation("BBReportRunSubmittedBy")
  bbReportRunsApprovedBy   BBReportRun[]            @relation("BBReportRunApprovedBy")
  bbReportRunsRejectedBy   BBReportRun[]            @relation("BBReportRunRejectedBy")
}

model Patient {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  uhid    String
  name    String
  gender  String?
  dob     DateTime?
  phone   String?
  email   String?
  address String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  encounters Encounter[]
  Admission  Admission[]

  // Opposite relations (required for Prisma validation)
  consentRecords ConsentRecord[]
  rtbfRequests   RtbfRequest[]
  statutoryCases StatutoryCase[]

  // Insurance relations
  insurancePolicies PatientInsurancePolicy[]
  insuranceCases    InsuranceCase[]

  // Blood Bank relations
  bbDonorLinks         Donor[]
  bbBloodRequests      BloodRequest[]
  bbTransfusionRecords TransfusionRecord[]
  bbMTPSessions        MTPSession[]

  @@unique([branchId, uhid])
}

model Encounter {
  id        String  @id @default(cuid())
  branchId  String
  branch    Branch  @relation(fields: [branchId], references: [id])
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  type      EncounterType
  startedAt DateTime      @default(now())
  endedAt   DateTime?
  status    String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  admissions     Admission[]
  insuranceCases InsuranceCase[]
}

model Ward {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  code      String
  name      String
  specialty String?
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  rooms Room[]

  @@unique([branchId, code])
}

model Room {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])
  wardId   String
  ward     Ward   @relation(fields: [wardId], references: [id])

  code     String
  name     String
  floor    String?
  type     String?
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  beds Bed[]

  @@unique([wardId, code])
  @@index([branchId, wardId, isActive])
}

model Bed {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])
  roomId   String
  room     Room   @relation(fields: [roomId], references: [id])

  code     String
  state    BedState @default(VACANT)
  isActive Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  admissions Admission[]

  @@unique([roomId, code])
  @@index([branchId, roomId, isActive])
}

model Admission {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  encounterId String?
  encounter   Encounter? @relation(fields: [encounterId], references: [id])

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  bedId String?
  bed   Bed?    @relation(fields: [bedId], references: [id])

  admittedAt   DateTime  @default(now())
  dischargedAt DateTime?
  status       String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  insuranceCases InsuranceCase[]
}

model Asset {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  code      String
  name      String
  category  String
  location  String?
  status    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([branchId, code])
}

model TaxCode {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  code String @db.VarChar(32)
  name String @db.VarChar(160)

  taxType TaxType @default(GST)

  // e.g. 18.0000 (supports precise percentages)
  ratePercent Decimal @db.Decimal(7, 4)

  // Optional breakdown (CGST/SGST/IGST), exemptions, notes, etc.
  components Json?

  // Optional default HSN/SAC mapped to this tax code
  hsnSac String? @db.VarChar(16)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  chargeMasterItems ChargeMasterItem[]
  serviceItems      ServiceItem[]
  tariffRates       TariffRate[]
  servicePackages   ServicePackage[]

  @@unique([branchId, code])
  @@index([branchId, taxType, isActive])
}

model Payer {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  code        String  @db.VarChar(48)
  name        String  @db.VarChar(160)
  shortName   String? @db.VarChar(100)
  displayName String? @db.VarChar(200)

  kind     PayerKind   @default(OTHER)
  status   PayerStatus @default(ACTIVE)
  isActive Boolean     @default(true)

  // Regulatory information
  irdaiRegistration String?   @db.VarChar(64)
  licenseNumber     String?   @db.VarChar(64)
  licenseValidTill  DateTime?
  panNumber         String?   @db.VarChar(10)
  gstinNumber       String?   @db.VarChar(15)
  cinNumber         String?   @db.VarChar(21)

  // Addresses (JSONB: {registered, billing, claims})
  addresses Json?
  // Contacts (JSONB: {primary, claims, emergency})
  contacts  Json?
  portalUrl String? @db.VarChar(500)

  // Financial terms
  creditDays           Int?
  creditLimit          Decimal? @db.Decimal(14, 2)
  gracePeriodDays      Int?
  interestRate         Decimal? @db.Decimal(5, 2)
  earlyPaymentDiscount Decimal? @db.Decimal(5, 2)

  // Settlement terms (JSONB)
  settlementTerms Json?

  // Operational config
  requiresPreauth       Boolean  @default(false)
  preauthThreshold      Decimal? @db.Decimal(12, 2)
  supportingDocs        String[] @default([])
  claimSubmissionMethod String[] @default([])

  // Network config
  networkType      String?  @db.VarChar(32)
  empanelmentLevel String?  @db.VarChar(32)
  roomRentLimit    Decimal? @db.Decimal(12, 2)
  icuRentLimit     Decimal? @db.Decimal(12, 2)

  // Integration
  apiEndpoint String? @db.VarChar(500)
  authMethod  String? @db.VarChar(32)
  webhookUrl  String? @db.VarChar(500)

  // Empanelment dates
  empanelmentStartDate DateTime?
  empanelmentEndDate   DateTime?
  autoRenewal          Boolean   @default(false)

  meta Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contracts   PayerContract[]
  tariffPlans TariffPlan[]

  // Insurance relations
  insurancePolicies  PatientInsurancePolicy[]
  insuranceCases     InsuranceCase[]
  integrationConfigs PayerIntegrationConfig[]
  documentTemplates  PayerDocumentTemplate[]  @relation("Payer_DocTemplates")

  @@unique([branchId, code])
  @@index([branchId, kind, isActive])
  @@index([branchId, status])
}

model PayerContract {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  payerId String
  payer   Payer  @relation(fields: [payerId], references: [id], onDelete: Cascade)

  code        String  @db.VarChar(48)
  name        String  @db.VarChar(160)
  description String?

  status   ContractStatus @default(ACTIVE)
  priority Int            @default(100)
  startAt  DateTime?
  endAt    DateTime?

  // Pricing strategy
  pricingStrategy       PricingStrategy?
  globalDiscountPercent Decimal?         @db.Decimal(5, 2)

  // Loading percents
  emergencyLoadingPercent  Decimal? @db.Decimal(5, 2)
  afterHoursLoadingPercent Decimal? @db.Decimal(5, 2)
  weekendLoadingPercent    Decimal? @db.Decimal(5, 2)
  statLoadingPercent       Decimal? @db.Decimal(5, 2)

  // Co-payment rules (JSONB)
  copaymentRules Json?

  // Exclusions
  excludedServiceIds String[] @default([])
  excludedCategories String[] @default([])

  // Approval
  approvalStatus   String?   @db.VarChar(32)
  approvedByUserId String?
  approvedByUser   User?     @relation("PayerContractApprovedBy", fields: [approvedByUserId], references: [id], onDelete: SetNull)
  approvedAt       DateTime?

  gracePeriodDays Int?
  autoRenewal     Boolean @default(false)

  terms Json?
  meta  Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tariffPlans   TariffPlan[]
  contractRates ContractServiceRate[]

  // Insurance relations
  insurancePolicies PatientInsurancePolicy[]
  insuranceCases    InsuranceCase[]

  @@unique([branchId, code])
  @@index([branchId, payerId, status])
}

model TariffPlan {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  // Option B+ (payer/contract linked price lists)
  kind       TariffPlanKind   @default(PRICE_LIST)
  planStatus TariffPlanStatus @default(DRAFT)

  code String @db.VarChar(48)
  name String @db.VarChar(160)

  description String?

  // Operational flags
  isActive  Boolean @default(true)
  isDefault Boolean @default(false)

  // Legacy fields kept for backward compatibility
  status    String @default("ACTIVE")
  payerType String @default("SELF")

  // Optional linkage: cash price list (no payer/contract) OR contract-based plan
  payerId String?
  payer   Payer?  @relation(fields: [payerId], references: [id], onDelete: SetNull)

  contractId String?
  contract   PayerContract? @relation(fields: [contractId], references: [id], onDelete: SetNull)

  currency       String  @default("INR") @db.VarChar(8)
  isTaxInclusive Boolean @default(false)

  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?

  // plan-level versioning
  version Int @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  rates TariffRate[]

  @@unique([branchId, code])
  @@index([branchId, kind, planStatus])
  @@index([branchId, isDefault])
  @@index([branchId, effectiveFrom])
  @@index([branchId, payerId])
  @@index([branchId, contractId])
}

model ServiceCatalogItem {
  id        String   @id @default(cuid())
  code      String   @unique
  name      String
  category  String
  unit      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TariffRate {
  id           String     @id @default(cuid())
  tariffPlanId String
  tariffPlan   TariffPlan @relation(fields: [tariffPlanId], references: [id], onDelete: Cascade)

  // ✅ Primary rate anchor (Option B)
  chargeMasterItemId String?
  chargeMasterItem   ChargeMasterItem? @relation(fields: [chargeMasterItemId], references: [id], onDelete: SetNull)

  // Legacy anchor (kept for old /billing/tariffs/rates)
  serviceCode String? @db.VarChar(48)

  // Amount & currency
  rateAmount Decimal @db.Decimal(12, 2)
  currency   String  @default("INR") @db.VarChar(8)

  // Optional per-rate overrides
  taxCodeId      String?
  taxCode        TaxCode? @relation(fields: [taxCodeId], references: [id], onDelete: SetNull)
  isTaxInclusive Boolean  @default(false)

  rules Json?
  notes String?

  // Lifecycle & history
  isActive      Boolean   @default(true)
  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?
  version       Int       @default(1)

  createdByUserId String?
  createdByUser   User?   @relation("TariffRateCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tariffPlanId, chargeMasterItemId, version])
  @@unique([tariffPlanId, serviceCode, version])
  @@index([tariffPlanId])
  @@index([tariffPlanId, chargeMasterItemId])
  @@index([tariffPlanId, serviceCode])
}

model ConsentRecord {
  id        String  @id @default(cuid())
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  scope   ConsentScope
  purpose String
  status  ConsentStatus @default(GRANTED)

  createdAt DateTime @default(now())

  @@index([patientId, createdAt])
}

model RtbfRequest {
  id        String  @id @default(cuid())
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  reason String
  status RtbfStatus @default(REQUESTED)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, createdAt])
  @@index([patientId, createdAt])
}

model StatutoryCase {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  program String
  disease String
  status  String @default("DRAFT")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([branchId, updatedAt])
  @@index([program, updatedAt])
  @@index([patientId, updatedAt])
}

model AuditEvent {
  id String @id @default(cuid())

  branchId String?
  branch   Branch? @relation(fields: [branchId], references: [id], onDelete: SetNull)

  actorUserId String?
  actorUser   User?   @relation("AuditActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  action   String
  entity   String
  entityId String?
  meta     Json?

  createdAt DateTime @default(now())

  @@index([branchId, createdAt])
  @@index([actorUserId, createdAt])
  @@index([action, createdAt])
  @@index([entity, entityId])
}

model OutboxEvent {
  id          String       @id @default(cuid())
  topic       String
  key         String?
  payload     Json
  status      OutboxStatus @default(PENDING)
  attempts    Int          @default(0)
  availableAt DateTime     @default(now())
  lockedAt    DateTime?
  sentAt      DateTime?
  error       String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Opposite relation(s)
  staffCredentialAlerts StaffCredentialAlert[]

  @@index([status, availableAt])
}

enum RoleScope {
  GLOBAL
  BRANCH
}

enum RoleVersionStatus {
  DRAFT
  ACTIVE
  RETIRED
}

model Permission {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  category    String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  roleGrants RoleTemplatePermission[]
}

model RoleTemplate {
  id          String    @id @default(cuid())
  code        String    @unique
  name        String
  scope       RoleScope @default(BRANCH)
  description String?
  isSystem    Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  versions             RoleTemplateVersion[]
  staffCompliancePacks StaffCompliancePack[]
}

model RoleTemplateVersion {
  id             String            @id @default(cuid())
  roleTemplateId String
  roleTemplate   RoleTemplate      @relation(fields: [roleTemplateId], references: [id])
  version        Int
  status         RoleVersionStatus @default(DRAFT)
  notes          String?

  createdByUserId String?
  createdByUser   User?   @relation("RoleVersionCreatedBy", fields: [createdByUserId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  permissions RoleTemplatePermission[]

  // NAME THIS RELATION TOO (users assigned to this role version)
  users           User[]            @relation("UserRoleVersion")
  UserRoleBinding UserRoleBinding[]

  @@unique([roleTemplateId, version])
}

model RoleTemplatePermission {
  id            String              @id @default(cuid())
  roleVersionId String
  roleVersion   RoleTemplateVersion @relation(fields: [roleVersionId], references: [id])
  permissionId  String
  permission    Permission          @relation(fields: [permissionId], references: [id])

  // allow/deny flag for future; keep allow-only for now
  allowed Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([roleVersionId, permissionId])
}

// ---------------------------------------------------------------------------
// Policy Governance (global baselines + branch overrides with maker-checker)
// ---------------------------------------------------------------------------

enum PolicyScope {
  GLOBAL
  BRANCH_OVERRIDE
}

enum PolicyVersionStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  RETIRED
}

model PolicyDefinition {
  id          String  @id @default(cuid())
  code        String  @unique
  name        String
  type        String
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Canonical versions for this definition
  versions PolicyVersion[] @relation("PolicyDefinitionVersions")
}

model PolicyVersion {
  id String @id @default(cuid())

  // FK to the policy definition catalog (governance.service.ts expects this)
  policyId String
  policy   PolicyDefinition @relation("PolicyDefinitionVersions", fields: [policyId], references: [id])
  scope    PolicyScope      @default(GLOBAL)
  branchId String?
  branch   Branch?          @relation("PolicyVersion_Branch", fields: [branchId], references: [id], onDelete: SetNull)

  version Int
  status  PolicyVersionStatus @default(DRAFT)

  effectiveAt DateTime @default(now())
  notes       String?
  payload     Json

  applyToAllBranches Boolean               @default(true)
  branches           PolicyVersionBranch[]

  createdByUserId String?
  createdByUser   User?   @relation("PolicyVersionCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  submittedAt       DateTime?
  submittedByUserId String?
  submittedByUser   User?     @relation("PolicyVersionSubmittedBy", fields: [submittedByUserId], references: [id], onDelete: SetNull)

  approvedAt       DateTime?
  approvedByUserId String?
  approvedByUser   User?     @relation("PolicyVersionApprovedBy", fields: [approvedByUserId], references: [id], onDelete: SetNull)
  approvalNote     String?

  rejectedAt       DateTime?
  rejectedByUserId String?
  rejectedByUser   User?     @relation("PolicyVersionRejectedBy", fields: [rejectedByUserId], references: [id], onDelete: SetNull)
  rejectionReason  String?

  retiredAt       DateTime?
  retiredByUserId String?
  retiredByUser   User?     @relation("PolicyVersionRetiredBy", fields: [retiredByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // NOTE: We intentionally model the relation via policyId.
  // Any legacy/experimental policyDefinitionId field was removed to keep the schema unambiguous.

  @@index([policyId, scope, status])
  @@index([branchId, status])
  @@index([policyId, scope, version])
  @@index([policyId, branchId, version])
}

model PolicyVersionBranch {
  id              String        @id @default(cuid())
  policyVersionId String
  policyVersion   PolicyVersion @relation(fields: [policyVersionId], references: [id], onDelete: Cascade)

  branchId String
  branch   Branch @relation("PolicyTarget_Branch", fields: [branchId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([policyVersionId, branchId])
  @@index([branchId])
}

// ---------------------------------------------------------------------------
// Infrastructure / Setup Studio (Admin Branch Onboarding)
// ---------------------------------------------------------------------------

enum LocationKind {
  CAMPUS
  BUILDING
  FLOOR
  ZONE
  AREA
}

model LocationNode {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  kind     LocationKind
  parentId String?
  parent   LocationNode?  @relation("LocationTree", fields: [parentId], references: [id])
  children LocationNode[] @relation("LocationTree")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Units mapped to this location node
  units                   Unit[]
  revisions               LocationNodeRevision[]
  // OT Setup mappings
  otSuites                OtSuite[]                @relation("OtSuite_LocationNode")
  otSpaces                OtSpace[]                @relation("OtSpace_LocationNode")
  // Diagnostics setup mappings
  diagnosticServicePoints DiagnosticServicePoint[]
  EquipmentPlacement      EquipmentPlacement[]
  departmentLocations     DepartmentLocation[]
  pharmacyStores          PharmacyStore[]

  @@index([branchId, kind])
  @@index([branchId, parentId])
}

model LocationNodeRevision {
  id     String       @id @default(cuid())
  nodeId String
  node   LocationNode @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  code     String
  name     String
  isActive Boolean @default(true)

  // 2.2.2 Location Attributes
  gpsLat      Float?
  gpsLng      Float?
  floorNumber Int?

  wheelchairAccess Boolean @default(false)
  stretcherAccess  Boolean @default(false)
  emergencyExit    Boolean @default(false)

  fireZone String?

  effectiveFrom DateTime
  effectiveTo   DateTime?

  createdByUserId String?
  createdByUser   User?   @relation("LocationRevisionCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([nodeId, effectiveFrom])
  @@index([code])
}

// ---------------- Unit Types Enablement ----------------
enum UnitRoomType {
  CONSULTATION
  PROCEDURE
  EXAMINATION
  PATIENT_ROOM
  ISOLATION
  NEGATIVE_PRESSURE
  POSITIVE_PRESSURE
  NURSING_STATION
  WAITING
  STORAGE
  UTILITY
  RECOVERY
}

enum IsolationType {
  CONTACT
  DROPLET
  AIRBORNE
  PROTECTIVE
}

enum MaintenanceStatus {
  OPERATIONAL
  UNDER_MAINTENANCE
  CLEANING_IN_PROGRESS
  BLOCKED
  OUT_OF_SERVICE
}

enum UnitCategory {
  OUTPATIENT
  INPATIENT
  CRITICAL_CARE
  PROCEDURE
  DIAGNOSTIC
  SUPPORT
}

enum PricingTier {
  ECONOMY
  STANDARD
  DELUXE
  SUITE
  VIP
}

model UnitTypeCatalog {
  id   String @id @default(cuid())
  code String @unique @db.VarChar(32)
  name String @db.VarChar(120)

  category UnitCategory @default(OUTPATIENT)

  usesRoomsDefault       Boolean @default(true)
  schedulableByDefault   Boolean @default(false)
  bedBasedDefault        Boolean @default(false)
  requiresPreAuthDefault Boolean @default(false)

  isActive  Boolean @default(true)
  sortOrder Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  branchLinks BranchUnitType[]
  units       Unit[]

  defaultOperatingHours Json?
  standardEquipment     Json?

  isSystemDefined Boolean @default(false)

  @@index([category])
  @@index([isActive, sortOrder])
}

model BranchUnitType {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  unitTypeId String
  unitType   UnitTypeCatalog @relation(fields: [unitTypeId], references: [id], onDelete: Cascade)

  isEnabled Boolean   @default(true)
  enabledAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([branchId, unitTypeId], name: "branchId_unitTypeId")
  @@index([branchId, isEnabled])
}

// ---------------- Units / Rooms / Resources ----------------

enum UnitResourceType {
  // Bed Resources
  GENERAL_BED
  ICU_BED
  NICU_INCUBATOR
  CRIB
  TROLLEY
  STRETCHER
  WHEELCHAIR_POSITION

  // Procedure Resources
  OT_TABLE
  DIALYSIS_STATION
  CHEMOTHERAPY_CHAIR
  PROCEDURE_CHAIR
  PROCEDURE_TABLE
  RECOVERY_BAY
  DENTAL_CHAIR
  EXAMINATION_TABLE

  // Diagnostic Resources
  XRAY_MACHINE_SLOT
  CT_SCANNER_SLOT
  MRI_SCANNER_SLOT
  USG_MACHINE_SLOT
  ECG_MACHINE_SLOT
  ECHO_MACHINE_SLOT
  SAMPLE_COLLECTION_COUNTER

  // Other / Slots
  CONSULTATION_SLOT
  EXAM_SLOT

  // Legacy (kept for backward compatibility)
  BED
  BAY
  CHAIR
  INCUBATOR
}

enum UnitResourceState {
  AVAILABLE
  RESERVED
  OCCUPIED
  CLEANING
  SANITIZATION
  MAINTENANCE
  BLOCKED
  INACTIVE
}

enum UnitResourceCategory {
  BED
  PROCEDURE
  DIAGNOSTIC
  CONSULTATION
  OTHER
}

model Unit {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  // Location binding: unit belongs to a specific location node under the same branch
  locationNodeId String?
  locationNode   LocationNode? @relation(fields: [locationNodeId], references: [id], onDelete: Restrict)

  departmentId String
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Restrict)

  unitTypeId String
  unitType   UnitTypeCatalog @relation(fields: [unitTypeId], references: [id], onDelete: Restrict)

  code              String    @db.VarChar(32)
  name              String    @db.VarChar(160)
  // Physical / capacity metadata (captured during onboarding; optional)
  totalRoomCount    Int       @default(0)
  totalBedCapacity  Int?
  commissioningDate DateTime?

  // Convenience fields (optional; can be derived from Location/Staff modules)
  floorNumber     Int?
  wingZone        String? @db.VarChar(120)
  inchargeStaffId String? @db.VarChar(64)
  nursingStation  String? @db.VarChar(160)

  usesRooms Boolean @default(true)
  isActive  Boolean @default(true)

  // Soft deactivation metadata (future-proof; aligns with BRD reason-required flows)
  deactivatedAt       DateTime?
  deactivationReason  String?   @db.VarChar(500)
  deactivatedByUserId String?
  deactivatedByUser   User?     @relation("UnitDeactivatedBy", fields: [deactivatedByUserId], references: [id], onDelete: SetNull)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  rooms                   UnitRoom[]
  resources               UnitResource[]
  bookings                ProcedureBooking[]
  // Diagnostics: service points optionally linked to this unit
  diagnosticServicePoints DiagnosticServicePoint[]
  EquipmentPlacement      EquipmentPlacement[]
  StaffAssignment         StaffAssignment[]

  @@unique([branchId, code], name: "branchId_unitCode")
  @@index([branchId, departmentId, isActive])
  @@index([branchId, locationNodeId, isActive])
}

model UnitRoom {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  unitId String
  unit   Unit   @relation(fields: [unitId], references: [id], onDelete: Cascade)

  code       String  @db.VarChar(64)
  roomNumber String? @db.VarChar(32) // UI will require; DB kept nullable for safe migration
  name       String  @db.VarChar(160)

  roomType UnitRoomType?

  // Physical Attributes
  areaSqFt            Int?
  hasAttachedBathroom Boolean @default(false)
  hasAC               Boolean @default(false)
  hasTV               Boolean @default(false)
  hasOxygen           Boolean @default(false)
  hasSuction          Boolean @default(false)
  hasVentilator       Boolean @default(false)
  hasMonitor          Boolean @default(false)
  hasCallButton       Boolean @default(false)

  // Capacity
  maxOccupancy     Int @default(1)
  currentOccupancy Int @default(0)

  // Pricing
  pricingTier      PricingTier?
  baseChargePerDay Decimal?     @db.Decimal(12, 2)

  // Isolation/Special
  isIsolation   Boolean        @default(false)
  isolationType IsolationType?

  // Status
  isActive          Boolean           @default(true)
  isAvailable       Boolean           @default(true)
  maintenanceStatus MaintenanceStatus @default(OPERATIONAL)
  lastCleanedAt     DateTime?

  // Soft deactivation metadata (future-proof)
  deactivatedAt       DateTime?
  deactivationReason  String?   @db.VarChar(500)
  deactivatedByUserId String?
  deactivatedByUser   User?     @relation("UnitRoomDeactivatedBy", fields: [deactivatedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  resources                   UnitResource[]
  diagnosticServicePointRooms DiagnosticServicePointRoom[]
  diagnosticCapabilityRooms   DiagnosticCapabilityRoom[]
  EquipmentPlacement          EquipmentPlacement[]

  @@unique([unitId, code], name: "unitId_roomCode")
  @@unique([unitId, roomNumber], name: "unitId_roomNumber")
  @@index([branchId, unitId, isActive])
  @@index([deactivatedByUserId])
}

model UnitResource {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  unitId String
  unit   Unit   @relation(fields: [unitId], references: [id], onDelete: Cascade)

  roomId String?
  room   UnitRoom? @relation(fields: [roomId], references: [id], onDelete: SetNull)

  resourceType UnitResourceType
  code         String           @db.VarChar(96)
  assetTag     String?          @db.VarChar(64)
  name         String           @db.VarChar(160)

  // Category (required by interface; nullable for legacy rows)
  resourceCategory UnitResourceCategory?

  // Specifications
  manufacturer String? @db.VarChar(120)
  model        String? @db.VarChar(120)
  serialNumber String? @db.VarChar(120)

  // Capabilities
  hasMonitor           Boolean @default(false)
  hasOxygenSupply      Boolean @default(false)
  hasSuction           Boolean @default(false)
  hasVentilatorSupport Boolean @default(false)
  isPowerRequired      Boolean @default(false)

  // State Management
  state             UnitResourceState @default(AVAILABLE)
  isActive          Boolean           @default(true)
  assignedPatientId String?           @db.VarChar(64)

  // Scheduling
  isSchedulable       Boolean @default(false)
  slotDurationMinutes Int?

  // Maintenance
  lastMaintenanceDate DateTime?
  nextMaintenanceDate DateTime?
  warrantyExpiryDate  DateTime?

  // Commissioning
  commissionedAt DateTime?

  reservedReason String? @db.VarChar(500)
  blockedReason  String? @db.VarChar(500)

  createdAt                       DateTime                         @default(now())
  updatedAt                       DateTime                         @updatedAt
  deactivatedAt                   DateTime?
  deactivationReason              String?                          @db.VarChar(500)
  deactivatedByUserId             String?
  deactivatedByUser               User?                            @relation("UnitResourceDeactivatedBy", fields: [deactivatedByUserId], references: [id], onDelete: SetNull)
  bookings                        ProcedureBooking[]
  // Diagnostics mappings
  diagnosticServicePointResources DiagnosticServicePointResource[]
  diagnosticCapabilityResources   DiagnosticCapabilityResource[]
  EquipmentPlacement              EquipmentPlacement[]

  @@unique([unitId, code], name: "unitId_resourceCode")
  @@unique([branchId, assetTag], name: "branchId_resourceAssetTag")
  @@index([branchId, unitId, isActive])
  @@index([branchId, resourceType, isSchedulable])
  @@index([branchId, assetTag])
  @@index([deactivatedByUserId])
}

model BranchInfraConfig {
  id       String @id @default(cuid())
  branchId String @unique
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  housekeepingGateEnabled Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ---------------- Equipment Register ----------------

enum EquipmentCategory {
  GENERAL
  RADIOLOGY
  ULTRASOUND
}

enum EquipmentOperationalStatus {
  OPERATIONAL
  DOWN
  MAINTENANCE
  RETIRED
}

model EquipmentAsset {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  code String @db.VarChar(64)
  name String @db.VarChar(160)

  category EquipmentCategory @default(GENERAL)

  make   String?
  model  String?
  serial String?

  ownerDepartmentId String?
  ownerDepartment   Department? @relation("EquipmentOwnerDepartment", fields: [ownerDepartmentId], references: [id], onDelete: SetNull)

  unitId         String?
  roomId         String?
  locationNodeId String?

  operationalStatus EquipmentOperationalStatus @default(OPERATIONAL)

  amcVendor       String?
  amcValidFrom    DateTime?
  amcValidTo      DateTime?
  warrantyValidTo DateTime?

  pmFrequencyDays Int?
  nextPmDueAt     DateTime?

  aerbLicenseNo String?
  aerbValidTo   DateTime?

  pcpndtRegNo   String?
  pcpndtValidTo DateTime?

  isSchedulable Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  downtimeTickets                 DowntimeTicket[]
  // Diagnostics mappings
  diagnosticServicePointEquipment DiagnosticServicePointEquipment[]
  diagnosticCapabilityEquipment   DiagnosticCapabilityEquipment[]

  // Equipment Register extensions
  placement  EquipmentPlacement?
  revisions  EquipmentAssetRevision[]
  movements  EquipmentMovement[]
  documents  EquipmentDocument[]
  contracts  EquipmentContract[]
  maintTasks EquipmentMaintenanceTask[]
  evidences  EquipmentComplianceEvidence[]

  @@unique([branchId, code], name: "branchId_equipmentCode")
  @@index([branchId, category])
}

enum DowntimeStatus {
  OPEN
  CLOSED
}

model DowntimeTicket {
  id      String         @id @default(cuid())
  assetId String
  asset   EquipmentAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  reason String
  notes  String?
  status DowntimeStatus @default(OPEN)

  openedAt DateTime  @default(now())
  closedAt DateTime?

  createdAt                DateTime                   @default(now())
  updatedAt                DateTime                   @updatedAt
  EquipmentMaintenanceTask EquipmentMaintenanceTask[]

  @@index([assetId, status])
}

// ---------------- Service Catalog + Charge Master + Mapping ----------------

model ChargeMasterItem {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  code String @db.VarChar(48)
  name String @db.VarChar(160)

  category String?
  unit     String?

  // ✅ Charge unit enforcement (end-to-end)
  chargeUnit ServiceChargeUnit @default(PER_UNIT)

  // ✅ Tax mapping (preferred over placeholder enums)
  taxCodeId      String?
  taxCode        TaxCode? @relation(fields: [taxCodeId], references: [id], onDelete: SetNull)
  isTaxInclusive Boolean  @default(false)
  hsnSac         String?  @db.VarChar(16)

  // Optional: rounding/deposit/refund/etc.
  billingPolicy Json?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  mappings                ServiceChargeMapping[]
  ServicePackageComponent ServicePackageComponent[]
  tariffRates             TariffRate[]
  billedPackages          ServicePackage[]          @relation("ServicePackage_BillingChargeMaster")
  priceHistory            ServicePriceHistory[]     @relation("PriceHistory_ChargeMaster")
  contractRates           ContractServiceRate[]     @relation("ContractRate_ChargeMaster")
  tierRates               PatientPricingTierRate[]  @relation("TierRate_ChargeMaster")
  claimLineItems          ClaimLineItem[]           @relation("ClaimLine_ChargeMaster")

  @@unique([branchId, code], name: "branchId_code")
  @@index([branchId, isActive])
  @@index([branchId, taxCodeId])
}

model ServiceItem {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  code String @db.VarChar(48)
  name String @db.VarChar(160)

  // Legacy categorization (keep)
  category String  @db.VarChar(80)
  unit     String?

  // Advanced typing
  type ServiceItemType @default(OTHER)

  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  externalId String? @db.VarChar(80)

  // Optional OT/procedure metadata
  procedureKind   String? @db.VarChar(80)
  anesthesiaClass String? @db.VarChar(80)

  // Orderability + lifecycle
  isOrderable     Boolean                @default(true)
  isActive        Boolean                @default(true)
  isBillable      Boolean                @default(true)
  lifecycleStatus ServiceLifecycleStatus @default(PUBLISHED)

  // Governance / workflow actors (maker-checker)
  createdByUserId   String?
  createdByUser     User?     @relation("ServiceItemCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  updatedByUserId   String?
  updatedByUser     User?     @relation("ServiceItemUpdatedBy", fields: [updatedByUserId], references: [id], onDelete: SetNull)
  submittedByUserId String?
  submittedByUser   User?     @relation("ServiceItemSubmittedBy", fields: [submittedByUserId], references: [id], onDelete: SetNull)
  submittedAt       DateTime?
  approvedByUserId  String?
  approvedByUser    User?     @relation("ServiceItemApprovedBy", fields: [approvedByUserId], references: [id], onDelete: SetNull)
  approvedAt        DateTime?
  publishedByUserId String?
  publishedByUser   User?     @relation("ServiceItemPublishedBy", fields: [publishedByUserId], references: [id], onDelete: SetNull)
  publishedAt       DateTime?

  // Clinical & ordering constraints (structured + text)
  consentRequired       Boolean @default(false)
  preparationText       String?
  instructionsText      String?
  contraindicationsText String?

  minAgeYears       Int?
  maxAgeYears       Int?
  genderRestriction String? @db.VarChar(16) // "MALE"|"FEMALE"|"OTHER" or your convention
  cooldownMins      Int? // duplicate-order rule window (simple)

  // Operational definition
  requiresAppointment   Boolean @default(false)
  estimatedDurationMins Int?
  prepMins              Int?
  recoveryMins          Int?
  tatMinsRoutine        Int?
  tatMinsStat           Int?

  // Billing definition
  chargeUnit       ServiceChargeUnit?
  taxApplicability TaxApplicability?
  taxCodeId        String?
  taxCode          TaxCode?           @relation(fields: [taxCodeId], references: [id], onDelete: SetNull)
  billingPolicy    Json? // rounding, deposit, refund, inclusive/exclusive flags, etc.

  // ── Service Catalog spec additions ──
  shortName          String?    @db.VarChar(100)
  displayName        String?    @db.VarChar(200)
  description        String?
  searchAliases      String[]   @default([])
  specialtyId        String?
  specialty          Specialty? @relation(fields: [specialtyId], references: [id], onDelete: SetNull)
  subCategory        String?    @db.VarChar(80)
  requiresScheduling Boolean    @default(false)
  statAvailable      Boolean    @default(false)
  defaultTatHours    Int?
  basePrice          Decimal?   @db.Decimal(12, 2)
  costPrice          Decimal?   @db.Decimal(12, 2)
  allowDiscount      Boolean    @default(true)
  maxDiscountPercent Decimal?   @db.Decimal(5, 2)
  effectiveFrom      DateTime   @default(now())
  effectiveTill      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  mappings ServiceChargeMapping[]
  fixIts   FixItTask[]

  // Optional: link to DiagnosticItem (unified orderables)
  diagnosticItem       DiagnosticItem?                  @relation("DiagnosticItem_ServiceItem")
  // Advanced child tables
  aliases              ServiceItemAlias[]
  contexts             ServiceItemContext[]
  resourceRequirements ServiceItemResourceRequirement[]
  clinicalRules        ServiceItemClinicalRule[]
  seriesPolicies       ServiceSeriesPolicy[]
  versions             ServiceItemVersion[]

  // Cataloguing
  catalogueItems              ServiceCatalogueItem[]
  ServicePackageComponent     ServicePackageComponent[]
  OrderSetItem                OrderSetItem[]
  ServiceItemStandardMapping  ServiceItemStandardMapping[]
  ServiceAvailabilityCalendar ServiceAvailabilityCalendar[]
  ExternalDirectoryMapping    ExternalDirectoryMapping[]

  // Financial config relations
  priceHistory   ServicePriceHistory[]    @relation("PriceHistory_ServiceItem")
  contractRates  ContractServiceRate[]    @relation("ContractRate_ServiceItem")
  tierRates      PatientPricingTierRate[] @relation("TierRate_ServiceItem")
  claimLineItems ClaimLineItem[]          @relation("ClaimLine_ServiceItem")

  @@unique([branchId, code], name: "branchId_serviceCode")
  @@unique([branchId, externalId], name: "branchId_serviceExternalId")
  @@index([branchId, category, isActive])
  @@index([branchId, type, isActive])
  @@index([branchId, lifecycleStatus, isActive])
  @@index([branchId, specialtyId, isActive])
}

model ServiceItemAlias {
  id            String      @id @default(cuid())
  serviceItemId String
  serviceItem   ServiceItem @relation(fields: [serviceItemId], references: [id], onDelete: Cascade)

  alias    String  @db.VarChar(160)
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([serviceItemId, alias])
  @@index([serviceItemId, isActive])
}

model ServiceItemContext {
  id            String      @id @default(cuid())
  serviceItemId String
  serviceItem   ServiceItem @relation(fields: [serviceItemId], references: [id], onDelete: Cascade)

  context   CareContext
  isEnabled Boolean     @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([serviceItemId, context])
  @@index([serviceItemId, isEnabled])
}

model ServiceItemResourceRequirement {
  id            String      @id @default(cuid())
  serviceItemId String
  serviceItem   ServiceItem @relation(fields: [serviceItemId], references: [id], onDelete: Cascade)

  resourceType UnitResourceType
  quantity     Int              @default(1)

  // optional constraints for readiness / go-live rules
  constraints Json?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([serviceItemId, resourceType, isActive])
}

model ServiceItemClinicalRule {
  id            String      @id @default(cuid())
  serviceItemId String
  serviceItem   ServiceItem @relation(fields: [serviceItemId], references: [id], onDelete: Cascade)

  // e.g. "REQUIRES_DIAGNOSIS", "PREGNANCY_WARNING", "DUPLICATE_ORDER_COOLDOWN"
  ruleType String  @db.VarChar(64)
  payload  Json?
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([serviceItemId, ruleType, isActive])
}

model ServiceSeriesPolicy {
  id            String      @id @default(cuid())
  serviceItemId String
  serviceItem   ServiceItem @relation(fields: [serviceItemId], references: [id], onDelete: Cascade)

  totalSessions     Int?
  maxSessionsPerDay Int?
  expiryDays        Int?
  scheduleTemplate  Json?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([serviceItemId, isActive])
}

model ServiceItemVersion {
  id            String      @id @default(cuid())
  serviceItemId String
  serviceItem   ServiceItem @relation(fields: [serviceItemId], references: [id], onDelete: Cascade)

  version Int
  status  ServiceLifecycleStatus

  snapshot Json

  createdByUserId String?
  createdByUser   User?   @relation("ServiceItemVersionCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([serviceItemId, version])
  @@index([serviceItemId, effectiveFrom])
}

model ServiceChargeMapping {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  serviceItemId String
  serviceItem   ServiceItem @relation(fields: [serviceItemId], references: [id], onDelete: Cascade)

  chargeMasterItemId String
  chargeMasterItem   ChargeMasterItem @relation(fields: [chargeMasterItemId], references: [id], onDelete: Cascade)

  effectiveFrom DateTime
  effectiveTo   DateTime?
  version       Int       @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([branchId, serviceItemId, effectiveFrom])
}

model ServiceCatalogue {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  code String @db.VarChar(48)
  name String @db.VarChar(160)

  description String?

  scope   CatalogueScope   @default(BRANCH)
  channel CatalogueChannel @default(DEFAULT)

  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  context    CareContext?
  payerGroup String?

  // ── Catalogue spec additions ──
  filterRules Json?
  visibility  String? @db.VarChar(32) // ALL | ROLE_BASED | USER_SPECIFIC

  status  CatalogueStatus @default(DRAFT)
  version Int             @default(1)

  // Governance / workflow actors (maker-checker)
  createdByUserId   String?
  createdByUser     User?     @relation("ServiceCatalogueCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  updatedByUserId   String?
  updatedByUser     User?     @relation("ServiceCatalogueUpdatedBy", fields: [updatedByUserId], references: [id], onDelete: SetNull)
  submittedByUserId String?
  submittedByUser   User?     @relation("ServiceCatalogueSubmittedBy", fields: [submittedByUserId], references: [id], onDelete: SetNull)
  submittedAt       DateTime?
  approvedByUserId  String?
  approvedByUser    User?     @relation("ServiceCatalogueApprovedBy", fields: [approvedByUserId], references: [id], onDelete: SetNull)
  approvedAt        DateTime?
  publishedByUserId String?
  publishedByUser   User?     @relation("ServiceCataloguePublishedBy", fields: [publishedByUserId], references: [id], onDelete: SetNull)
  publishedAt       DateTime?

  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items    ServiceCatalogueItem[]
  versions ServiceCatalogueVersion[]

  @@unique([branchId, code])
  @@index([branchId, channel, status])
  @@index([branchId, context, status])
  @@index([branchId, payerGroup, status])
}

model ServiceCatalogueItem {
  id          String           @id @default(cuid())
  catalogueId String
  catalogue   ServiceCatalogue @relation(fields: [catalogueId], references: [id], onDelete: Cascade)

  serviceItemId String
  serviceItem   ServiceItem @relation(fields: [serviceItemId], references: [id], onDelete: Restrict)

  sortOrder Int     @default(0)
  isVisible Boolean @default(true)

  // Overrides: price/TAT/resource mapping/availability flags etc (payer/branch can override)
  overrides Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([catalogueId, serviceItemId])
  @@index([catalogueId, sortOrder])
}

model ServiceCatalogueVersion {
  id          String           @id @default(cuid())
  catalogueId String
  catalogue   ServiceCatalogue @relation(fields: [catalogueId], references: [id], onDelete: Cascade)

  version Int
  status  CatalogueStatus

  snapshot Json

  createdByUserId String?
  createdByUser   User?   @relation("ServiceCatalogueVersionCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  effectiveFrom DateTime
  effectiveTo   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([catalogueId, version])
  @@index([catalogueId, effectiveFrom])
}

model ServicePackage {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  code String @db.VarChar(48)
  name String @db.VarChar(160)

  description String?

  status  PackageStatus @default(DRAFT)
  version Int           @default(1)

  // ✅ Package pricing rules
  pricingMode   PackagePricingMode @default(COMPONENT_SUM)
  pricingValue  Decimal?           @db.Decimal(12, 2)
  pricingPolicy Json?

  // If billed as a single line item
  billingChargeMasterItemId String?
  billingChargeMasterItem   ChargeMasterItem? @relation("ServicePackage_BillingChargeMaster", fields: [billingChargeMasterItemId], references: [id], onDelete: SetNull)

  // Charge unit for package billing
  chargeUnit ServiceChargeUnit @default(PER_PACKAGE)

  // Tax for package line (optional)
  taxCodeId      String?
  taxCode        TaxCode? @relation(fields: [taxCodeId], references: [id], onDelete: SetNull)
  isTaxInclusive Boolean  @default(false)

  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?

  // ── Package spec additions ──
  durationDays           Int?
  allowComponentAddition Boolean                 @default(false)
  allowComponentRemoval  Boolean                 @default(false)
  allowQuantityChange    Boolean                 @default(false)
  overUtilizationPolicy  OverUtilizationPolicy?
  underUtilizationRefund UnderUtilizationRefund?
  minAge                 Int?
  maxAge                 Int?
  genderRestriction      String?                 @db.VarChar(16)
  applicablePayerIds     String[]                @default([])
  requiresPreauth        Boolean                 @default(false)

  // Governance / workflow actors (maker-checker)
  createdByUserId   String?
  createdByUser     User?     @relation("ServicePackageCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  updatedByUserId   String?
  updatedByUser     User?     @relation("ServicePackageUpdatedBy", fields: [updatedByUserId], references: [id], onDelete: SetNull)
  submittedByUserId String?
  submittedByUser   User?     @relation("ServicePackageSubmittedBy", fields: [submittedByUserId], references: [id], onDelete: SetNull)
  submittedAt       DateTime?
  approvedByUserId  String?
  approvedByUser    User?     @relation("ServicePackageApprovedBy", fields: [approvedByUserId], references: [id], onDelete: SetNull)
  approvedAt        DateTime?
  publishedByUserId String?
  publishedByUser   User?     @relation("ServicePackagePublishedBy", fields: [publishedByUserId], references: [id], onDelete: SetNull)
  publishedAt       DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  components    ServicePackageComponent[]
  versions      ServicePackageVersion[]
  OrderSetItem  OrderSetItem[]
  contractRates ContractServiceRate[]     @relation("ContractRate_ServicePackage")

  @@unique([branchId, code])
  @@index([branchId, status])
  @@index([branchId, pricingMode])
}

model ServicePackageComponent {
  id        String         @id @default(cuid())
  packageId String
  pkg       ServicePackage @relation(fields: [packageId], references: [id], onDelete: Cascade)

  componentType PackageComponentType

  serviceItemId      String?
  diagnosticItemId   String?
  chargeMasterItemId String?

  serviceItem    ServiceItem?      @relation(fields: [serviceItemId], references: [id], onDelete: Restrict)
  diagnosticItem DiagnosticItem?   @relation(fields: [diagnosticItemId], references: [id], onDelete: Restrict)
  chargeMaster   ChargeMasterItem? @relation(fields: [chargeMasterItemId], references: [id], onDelete: Restrict)

  quantity   Int      @default(1)
  unitPrice  Decimal? @db.Decimal(12, 2)
  isIncluded Boolean  @default(true)

  // Conditional rules, auto-add, exclusions, etc.
  condition Json?

  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([packageId, sortOrder])
}

model ServicePackageVersion {
  id        String         @id @default(cuid())
  packageId String
  pkg       ServicePackage @relation(fields: [packageId], references: [id], onDelete: Cascade)

  version Int
  status  PackageStatus

  snapshot Json

  createdByUserId String?
  createdByUser   User?   @relation("ServicePackageVersionCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  effectiveFrom DateTime
  effectiveTo   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([packageId, version])
  @@index([packageId, effectiveFrom])
}

model OrderSet {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  code String @db.VarChar(48)
  name String @db.VarChar(160)

  description String?

  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  context CareContext?
  channel CatalogueChannel @default(ORDER_SET)

  status  OrderSetStatus @default(DRAFT)
  version Int            @default(1)

  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?

  // Governance / workflow actors (maker-checker)
  createdByUserId   String?
  createdByUser     User?     @relation("OrderSetCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  updatedByUserId   String?
  updatedByUser     User?     @relation("OrderSetUpdatedBy", fields: [updatedByUserId], references: [id], onDelete: SetNull)
  submittedByUserId String?
  submittedByUser   User?     @relation("OrderSetSubmittedBy", fields: [submittedByUserId], references: [id], onDelete: SetNull)
  submittedAt       DateTime?
  approvedByUserId  String?
  approvedByUser    User?     @relation("OrderSetApprovedBy", fields: [approvedByUserId], references: [id], onDelete: SetNull)
  approvedAt        DateTime?
  publishedByUserId String?
  publishedByUser   User?     @relation("OrderSetPublishedBy", fields: [publishedByUserId], references: [id], onDelete: SetNull)
  publishedAt       DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items    OrderSetItem[]
  versions OrderSetVersion[]

  @@unique([branchId, code])
  @@index([branchId, context, status])
  @@index([branchId, departmentId, status])
}

model OrderSetItem {
  id         String   @id @default(cuid())
  orderSetId String
  orderSet   OrderSet @relation(fields: [orderSetId], references: [id], onDelete: Cascade)

  itemType OrderSetItemType

  serviceItemId    String?
  diagnosticItemId String?
  packageId        String?

  serviceItem    ServiceItem?    @relation(fields: [serviceItemId], references: [id], onDelete: Restrict)
  diagnosticItem DiagnosticItem? @relation(fields: [diagnosticItemId], references: [id], onDelete: Restrict)
  pkg            ServicePackage? @relation(fields: [packageId], references: [id], onDelete: Restrict)

  quantity   Int     @default(1)
  isOptional Boolean @default(false)
  rules      Json?

  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderSetId, sortOrder])
}

model OrderSetVersion {
  id         String   @id @default(cuid())
  orderSetId String
  orderSet   OrderSet @relation(fields: [orderSetId], references: [id], onDelete: Cascade)

  version Int
  status  OrderSetStatus

  snapshot Json

  createdByUserId String?
  createdByUser   User?   @relation("OrderSetVersionCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  effectiveFrom DateTime
  effectiveTo   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([orderSetId, version])
  @@index([orderSetId, effectiveFrom])
}

model StandardCodeSet {
  id          String             @id @default(cuid())
  code        String             @db.VarChar(48)
  name        String             @db.VarChar(160)
  system      StandardCodeSystem @default(INTERNAL)
  description String?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  entries StandardCodeEntry[]

  @@unique([system, code])
  @@index([system, isActive])
}

model StandardCodeEntry {
  id        String          @id @default(cuid())
  codeSetId String
  codeSet   StandardCodeSet @relation(fields: [codeSetId], references: [id], onDelete: Cascade)

  code     String  @db.VarChar(64)
  display  String  @db.VarChar(200)
  category String?

  attributes Json?

  isActive Boolean @default(true)

  createdAt                  DateTime                     @default(now())
  updatedAt                  DateTime                     @updatedAt
  ServiceItemStandardMapping ServiceItemStandardMapping[]

  @@unique([codeSetId, code])
  @@index([codeSetId, isActive])
}

model ServiceItemStandardMapping {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  serviceItemId String
  serviceItem   ServiceItem @relation(fields: [serviceItemId], references: [id], onDelete: Cascade)

  entryId String
  entry   StandardCodeEntry @relation(fields: [entryId], references: [id], onDelete: Restrict)

  isPrimary Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([branchId, serviceItemId, entryId])
  @@index([branchId, isPrimary])
}

model ServiceAvailabilityCalendar {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  serviceItemId String
  serviceItem   ServiceItem @relation(fields: [serviceItemId], references: [id], onDelete: Cascade)

  name     String  @db.VarChar(160)
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  rules     ServiceAvailabilityRule[]
  blackouts ServiceBlackout[]

  @@index([branchId, isActive])
  @@index([serviceItemId, isActive])
}

model ServiceAvailabilityRule {
  id         String                      @id @default(cuid())
  calendarId String
  calendar   ServiceAvailabilityCalendar @relation(fields: [calendarId], references: [id], onDelete: Cascade)

  dayOfWeek   Int // 0=Sun..6=Sat
  startMinute Int // 0..1439
  endMinute   Int // 1..1440
  capacity    Int @default(0)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([calendarId, dayOfWeek, isActive])
}

model ServiceBlackout {
  id         String                      @id @default(cuid())
  calendarId String
  calendar   ServiceAvailabilityCalendar @relation(fields: [calendarId], references: [id], onDelete: Cascade)

  from DateTime
  to   DateTime

  reason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([calendarId, from])
}

model ExternalDirectorySource {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  systemType ExternalSystemType
  name       String             @db.VarChar(160)

  // optional metadata (endpoint names, directory names, credentials ref, etc.)
  meta Json?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  entries  ExternalDirectoryEntry[]
  mappings ExternalDirectoryMapping[]

  @@index([branchId, systemType, isActive])
}

model ExternalDirectoryEntry {
  id       String                  @id @default(cuid())
  sourceId String
  source   ExternalDirectorySource @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  externalCode String @db.VarChar(80)
  name         String @db.VarChar(200)

  // e.g. "SERVICE_ITEM", "DIAGNOSTIC_ITEM"
  kind String @db.VarChar(40)

  payload Json?

  isActive Boolean @default(true)

  createdAt                DateTime                   @default(now())
  updatedAt                DateTime                   @updatedAt
  ExternalDirectoryMapping ExternalDirectoryMapping[]

  @@unique([sourceId, externalCode])
  @@index([sourceId, kind, isActive])
}

model ExternalDirectoryMapping {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  sourceId String
  source   ExternalDirectorySource @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  entryId String
  entry   ExternalDirectoryEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)

  serviceItemId String?
  serviceItem   ServiceItem? @relation(fields: [serviceItemId], references: [id], onDelete: SetNull)

  status    String  @default("MAPPED")
  isPrimary Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([branchId, sourceId, entryId])
  @@index([branchId, isPrimary])
}

// =====================================================================
// SERVICE CATALOG & FINANCIAL CONFIG — NEW MODELS (Spec 3.7 / 3.13)
// =====================================================================

model ServicePriceHistory {
  id       String @id @default(cuid())
  branchId String

  serviceItemId      String?
  serviceItem        ServiceItem?      @relation("PriceHistory_ServiceItem", fields: [serviceItemId], references: [id], onDelete: Cascade)
  chargeMasterItemId String?
  chargeMasterItem   ChargeMasterItem? @relation("PriceHistory_ChargeMaster", fields: [chargeMasterItemId], references: [id], onDelete: Cascade)
  tariffRateId       String?

  oldPrice      Decimal @db.Decimal(12, 2)
  newPrice      Decimal @db.Decimal(12, 2)
  changeAmount  Decimal @db.Decimal(12, 2)
  changePercent Decimal @db.Decimal(7, 4)
  changeReason  String? @db.VarChar(500)

  effectiveFrom DateTime
  effectiveTill DateTime?

  approvedByUserId String?
  approvedByUser   User?     @relation("PriceHistoryApprovedBy", fields: [approvedByUserId], references: [id], onDelete: SetNull)
  approvedAt       DateTime?

  createdByUserId String?
  createdByUser   User?   @relation("PriceHistoryCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([branchId, serviceItemId, effectiveFrom])
  @@index([branchId, chargeMasterItemId, effectiveFrom])
}

model ContractServiceRate {
  id         String        @id @default(cuid())
  contractId String
  contract   PayerContract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  serviceItemId      String?
  serviceItem        ServiceItem?      @relation("ContractRate_ServiceItem", fields: [serviceItemId], references: [id], onDelete: Restrict)
  packageId          String?
  pkg                ServicePackage?   @relation("ContractRate_ServicePackage", fields: [packageId], references: [id], onDelete: Restrict)
  chargeMasterItemId String?
  chargeMasterItem   ChargeMasterItem? @relation("ContractRate_ChargeMaster", fields: [chargeMasterItemId], references: [id], onDelete: Restrict)
  category           String?           @db.VarChar(80)

  rateType         ContractRateType @default(FIXED_PRICE)
  fixedPrice       Decimal?         @db.Decimal(12, 2)
  percentageOfBase Decimal?         @db.Decimal(7, 4)
  discountPercent  Decimal?         @db.Decimal(5, 2)
  minPrice         Decimal?         @db.Decimal(12, 2)
  maxPrice         Decimal?         @db.Decimal(12, 2)

  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?
  version       Int       @default(1)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([contractId, serviceItemId])
  @@index([contractId, chargeMasterItemId])
  @@index([contractId, category])
}

model GovernmentSchemeConfig {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  schemeType SchemeType
  schemeName String     @db.VarChar(160)
  schemeCode String     @db.VarChar(48)

  // Registration
  registrationNumber String?   @db.VarChar(64)
  registrationDate   DateTime?
  validTill          DateTime?
  shaCode            String?   @db.VarChar(64)
  nhaCode            String?   @db.VarChar(64)
  nhaHospitalCode    String?   @db.VarChar(64)

  // Empaneled specialties (array of specialty IDs)
  empaneledSpecialtyIds String[] @default([])

  // Preauth config
  preauthRequired          Boolean  @default(true)
  preauthAutoApprovalLimit Decimal? @db.Decimal(12, 2)
  verificationMethod       String?  @db.VarChar(32)

  // Package mapping (JSONB: maps scheme package codes to hospital packages)
  packageMapping Json?

  // Claim config
  claimSubmissionUrl        String?  @db.VarChar(500)
  claimSubmissionMethod     String?  @db.VarChar(32)
  claimSubmissionWindowDays Int?
  claimProcessingTimeDays   Int?
  requiredDocuments         String[] @default([])

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  insuranceCases InsuranceCase[]

  // --- Linking to Compliance SchemeEmpanelment ---
  empanelment SchemeEmpanelment? @relation("EmpanelmentToGovScheme")

  @@unique([branchId, schemeCode])
  @@index([branchId, schemeType, isActive])
}

model PatientPricingTier {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  kind        PricingTierKind
  name        String          @db.VarChar(100)
  code        String          @db.VarChar(48)
  description String?

  assignmentRules        Json?
  defaultDiscountPercent Decimal? @db.Decimal(5, 2)
  defaultMarkupPercent   Decimal? @db.Decimal(5, 2)
  maxDiscountCap         Decimal? @db.Decimal(12, 2)

  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tierRates PatientPricingTierRate[]

  @@unique([branchId, code])
  @@index([branchId, kind, isActive])
}

model PatientPricingTierRate {
  id     String             @id @default(cuid())
  tierId String
  tier   PatientPricingTier @relation(fields: [tierId], references: [id], onDelete: Cascade)

  serviceItemId      String?
  serviceItem        ServiceItem?      @relation("TierRate_ServiceItem", fields: [serviceItemId], references: [id], onDelete: Restrict)
  chargeMasterItemId String?
  chargeMasterItem   ChargeMasterItem? @relation("TierRate_ChargeMaster", fields: [chargeMasterItemId], references: [id], onDelete: Restrict)

  rateAmount      Decimal? @db.Decimal(12, 2)
  discountPercent Decimal? @db.Decimal(5, 2)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tierId, serviceItemId])
  @@index([tierId, chargeMasterItemId])
}

// ---------------- Fix-It Queue ----------------

enum FixItTaskType {
  SERVICE_CHARGE_MAPPING_MISSING
  SERVICE_AVAILABILITY_MISSING
  TARIFF_RATE_MISSING
  TAX_CODE_MISSING
  TAX_CODE_INACTIVE
  PACKAGE_PRICING_MISSING
  CHARGE_UNIT_MISMATCH
  CLONE_MISSING_SERVICE_ITEM
  CLONE_MISSING_DIAGNOSTIC_ITEM
  CLONE_MISSING_CHARGE_MASTER_ITEM
}

enum FixItEntityType {
  SERVICE_ITEM
  CHARGE_MASTER_ITEM
  TAX_CODE
  TARIFF_PLAN
  TARIFF_RATE
  SERVICE_CATALOGUE
  SERVICE_PACKAGE
  ORDER_SET
  DIAGNOSTIC_ITEM
}

enum FixItSeverity {
  BLOCKER
  WARNING
  INFO
}

enum FixItStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  DISMISSED
}

model FixItTask {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  type     FixItTaskType
  status   FixItStatus   @default(OPEN)
  severity FixItSeverity @default(BLOCKER)

  entityType FixItEntityType?
  entityId   String?

  title   String
  details Json?

  serviceItemId String?
  serviceItem   ServiceItem? @relation(fields: [serviceItemId], references: [id], onDelete: SetNull)

  assignedToUserId String?
  assignedToUser   User?   @relation("FixItAssignedTo", fields: [assignedToUserId], references: [id], onDelete: SetNull)

  resolvedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([branchId, status])
  @@index([branchId, severity, status])
  @@index([branchId, entityType])
}

// ---------------- Bulk Import Jobs ----------------

enum BulkImportStatus {
  VALIDATED
  COMMITTED
  FAILED
}

enum BulkImportEntityType {
  LOCATIONS
  UNITS
  ROOMS
  RESOURCES
  EQUIPMENT
  SERVICE_ITEMS
  CHARGE_MASTER
}

model BulkImportJob {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  entityType BulkImportEntityType
  status     BulkImportStatus     @default(VALIDATED)

  fileName String?

  payload Json
  errors  Json?

  totalRows   Int
  validRows   Int
  invalidRows Int

  committedAt DateTime?

  createdByUserId String?
  createdByUser   User?   @relation("ImportJobCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([branchId, entityType, status])
}

// ---------------- Scheduling (OT / Procedure-capable Units) ----------------

enum BookingStatus {
  SCHEDULED
  CANCELLED
  COMPLETED
}

model ProcedureBooking {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  unitId String
  unit   Unit   @relation(fields: [unitId], references: [id], onDelete: Cascade)

  resourceId String
  resource   UnitResource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  patientId    String?
  departmentId String?

  startAt DateTime
  endAt   DateTime
  status  BookingStatus @default(SCHEDULED)

  consentOk    Boolean @default(false)
  anesthesiaOk Boolean @default(false)
  checklistOk  Boolean @default(false)

  createdByUserId String?
  createdByUser   User?   @relation("BookingCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  cancelledAt DateTime?

  createdAt DateTime @default(now())

  @@index([branchId, resourceId, startAt, endAt])
  @@index([branchId, unitId, startAt])
}

// ---------------- Go-Live Validator Snapshot ----------------

model GoLiveReport {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  score    Int
  blockers Json
  warnings Json
  snapshot Json

  createdByUserId String?
  createdByUser   User?   @relation("GoLiveCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([branchId, createdAt])
}

// =========================
// Operation Theatre Setup
// =========================

enum OtSuiteStatus {
  draft
  ready
  active
  booked
  in_use
  maintenance
  archived
}

enum OtSpaceType {
  THEATRE
  RECOVERY_BAY
  PREOP_HOLDING
  INDUCTION_ROOM
  SCRUB_ROOM
  STERILE_STORE
  ANESTHESIA_STORE
  EQUIPMENT_STORE
  STAFF_CHANGE
  OTHER
}

enum OtTheatreType {
  GENERAL
  MODULAR
  LAMINAR
  HYBRID
}

enum OtAirflowType {
  STANDARD
  LAMINAR
}

enum OtPressureType {
  POSITIVE
  NEGATIVE
  NEUTRAL
}

enum OtEquipmentCategory {
  ANESTHESIA_MACHINE
  AIRWAY_MANAGEMENT
  VENTILATION_RESPIRATORY
  PATIENT_MONITORING
  HEMODYNAMIC_MONITORING
  SURGICAL_INSTRUMENTS
  OR_FURNITURE
  OR_LIGHTING
  ELECTROSURGERY_ENERGY
  ENDOSCOPY_LAPAROSCOPY
  IMAGING_INTRAOP
  STERILIZATION_CSSD
  DISINFECTION_CLEANING
  STERILE_STORAGE_PACKAGING
  MEDICAL_GASES
  SUCTION_SYSTEMS
  POWER_BACKUP
  PATIENT_WARMING
  DVT_PROPHYLAXIS
  SAFETY_EMERGENCY
  RECOVERY_PACU_EQUIPMENT
  IT_AV_EQUIPMENT
  CONSUMABLES_DISPOSABLES
  OTHER
}

model OtSuite {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation("OtSuite_Branch", fields: [branchId], references: [id])

  // Optional: link suite to a location node representing OT complex area (floor/wing)
  locationNodeId String?
  locationNode   LocationNode? @relation("OtSuite_LocationNode", fields: [locationNodeId], references: [id])

  code   String
  name   String
  status OtSuiteStatus @default(draft)

  // Suite-level config (turnaround time, cleaning time, min recovery bays, etc.)
  config Json?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  spaces    OtSpace[]
  equipment OtEquipment[]

  @@unique([branchId, code])
  @@index([branchId])
  @@index([locationNodeId])
}

model OtSpace {
  id      String  @id @default(cuid())
  suiteId String
  suite   OtSuite @relation(fields: [suiteId], references: [id], onDelete: Cascade)

  type OtSpaceType
  code String
  name String

  // Optional: map each OT space to a specific LocationNode (room) in your location tree
  locationNodeId String?
  locationNode   LocationNode? @relation("OtSpace_LocationNode", fields: [locationNodeId], references: [id])

  notes String?
  meta  Json?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  theatre     OtTheatre?
  recoveryBay OtRecoveryBay?
  equipment   OtEquipment[]

  @@unique([suiteId, code])
  @@index([suiteId, type])
  @@index([locationNodeId])
}

model OtTheatre {
  id      String  @id @default(cuid())
  spaceId String  @unique
  space   OtSpace @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  theatreType OtTheatreType  @default(GENERAL)
  airflow     OtAirflowType  @default(STANDARD)
  pressure    OtPressureType @default(POSITIVE)

  // Optional classification fields (keep flexible for later)
  isoClass String?
  meta     Json?

  // If your DB is Postgres, String[] is fine. Otherwise switch to Json.
  specialtyCodes String[] @default([])

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tables OtTable[]

  @@index([spaceId])
}

model OtRecoveryBay {
  id      String  @id @default(cuid())
  spaceId String  @unique
  space   OtSpace @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  bedCount     Int @default(1)
  monitorCount Int @default(0)
  oxygenPoints Int @default(0)

  meta Json?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OtTable {
  id        String    @id @default(cuid())
  theatreId String
  theatre   OtTheatre @relation(fields: [theatreId], references: [id], onDelete: Cascade)

  code      String
  name      String
  isPrimary Boolean @default(true)

  manufacturer String?
  model        String?
  serialNo     String?
  installedAt  DateTime?

  meta Json?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([theatreId, code])
  @@index([theatreId])
}

model OtEquipment {
  id String @id @default(cuid())

  suiteId String
  suite   OtSuite @relation(fields: [suiteId], references: [id], onDelete: Cascade)

  // Optional: assign equipment to a specific OT space (theatre/recovery/etc.)
  spaceId String?
  space   OtSpace? @relation(fields: [spaceId], references: [id], onDelete: SetNull)

  category OtEquipmentCategory @default(OTHER)
  name     String
  qty      Int                 @default(1)

  manufacturer String?
  model        String?
  serialNo     String?

  lastServiceAt           DateTime?
  nextServiceAt           DateTime?
  maintenanceIntervalDays Int?

  meta Json?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([suiteId, category])
  @@index([spaceId])
}

// ---------------- Diagnostics Facilities (Infrastructure) ----------------

enum DiagnosticSectionType {
  LAB
  IMAGING
  CARDIOLOGY
  NEUROLOGY
  PULMONOLOGY
  OTHER
}

enum DiagnosticCareContext {
  OPD
  IPD
  ER
  DAYCARE
  HOMECARE
  ALL
}

enum DiagnosticPanelType {
  PROFILE
  PACKAGE
}

enum DiagnosticRangeSource {
  MANUFACTURER
  HOSPITAL_DEFINED
  LITERATURE
  REGULATORY_BODY
  CONSENSUS_GUIDELINE
  OTHER
}

enum DiagnosticServicePointType {
  LAB
  RADIOLOGY
  CARDIO_DIAGNOSTICS
  NEURO_DIAGNOSTICS
  PULMONARY_DIAGNOSTICS
  ENDOSCOPY
  OTHER
}

enum DiagnosticModality {
  // Imaging
  XRAY
  ULTRASOUND
  CT
  MRI
  MAMMOGRAPHY
  FLUOROSCOPY

  // Cardio / Neuro / Pulmonary
  ECG
  ECHO
  TMT
  HOLTER
  PFT
  EEG
  EMG_NCV

  // Lab / Collection
  LAB
  SAMPLE_COLLECTION

  // Procedure rooms
  PROCEDURE_ROOM

  OTHER
}

enum DiagnosticKind {
  LAB
  IMAGING
  PROCEDURE
}

enum DiagnosticResultDataType {
  NUMERIC
  TEXT
  BOOLEAN
  CHOICE
}

enum DiagnosticTemplateKind {
  IMAGING_REPORT
  LAB_REPORT
}

enum DiagnosticPackVersionStatus {
  DRAFT
  ACTIVE
  RETIRED
}

model DiagnosticSection {
  id        String   @id @default(cuid())
  branchId  String
  code      String
  name      String
  type      DiagnosticSectionType @default(LAB)
  sortOrder Int                   @default(0)
  isActive  Boolean               @default(true)

  // section head (optional FK to Staff)
  headStaffId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  categories    DiagnosticCategory[]
  items         DiagnosticItem[]
  servicePoints DiagnosticServicePointSection[]

  @@unique([branchId, code])
  @@index([branchId, isActive])
  @@index([branchId, type])
}

model DiagnosticCategory {
  id        String   @id @default(cuid())
  branchId  String
  sectionId String
  code      String
  name      String
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  section DiagnosticSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  items   DiagnosticItem[]

  @@unique([branchId, code])
  @@index([branchId, sectionId, isActive])
}

model SpecimenType {
  id                     String   @id @default(cuid())
  branchId               String
  code                   String
  name                   String
  container              String?
  minVolumeMl            Float?
  handlingNotes          String?
  fastingRequired        Boolean  @default(false)
  fastingHours           Int?
  collectionInstructions String?
  storageTemperature     String?
  isActive               Boolean  @default(true)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  items DiagnosticItem[]

  @@unique([branchId, code])
  @@index([branchId, isActive])
}

model DiagnosticItem {
  id       String         @id @default(cuid())
  branchId String
  code     String
  name     String
  kind     DiagnosticKind

  // taxonomy
  sectionId  String
  categoryId String?

  // coding standards
  loincCode     String?
  snomedCode    String?
  searchAliases Json?   // string[] — alternative names for search

  // care context
  careContext DiagnosticCareContext @default(ALL)

  // lab
  specimenId     String?
  tatMinsRoutine Int?
  tatMinsStat    Int?

  // imaging/procedure
  requiresAppointment Boolean @default(false)
  preparationText     String?
  consentRequired     Boolean @default(false)
  requiresPcpndt      Boolean @default(false)

  // Optional: link to ServiceItem master for unified orderables/catalogues
  serviceItemId String?
  serviceItem   ServiceItem? @relation("DiagnosticItem_ServiceItem", fields: [serviceItemId], references: [id], onDelete: SetNull)

  // panels
  isPanel   Boolean              @default(false)
  panelType DiagnosticPanelType?

  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  section  DiagnosticSection   @relation(fields: [sectionId], references: [id], onDelete: Restrict)
  category DiagnosticCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  specimen SpecimenType?       @relation(fields: [specimenId], references: [id], onDelete: SetNull)

  // panel composition
  panelChildren DiagnosticPanelItem[] @relation("PanelParent")
  panelParents  DiagnosticPanelItem[] @relation("PanelChild")

  // lab results
  parameters DiagnosticParameter[]

  // templates
  templates               DiagnosticTemplate[]
  // Facilities & resources layer: which service points can perform this item
  capabilities            DiagnosticCapability[]
  ServicePackageComponent ServicePackageComponent[]
  OrderSetItem            OrderSetItem[]

  @@unique([branchId, code])
  @@unique([serviceItemId])
  @@index([branchId, kind, isActive])
  @@index([branchId, sectionId, categoryId])
  @@index([branchId, loincCode])
}

model DiagnosticPanelItem {
  id        String   @id @default(cuid())
  panelId   String
  itemId    String
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  panel DiagnosticItem @relation("PanelParent", fields: [panelId], references: [id], onDelete: Cascade)
  item  DiagnosticItem @relation("PanelChild", fields: [itemId], references: [id], onDelete: Restrict)

  @@unique([panelId, itemId])
  @@index([panelId, isActive])
}

model DiagnosticParameter {
  id          String                   @id @default(cuid())
  testId      String
  code        String
  name        String
  dataType    DiagnosticResultDataType
  unit        String?
  precision   Int? // decimals
  allowedText String? // for CHOICE: comma separated values (simple MVP)

  // derived / formula parameters
  isDerived Boolean @default(false)
  formula   String? // e.g. "ALBUMIN / (TOTAL_PROTEIN - ALBUMIN)"

  // critical thresholds (for NUMERIC)
  criticalLow  Float?
  criticalHigh Float?

  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  test   DiagnosticItem             @relation(fields: [testId], references: [id], onDelete: Cascade)
  ranges DiagnosticReferenceRange[]

  @@unique([testId, code])
  @@index([testId, isActive])
}

model DiagnosticReferenceRange {
  id          String @id @default(cuid())
  parameterId String

  // demographics
  sex        String? // M/F/O or null
  ageMinDays Int?
  ageMaxDays Int?

  // range
  low       Float?
  high      Float?
  textRange String?

  // notes / remarks (display-only)
  notes  String?
  source DiagnosticRangeSource?

  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  parameter DiagnosticParameter @relation(fields: [parameterId], references: [id], onDelete: Cascade)

  @@index([parameterId, isActive])
}

model DiagnosticTemplate {
  id        String                 @id @default(cuid())
  itemId    String
  kind      DiagnosticTemplateKind @default(IMAGING_REPORT)
  name      String
  body      String
  isActive  Boolean                @default(true)

  // structured config
  headerConfig    Json? // { logo, hospitalName, address, nablNumber, regNumber }
  footerConfig    Json? // { disclaimer, notes }
  parameterLayout Json? // { groupBy, showUnits, showRanges, showFlags }
  signatureRoles  Json? // string[] — e.g. ["Lab Technician", "Consultant Pathologist"]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  item DiagnosticItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId, kind, isActive])
}

model DiagnosticServicePoint {
  id String @id @default(cuid())

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  // Mandatory: every diagnostic unit must be tagged to a location node within branch
  locationNodeId String
  locationNode   LocationNode @relation(fields: [locationNodeId], references: [id], onDelete: Restrict)

  // Optional: link to existing infra Unit (if you want), but not required
  unitId String?
  unit   Unit?   @relation(fields: [unitId], references: [id], onDelete: SetNull)

  code String @db.VarChar(64)
  name String @db.VarChar(160)

  type DiagnosticServicePointType @default(OTHER)

  // operational config
  operatingHours Json? // { start, end, days[], is24x7 }
  capacity       Int?  // max samples/slots per day

  isActive  Boolean @default(true)
  sortOrder Int     @default(0)
  notes     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  rooms     DiagnosticServicePointRoom[]
  resources DiagnosticServicePointResource[]
  equipment DiagnosticServicePointEquipment[]
  sections  DiagnosticServicePointSection[]
  staff     DiagnosticServicePointStaff[]

  // Optional routing contract for future operations
  capabilities DiagnosticCapability[]

  @@unique([branchId, code])
  @@index([branchId, type, isActive, sortOrder])
  @@index([branchId, locationNodeId])
  @@index([branchId, unitId])
}

model DiagnosticServicePointRoom {
  id       String @id @default(cuid())
  branchId String

  servicePointId String
  servicePoint   DiagnosticServicePoint @relation(fields: [servicePointId], references: [id], onDelete: Cascade)

  roomId String
  room   UnitRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)

  modality  DiagnosticModality @default(OTHER)
  sortOrder Int                @default(0)
  isActive  Boolean            @default(true)
  notes     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([servicePointId, roomId])
  @@index([branchId, servicePointId, isActive])
  @@index([branchId, roomId])
  @@index([branchId, modality, isActive])
}

model DiagnosticServicePointResource {
  id       String @id @default(cuid())
  branchId String

  servicePointId String
  servicePoint   DiagnosticServicePoint @relation(fields: [servicePointId], references: [id], onDelete: Cascade)

  resourceId String
  resource   UnitResource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  modality  DiagnosticModality @default(OTHER)
  sortOrder Int                @default(0)
  isActive  Boolean            @default(true)
  notes     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([servicePointId, resourceId])
  @@index([branchId, servicePointId, isActive])
  @@index([branchId, resourceId])
  @@index([branchId, modality, isActive])
}

model DiagnosticServicePointEquipment {
  id       String @id @default(cuid())
  branchId String

  servicePointId String
  servicePoint   DiagnosticServicePoint @relation(fields: [servicePointId], references: [id], onDelete: Cascade)

  equipmentId String
  equipment   EquipmentAsset @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  modality  DiagnosticModality @default(OTHER)
  sortOrder Int                @default(0)
  isActive  Boolean            @default(true)
  notes     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([servicePointId, equipmentId])
  @@index([branchId, servicePointId, isActive])
  @@index([branchId, equipmentId])
  @@index([branchId, modality, isActive])
}

model DiagnosticServicePointSection {
  id       String @id @default(cuid())
  branchId String

  servicePointId String
  servicePoint   DiagnosticServicePoint @relation(fields: [servicePointId], references: [id], onDelete: Cascade)

  sectionId String
  section   DiagnosticSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([servicePointId, sectionId])
  @@index([branchId, servicePointId, isActive])
  @@index([branchId, sectionId])
}

model DiagnosticServicePointStaff {
  id       String @id @default(cuid())
  branchId String

  servicePointId String
  servicePoint   DiagnosticServicePoint @relation(fields: [servicePointId], references: [id], onDelete: Cascade)

  staffId String
  role    String? // e.g. "Lab Technician", "Pathologist", "Radiologist"

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([servicePointId, staffId])
  @@index([branchId, servicePointId, isActive])
  @@index([branchId, staffId])
}

model DiagnosticCapability {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  diagnosticItemId String
  diagnosticItem   DiagnosticItem @relation(fields: [diagnosticItemId], references: [id], onDelete: Cascade)

  servicePointId String
  servicePoint   DiagnosticServicePoint @relation(fields: [servicePointId], references: [id], onDelete: Cascade)

  // Optional override (item.kind=IMAGING but modality could be XRAY vs USG etc.)
  modality DiagnosticModality?

  // future operations use these
  defaultDurationMins Int?
  isPrimary           Boolean @default(false)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Optional constraints: restrict to specific rooms/resources/equipment
  allowedRooms     DiagnosticCapabilityRoom[]
  allowedResources DiagnosticCapabilityResource[]
  allowedEquipment DiagnosticCapabilityEquipment[]

  @@unique([servicePointId, diagnosticItemId])
  @@index([branchId, diagnosticItemId, isActive])
  @@index([branchId, servicePointId, isActive])
  @@index([modality, isActive])
}

model DiagnosticCapabilityRoom {
  id       String @id @default(cuid())
  branchId String

  capabilityId String
  capability   DiagnosticCapability @relation(fields: [capabilityId], references: [id], onDelete: Cascade)

  roomId String
  room   UnitRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([capabilityId, roomId])
  @@index([branchId, capabilityId, isActive])
  @@index([branchId, roomId])
}

model DiagnosticCapabilityResource {
  id       String @id @default(cuid())
  branchId String

  capabilityId String
  capability   DiagnosticCapability @relation(fields: [capabilityId], references: [id], onDelete: Cascade)

  resourceId String
  resource   UnitResource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([capabilityId, resourceId])
  @@index([branchId, capabilityId, isActive])
  @@index([branchId, resourceId])
}

model DiagnosticCapabilityEquipment {
  id       String @id @default(cuid())
  branchId String

  capabilityId String
  capability   DiagnosticCapability @relation(fields: [capabilityId], references: [id], onDelete: Cascade)

  equipmentId String
  equipment   EquipmentAsset @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([capabilityId, equipmentId])
  @@index([branchId, capabilityId, isActive])
  @@index([branchId, equipmentId])
}

model DiagnosticPack {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  labType     String?
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  versions DiagnosticPackVersion[]
}

model DiagnosticPackVersion {
  id      String                      @id @default(cuid())
  packId  String
  pack    DiagnosticPack              @relation(fields: [packId], references: [id], onDelete: Cascade)
  version Int
  status  DiagnosticPackVersionStatus @default(DRAFT)
  notes   String?
  payload Json

  createdByUserId String?
  createdByUser   User?   @relation("DiagnosticPackVersionCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([packId, version])
  @@index([packId, status])
}

// ---------------------------------------------------------------------------
// Equipment Register Extensions (Additive; no breaking changes)
// ---------------------------------------------------------------------------

enum EquipmentDocumentType {
  AERB_LICENSE
  PCPNDT_CERTIFICATE
  SHIELDING_PLAN
  CALIBRATION_CERTIFICATE
  INSTALLATION_REPORT
  USER_MANUAL
  SOP
  WARRANTY_CARD
  AMC_CONTRACT
  SERVICE_REPORT
  INSURANCE_POLICY
  OTHER
}

enum EquipmentContractType {
  WARRANTY
  AMC
  CMC
  LEASE
  RENTAL
  INSURANCE
  OTHER
}

enum EquipmentMaintenanceType {
  PM
  CALIBRATION
  QUALIFICATION
  SAFETY_TEST
  REPAIR
  OTHER
}

enum EquipmentMaintenanceStatus {
  DUE
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  SKIPPED
  CANCELLED
}

enum EquipmentEvidenceStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum EquipmentMovementReason {
  INSTALLATION
  TRANSFER
  TEMPORARY_MOVE
  STORAGE
  REPLACEMENT
  DECOMMISSION
  OTHER
}

enum GovernedChangeStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  CANCELLED
  APPLIED
}

// --- 1) Effective-dated snapshot history (no destructive edits) ---
model EquipmentAssetRevision {
  id      String         @id @default(cuid())
  assetId String
  asset   EquipmentAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  // Snapshot fields (copied from EquipmentAsset at time of change)
  code     String            @db.VarChar(64)
  name     String            @db.VarChar(160)
  category EquipmentCategory

  make   String?
  model  String?
  serial String?

  ownerDepartmentId String?

  operationalStatus EquipmentOperationalStatus
  isSchedulable     Boolean

  amcVendor       String?
  amcValidFrom    DateTime?
  amcValidTo      DateTime?
  warrantyValidTo DateTime?

  pmFrequencyDays Int?
  nextPmDueAt     DateTime?

  aerbLicenseNo String?
  aerbValidTo   DateTime?

  pcpndtRegNo   String?
  pcpndtValidTo DateTime?

  // Effective dating
  effectiveFrom DateTime
  effectiveTo   DateTime?

  // Governance traceability
  createdByUserId String?
  createdByUser   User?   @relation("EquipmentRevisionCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([assetId, effectiveFrom])
  @@index([code])
}

// --- 2) Placement bound to your topology (LocationNode / Unit / Room / Resource) ---
model EquipmentPlacement {
  id      String         @id @default(cuid())
  assetId String         @unique
  asset   EquipmentAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  locationNodeId String?
  locationNode   LocationNode? @relation(fields: [locationNodeId], references: [id], onDelete: SetNull)

  unitId String?
  unit   Unit?   @relation(fields: [unitId], references: [id], onDelete: SetNull)

  roomId String?
  room   UnitRoom? @relation(fields: [roomId], references: [id], onDelete: SetNull)

  resourceId String?
  resource   UnitResource? @relation(fields: [resourceId], references: [id], onDelete: SetNull)

  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?

  createdByUserId String?
  createdByUser   User?   @relation("EquipmentPlacementCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([branchId, locationNodeId])
  @@index([branchId, unitId])
  @@index([branchId, roomId])
  @@index([branchId, resourceId])
}

// --- 3) Movement log (portable/shared asset reality) ---
model EquipmentMovement {
  id      String         @id @default(cuid())
  assetId String
  asset   EquipmentAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  reason EquipmentMovementReason @default(TRANSFER)
  notes  String?

  fromLocationNodeId String?
  fromUnitId         String?
  fromRoomId         String?
  fromResourceId     String?

  toLocationNodeId String?
  toUnitId         String?
  toRoomId         String?
  toResourceId     String?

  movedAt DateTime @default(now())

  movedByUserId String?
  movedByUser   User?   @relation("EquipmentMovedBy", fields: [movedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([assetId, movedAt])
  @@index([branchId, movedAt])
}

// --- 4) Documents & evidence (licenses, calibration certs, manuals, contracts) ---
model EquipmentDocument {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  assetId String
  asset   EquipmentAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  type  EquipmentDocumentType
  title String                @db.VarChar(200)

  fileUrl  String
  fileMime String?
  fileSize Int?
  checksum String?

  refNo     String?
  issuedAt  DateTime?
  validFrom DateTime?
  validTo   DateTime?

  meta Json?

  uploadedByUserId String?
  uploadedByUser   User?   @relation("EquipmentDocUploadedBy", fields: [uploadedByUserId], references: [id], onDelete: SetNull)

  createdAt                   DateTime                      @default(now())
  updatedAt                   DateTime                      @updatedAt
  EquipmentComplianceEvidence EquipmentComplianceEvidence[]

  @@index([assetId, type])
  @@index([branchId, type])
  @@index([branchId, validTo])
}

// --- 5) Contracts (AMC/CMC/Lease/Insurance), without deleting existing quick fields ---
model EquipmentContract {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  assetId String
  asset   EquipmentAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  type       EquipmentContractType
  contractNo String?

  vendorName    String?
  vendorContact Json?

  startAt DateTime?
  endAt   DateTime?

  terms    Json?
  isActive Boolean @default(true)

  createdByUserId String?
  createdByUser   User?   @relation("EquipmentContractCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([assetId, type, isActive])
  @@index([branchId, type, endAt])
}

// --- 6) Maintenance scheduling + execution records (beyond “nextPmDueAt”) ---
model EquipmentMaintenanceTask {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  assetId String
  asset   EquipmentAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  type   EquipmentMaintenanceType
  status EquipmentMaintenanceStatus @default(DUE)

  dueAt        DateTime
  scheduledFor DateTime?
  startedAt    DateTime?
  completedAt  DateTime?

  downtimeTicketId String?
  downtimeTicket   DowntimeTicket? @relation(fields: [downtimeTicketId], references: [id], onDelete: SetNull)

  performedByVendor  String?
  performedByStaffId String?
  performedByStaff   Staff?  @relation(fields: [performedByStaffId], references: [id], onDelete: SetNull)

  checklist    Json?
  measurements Json?
  outcomeNotes String?

  createdByUserId String?
  createdByUser   User?   @relation("EquipmentMaintCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([branchId, dueAt, status])
  @@index([assetId, status])
}

// --- 7) Verified compliance evidence (Compliance Officer workflow) ---
model EquipmentComplianceEvidence {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  assetId String
  asset   EquipmentAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  complianceCode String @db.VarChar(64) // e.g., "AERB", "PCPNDT"
  evidenceType   String @db.VarChar(64) // e.g., "LICENSE", "QC_REPORT"

  documentId String?
  document   EquipmentDocument? @relation(fields: [documentId], references: [id], onDelete: SetNull)

  status EquipmentEvidenceStatus @default(PENDING)

  verifiedAt       DateTime?
  verifiedByUserId String?
  verifiedByUser   User?     @relation("EquipmentEvidenceVerifiedBy", fields: [verifiedByUserId], references: [id], onDelete: SetNull)

  notes String?
  meta  Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([branchId, complianceCode, status])
  @@index([assetId, complianceCode])
}

// --- 8) Maker–checker-ready governance (generic for Setup Studio edits) ---
model GovernedChangeRequest {
  id       String  @id @default(cuid())
  branchId String?
  branch   Branch? @relation(fields: [branchId], references: [id], onDelete: SetNull)

  entity   String // e.g., "EquipmentAsset", "EquipmentContract"
  entityId String?
  action   String // e.g., "CREATE", "UPDATE", "RETIRE", "MOVE"

  payload     Json
  effectiveAt DateTime @default(now())

  status GovernedChangeStatus @default(DRAFT)

  createdByUserId String?
  createdByUser   User?   @relation("GovernedChangeCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  submittedAt       DateTime?
  submittedByUserId String?
  submittedByUser   User?     @relation("GovernedChangeSubmittedBy", fields: [submittedByUserId], references: [id], onDelete: SetNull)

  approvedAt       DateTime?
  approvedByUserId String?
  approvedByUser   User?     @relation("GovernedChangeApprovedBy", fields: [approvedByUserId], references: [id], onDelete: SetNull)
  approvalNote     String?

  rejectedAt       DateTime?
  rejectedByUserId String?
  rejectedByUser   User?     @relation("GovernedChangeRejectedBy", fields: [rejectedByUserId], references: [id], onDelete: SetNull)
  rejectionReason  String?

  appliedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([branchId, status, createdAt])
  @@index([entity, entityId, status])
}

enum ServiceLifecycleStatus {
  DRAFT
  IN_REVIEW
  APPROVED
  PUBLISHED
  DEPRECATED
}

enum ServiceChargeUnit {
  PER_UNIT
  PER_VISIT
  PER_TEST
  PER_HOUR
  PER_DAY
  PER_SIDE
  PER_LEVEL
  PER_SESSION

  PER_PROCEDURE
  PER_PACKAGE
}

enum TaxType {
  GST
  TDS
  OTHER
}

enum PayerKind {
  CASH
  INSURANCE
  TPA
  CORPORATE
  GOVERNMENT
  TRUST
  EMPLOYEE
  OTHER
}

enum PayerStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  BLOCKED
}

enum PricingTierKind {
  GENERAL
  SENIOR_CITIZEN
  STAFF
  EMPLOYEE_FAMILY
  BPL
  MEDICAL_COUNCIL
  CUSTOM
}

enum SchemeType {
  PMJAY
  CGHS
  ECHS
  STATE_SCHEME
  OTHER
}

enum ContractRateType {
  FIXED_PRICE
  PERCENTAGE_OF_BASE
  DISCOUNT
}

enum OverUtilizationPolicy {
  CHARGE_ADDITIONAL
  ABSORB
}

enum UnderUtilizationRefund {
  NO_REFUND
  PARTIAL
  FULL
}

enum PricingStrategy {
  GLOBAL_DISCOUNT
  CATEGORY_WISE
  SERVICE_SPECIFIC
}

enum ContractStatus {
  DRAFT
  ACTIVE
  SUSPENDED
  EXPIRED
  TERMINATED
}

enum TariffPlanKind {
  PRICE_LIST
  PAYER_CONTRACT
}

enum TariffPlanStatus {
  DRAFT
  ACTIVE
  RETIRED
}

enum PackagePricingMode {
  COMPONENT_SUM
  FIXED
  DISCOUNT_PERCENT
  DISCOUNT_AMOUNT
  CAP
}

enum TaxApplicability {
  GST_EXEMPT
  GST_STANDARD
  GST_ZERO
  GST_REDUCED
}

enum CatalogueScope {
  ENTERPRISE
  BRANCH
}

enum CatalogueStatus {
  DRAFT
  IN_REVIEW
  APPROVED
  PUBLISHED
  RETIRED
}

enum PackageStatus {
  DRAFT
  IN_REVIEW
  APPROVED
  PUBLISHED
  RETIRED
}

enum PackageComponentType {
  SERVICE_ITEM
  DIAGNOSTIC_ITEM
  CHARGE_MASTER_ITEM
}

enum OrderSetStatus {
  DRAFT
  IN_REVIEW
  APPROVED
  PUBLISHED
  RETIRED
}

enum OrderSetItemType {
  SERVICE_ITEM
  DIAGNOSTIC_ITEM
  SERVICE_PACKAGE
}

enum StandardCodeSystem {
  INTERNAL
  LOINC
  CPT
  HCPCS
  SNOMED
  ICD10PCS
  OTHER
}

enum ExternalSystemType {
  LIS
  RIS
  ERP
  OTHER
}

// =====================================================================
// PHARMACY INFRASTRUCTURE MODULE (Phase 0B)
// =====================================================================

enum PharmacyStoreType {
  MAIN
  IP_PHARMACY
  OP_PHARMACY
  EMERGENCY
  OT_STORE
  ICU_STORE
  WARD_STORE
  NARCOTICS
}

enum PharmacyStoreStatus {
  ACTIVE
  INACTIVE
  UNDER_SETUP
}

enum DrugCategory {
  TABLET
  CAPSULE
  INJECTION
  SYRUP
  OINTMENT
  DROPS
  INHALER
  SUPPOSITORY
  PATCH
  POWDER
  IV_FLUID
  OTHER
}

enum DrugRoute {
  ORAL
  IV
  IM
  SC
  TOPICAL
  INHALATION
  RECTAL
  OPHTHALMIC
  NASAL
  SUBLINGUAL
  TRANSDERMAL
}

enum DrugScheduleClass {
  GENERAL
  H
  H1
  X
  G
}

enum DrugFormularyStatus {
  APPROVED
  RESTRICTED
  NON_FORMULARY
}

enum DrugLifecycleStatus {
  ACTIVE
  INACTIVE
  RECALLED
}

enum FormularyVersionStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum PharmSupplierStatus {
  ACTIVE
  BLACKLISTED
  INACTIVE
}

enum InteractionSeverity {
  MAJOR
  MODERATE
  MINOR
}

enum InteractionSource {
  STANDARD
  CUSTOM
}

enum NarcoticsTransactionType {
  RECEIPT
  ISSUE
  WASTAGE
  ADJUSTMENT
}

// ---- Pharmacy Store ----
model PharmacyStore {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  storeCode String            @db.VarChar(32)
  storeName String            @db.VarChar(160)
  storeType PharmacyStoreType

  // Hierarchy (self-referencing tree)
  parentStoreId String?
  parentStore   PharmacyStore?  @relation("PharmacyStoreTree", fields: [parentStoreId], references: [id])
  childStores   PharmacyStore[] @relation("PharmacyStoreTree")

  // Location binding
  locationNodeId String?
  locationNode   LocationNode? @relation(fields: [locationNodeId], references: [id])

  // Pharmacist in-charge (Staff ref)
  pharmacistInChargeId String?
  pharmacistInCharge   Staff?  @relation("PharmacistInCharge", fields: [pharmacistInChargeId], references: [id])

  // Drug license
  drugLicenseNumber String?   @db.VarChar(64)
  drugLicenseExpiry DateTime?

  // Capabilities
  is24x7          Boolean @default(false)
  canDispense     Boolean @default(false)
  canIndent       Boolean @default(true)
  canReceiveStock Boolean @default(false)
  canReturnVendor Boolean @default(false)

  // Operating config
  operatingHours    Json?
  autoIndentEnabled Boolean             @default(false)
  status            PharmacyStoreStatus @default(UNDER_SETUP)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Reverse relations
  inventoryConfigs   InventoryConfig[]
  narcoticsRegisters NarcoticsRegister[]
  drugLicenseHistory DrugLicenseHistory[]
  supplierMappings   SupplierStoreMapping[]
  requestingIndents  StoreIndentMapping[]   @relation("IndentRequesting")
  supplyingIndents   StoreIndentMapping[]   @relation("IndentSupplying")

  @@unique([branchId, storeCode])
  @@index([branchId, storeType, status])
}

// ---- Drug Master ----
model DrugMaster {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  drugCode    String  @db.VarChar(32)
  genericName String  @db.VarChar(255)
  brandName   String? @db.VarChar(255)

  manufacturer         String?      @db.VarChar(255)
  category             DrugCategory
  dosageForm           String?      @db.VarChar(120)
  strength             String?      @db.VarChar(60)
  route                DrugRoute?
  therapeuticClass     String?      @db.VarChar(160)
  pharmacologicalClass String?      @db.VarChar(160)

  // Indian regulatory classification
  scheduleClass  DrugScheduleClass @default(GENERAL)
  isNarcotic     Boolean           @default(false)
  isPsychotropic Boolean           @default(false)
  isControlled   Boolean           @default(false)
  isAntibiotic   Boolean           @default(false)
  isHighAlert    Boolean           @default(false)
  isLasa         Boolean           @default(false)

  // Pricing & tax
  mrp           Decimal? @db.Decimal(12, 2)
  purchasePrice Decimal? @db.Decimal(12, 2)
  hsnCode       String?  @db.VarChar(16)
  gstRate       Decimal? @db.Decimal(5, 2)
  packSize      Int?

  // Dosing
  defaultDosage String? @db.VarChar(160)
  maxDailyDose  String? @db.VarChar(80)

  // Metadata
  contraindications Json?

  formularyStatus DrugFormularyStatus @default(APPROVED)
  status          DrugLifecycleStatus @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Optional hierarchical category
  drugCategoryNodeId String?
  drugCategoryNode   DrugCategoryNode? @relation(fields: [drugCategoryNodeId], references: [id], onDelete: SetNull)

  // Reverse relations
  interactionsA        DrugInteraction[]         @relation("DrugInteractionA")
  interactionsB        DrugInteraction[]         @relation("DrugInteractionB")
  formularyItems       FormularyItem[]
  substitutionsFrom    TherapeuticSubstitution[] @relation("SubstitutionSource")
  substitutionsTo      TherapeuticSubstitution[] @relation("SubstitutionTarget")
  inventoryConfigs     InventoryConfig[]
  narcoticsRegisters   NarcoticsRegister[]
  supplierDrugMappings SupplierDrugMapping[]

  @@unique([branchId, drugCode])
  @@index([branchId, genericName])
  @@index([branchId, category, status])
  @@index([branchId, scheduleClass])
}

// ---- Drug Interaction ----
model DrugInteraction {
  id String @id @default(cuid())

  drugAId String
  drugA   DrugMaster @relation("DrugInteractionA", fields: [drugAId], references: [id], onDelete: Cascade)

  drugBId String
  drugB   DrugMaster @relation("DrugInteractionB", fields: [drugBId], references: [id], onDelete: Cascade)

  severity       InteractionSeverity
  description    String?             @db.VarChar(500)
  recommendation String?             @db.VarChar(500)
  source         InteractionSource   @default(STANDARD)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([drugAId, drugBId])
  @@index([drugAId])
  @@index([drugBId])
}

// ---- Formulary (version-controlled) ----
model Formulary {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  version           Int
  effectiveDate     DateTime?
  status            FormularyVersionStatus @default(DRAFT)
  publishedAt       DateTime?
  publishedByUserId String?
  publishedByUser   User?                  @relation("FormularyPublisher", fields: [publishedByUserId], references: [id])
  notes             String?                @db.VarChar(500)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items FormularyItem[]

  @@unique([branchId, version])
  @@index([branchId, status])
}

// ---- Formulary Item (drug-to-tier mapping) ----
model FormularyItem {
  id String @id @default(cuid())

  formularyId String
  formulary   Formulary @relation(fields: [formularyId], references: [id], onDelete: Cascade)

  drugMasterId String
  drugMaster   DrugMaster @relation(fields: [drugMasterId], references: [id], onDelete: Cascade)

  tier  DrugFormularyStatus @default(APPROVED)
  notes String?             @db.VarChar(500)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([formularyId, drugMasterId])
}

// ---- Therapeutic Substitution ----
model TherapeuticSubstitution {
  id       String @id @default(cuid())
  branchId String

  sourceDrugId String
  sourceDrug   DrugMaster @relation("SubstitutionSource", fields: [sourceDrugId], references: [id], onDelete: Cascade)

  targetDrugId String
  targetDrug   DrugMaster @relation("SubstitutionTarget", fields: [targetDrugId], references: [id], onDelete: Cascade)

  notes    String? @db.VarChar(500)
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([branchId, sourceDrugId])
}

// ---- Supplier ----
model PharmSupplier {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  supplierCode String @db.VarChar(32)
  supplierName String @db.VarChar(255)

  gstin             String?   @db.VarChar(15)
  drugLicenseNumber String?   @db.VarChar(64)
  drugLicenseExpiry DateTime?

  contactPerson String? @db.VarChar(160)
  phone         String? @db.VarChar(20)
  email         String? @db.VarChar(120)
  address       String? @db.VarChar(500)

  paymentTermsDays     Int?
  discountTerms        String?  @db.VarChar(255)
  deliveryLeadTimeDays Int?
  productCategories    Json?
  rating               Decimal? @db.Decimal(3, 1)

  status PharmSupplierStatus @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  storeMappings SupplierStoreMapping[]
  drugMappings  SupplierDrugMapping[]

  @@unique([branchId, supplierCode])
  @@index([branchId, status])
}

// ---- Supplier ↔ Store Mapping ----
model SupplierStoreMapping {
  id String @id @default(cuid())

  supplierId String
  supplier   PharmSupplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  pharmacyStoreId String
  pharmacyStore   PharmacyStore @relation(fields: [pharmacyStoreId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([supplierId, pharmacyStoreId])
}

// ---- Supplier ↔ Drug Mapping (which supplier provides which drugs) ----
model SupplierDrugMapping {
  id String @id @default(cuid())

  supplierId String
  supplier   PharmSupplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  drugMasterId String
  drugMaster   DrugMaster @relation(fields: [drugMasterId], references: [id], onDelete: Cascade)

  supplierPrice Decimal? @db.Decimal(12, 2)
  leadTimeDays  Int?
  isPreferred   Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([supplierId, drugMasterId])
  @@index([drugMasterId])
}

// ---- Inventory Config (per store-drug) ----
model InventoryConfig {
  id String @id @default(cuid())

  pharmacyStoreId String
  pharmacyStore   PharmacyStore @relation(fields: [pharmacyStoreId], references: [id], onDelete: Cascade)

  drugMasterId String
  drugMaster   DrugMaster @relation(fields: [drugMasterId], references: [id], onDelete: Cascade)

  minimumStock    Int?
  maximumStock    Int?
  reorderLevel    Int?
  reorderQuantity Int?
  safetyStock     Int?

  abcClass String? @db.VarChar(1) // A, B, C
  vedClass String? @db.VarChar(1) // V, E, D

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([pharmacyStoreId, drugMasterId])
  @@index([pharmacyStoreId])
}

// ---- Store-to-Store Indent Mapping ----
model StoreIndentMapping {
  id String @id @default(cuid())

  requestingStoreId String
  requestingStore   PharmacyStore @relation("IndentRequesting", fields: [requestingStoreId], references: [id], onDelete: Cascade)

  supplyingStoreId String
  supplyingStore   PharmacyStore @relation("IndentSupplying", fields: [supplyingStoreId], references: [id], onDelete: Cascade)

  approvalRole        String? @db.VarChar(80)
  slaDurationMinutes  Int?
  isEmergencyOverride Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([requestingStoreId, supplyingStoreId])
}

// ---- Narcotics Register (immutable transaction log) ----
model NarcoticsRegister {
  id String @id @default(cuid())

  pharmacyStoreId String
  pharmacyStore   PharmacyStore @relation(fields: [pharmacyStoreId], references: [id], onDelete: Cascade)

  drugMasterId String
  drugMaster   DrugMaster @relation(fields: [drugMasterId], references: [id], onDelete: Cascade)

  transactionType NarcoticsTransactionType
  quantity        Decimal                  @db.Decimal(12, 3)
  batchNumber     String?                  @db.VarChar(64)
  balanceBefore   Decimal                  @db.Decimal(12, 3)
  balanceAfter    Decimal                  @db.Decimal(12, 3)

  witnessName      String? @db.VarChar(160)
  witnessSignature String? @db.VarChar(500)
  notes            String? @db.VarChar(500)

  performedByUserId String?
  performedByUser   User?   @relation("NarcoticsPerformedBy", fields: [performedByUserId], references: [id])

  createdAt DateTime @default(now())

  @@index([pharmacyStoreId, drugMasterId, createdAt])
}

// ---- Drug License History ----
model DrugLicenseHistory {
  id String @id @default(cuid())

  pharmacyStoreId String
  pharmacyStore   PharmacyStore @relation(fields: [pharmacyStoreId], references: [id], onDelete: Cascade)

  licenseNumber String   @db.VarChar(64)
  validFrom     DateTime
  validTo       DateTime
  documentUrl   String?  @db.VarChar(500)

  uploadedByUserId String?
  uploadedByUser   User?   @relation("DrugLicenseUploader", fields: [uploadedByUserId], references: [id])

  createdAt DateTime @default(now())

  @@index([pharmacyStoreId, validTo])
}

// ---- Drug Category Hierarchy (ATC-based classification) ----
model DrugCategoryNode {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  code String @db.VarChar(32)
  name String @db.VarChar(160)

  parentId String?
  parent   DrugCategoryNode?  @relation("CategoryTree", fields: [parentId], references: [id], onDelete: SetNull)
  children DrugCategoryNode[] @relation("CategoryTree")

  sortOrder Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  drugs DrugMaster[]

  @@unique([branchId, code])
  @@index([branchId, parentId])
}

// ===========================================================================================
// INSURANCE CLAIMS TRANSACTION LAYER — HCX-First Architecture
// ===========================================================================================

// ---- Insurance Enums ----

enum PolicyStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  SUSPENDED
  LAPSED
}

enum PolicyRelationship {
  SELF
  SPOUSE
  CHILD
  PARENT
  OTHER
}

enum InsuranceCaseType {
  CASHLESS
  REIMBURSEMENT
  PACKAGE
}

enum InsuranceCaseStatus {
  DRAFT
  POLICY_VERIFIED
  PREAUTH_PENDING
  PREAUTH_APPROVED
  ADMITTED
  DISCHARGE_PENDING
  CLAIM_SUBMITTED
  CLAIM_APPROVED
  SETTLED
  CLOSED
  CANCELLED
}

enum PreauthStatus {
  PREAUTH_DRAFT
  PREAUTH_SUBMITTED
  PREAUTH_QUERY_RAISED
  PREAUTH_RESPONDED
  PREAUTH_APPROVED
  PREAUTH_REJECTED
  PREAUTH_ENHANCEMENT_REQUESTED
  PREAUTH_ENHANCEMENT_APPROVED
  PREAUTH_EXPIRED
}

enum PreauthQuerySource {
  TPA
  HOSPITAL
}

enum ClaimStatus {
  CLAIM_DRAFT
  CLAIM_SUBMITTED
  CLAIM_ACKNOWLEDGED
  CLAIM_QUERY_RAISED
  CLAIM_RESPONDED
  CLAIM_UNDER_REVIEW
  CLAIM_APPROVED
  CLAIM_PARTIALLY_APPROVED
  CLAIM_REJECTED
  CLAIM_DEDUCTED
  CLAIM_PAID
  CLAIM_CLOSED
  CLAIM_RESUBMITTED
}

enum ClaimType {
  FINAL
  INTERIM
  ENHANCEMENT
}

enum DeductionCategory {
  NON_PAYABLE
  EXCESS
  COPAY
  DEDUCTIBLE
  NON_MEDICAL
  TARIFF_DIFF
  OTHER
}

enum IntegrationMode {
  HCX
  NHCX
  DIRECT_API
  SFTP_BATCH
  PORTAL_ASSISTED
  MANUAL
}

enum GatewayTxType {
  PREAUTH_SUBMIT
  PREAUTH_STATUS
  CLAIM_SUBMIT
  CLAIM_STATUS
  COVERAGE_CHECK
  PAYMENT_NOTICE
  WEBHOOK_INBOUND
}

enum GatewayTxStatus {
  GATEWAY_QUEUED
  GATEWAY_SENT
  GATEWAY_ACK_RECEIVED
  GATEWAY_RESPONSE_RECEIVED
  GATEWAY_FAILED
  GATEWAY_TIMED_OUT
}

enum InsuranceDocRole {
  PREAUTH_FORM
  DISCHARGE_SUMMARY
  INVESTIGATION_REPORT
  PRESCRIPTION
  BILL_SUMMARY
  CLAIM_FORM
  ID_PROOF
  INSURANCE_CARD
  QUERY_RESPONSE
  ENHANCEMENT_FORM
  DOC_OTHER
}

enum InsuranceDocEntityType {
  INSURANCE_CASE
  PREAUTH
  CLAIM
  PATIENT_POLICY
}

enum PaymentAdviceStatus {
  PA_RECEIVED
  PA_RECONCILED
  PA_DISPUTED
  PA_PARTIAL
}

enum PaymentMode {
  NEFT
  RTGS
  CHEQUE
  UPI
  CASH_PAYMENT
  OTHER_MODE
}

// ---- 1. PatientInsurancePolicy ----
model PatientInsurancePolicy {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  payerId String
  payer   Payer  @relation(fields: [payerId], references: [id], onDelete: Cascade)

  contractId String?
  contract   PayerContract? @relation(fields: [contractId], references: [id], onDelete: SetNull)

  policyNumber String  @db.VarChar(64)
  memberId     String  @db.VarChar(64)
  groupId      String? @db.VarChar(64)
  employerName String? @db.VarChar(160)
  planName     String? @db.VarChar(160)

  relationship PolicyRelationship @default(SELF)

  status    PolicyStatus @default(ACTIVE)
  validFrom DateTime
  validTo   DateTime

  sumInsured       Decimal? @db.Decimal(14, 2)
  balanceRemaining Decimal? @db.Decimal(14, 2)

  cardNumber   String? @db.VarChar(64)
  cardImageUrl String? @db.VarChar(500)

  verifiedAt       DateTime?
  verifiedByUserId String?
  verifiedByUser   User?     @relation("PolicyVerifiedBy", fields: [verifiedByUserId], references: [id], onDelete: SetNull)

  meta Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  insuranceCases InsuranceCase[]
  documentLinks  InsuranceDocumentLink[]

  @@unique([branchId, patientId, payerId, policyNumber])
  @@index([branchId, patientId])
  @@index([branchId, payerId, status])
}

// ---- 2. InsuranceCase ----
model InsuranceCase {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  caseNumber String @db.VarChar(48)

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  encounterId String
  encounter   Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)

  admissionId String?
  admission   Admission? @relation(fields: [admissionId], references: [id], onDelete: SetNull)

  policyId String
  policy   PatientInsurancePolicy @relation(fields: [policyId], references: [id], onDelete: Cascade)

  payerId String
  payer   Payer  @relation(fields: [payerId], references: [id], onDelete: Cascade)

  contractId String?
  contract   PayerContract? @relation(fields: [contractId], references: [id], onDelete: SetNull)

  schemeConfigId String?
  schemeConfig   GovernmentSchemeConfig? @relation(fields: [schemeConfigId], references: [id], onDelete: SetNull)

  caseType InsuranceCaseType   @default(CASHLESS)
  status   InsuranceCaseStatus @default(DRAFT)

  treatingDoctorId String?
  treatingDoctor   Staff?  @relation("InsuranceCase_TreatingDoctor", fields: [treatingDoctorId], references: [id], onDelete: SetNull)

  primaryDiagnosis String?
  procedures       String[] @default([])
  packageCode      String?  @db.VarChar(48)
  packageName      String?  @db.VarChar(160)

  estimatedAmount Decimal? @db.Decimal(14, 2)
  approvedAmount  Decimal? @db.Decimal(14, 2)
  claimedAmount   Decimal? @db.Decimal(14, 2)
  settledAmount   Decimal? @db.Decimal(14, 2)

  assignedToUserId String?
  assignedToUser   User?   @relation("InsuranceCase_AssignedTo", fields: [assignedToUserId], references: [id], onDelete: SetNull)

  slaDeadline DateTime?
  escalatedAt DateTime?

  notes String?
  meta  Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  preauthRequests PreauthRequest[]
  claims          Claim[]
  documentLinks   InsuranceDocumentLink[]

  @@unique([branchId, caseNumber])
  @@index([branchId, status])
  @@index([branchId, patientId])
  @@index([branchId, payerId, status])
  @@index([branchId, encounterId])
}

// ---- 3. PreauthRequest ----
model PreauthRequest {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  insuranceCaseId String
  insuranceCase   InsuranceCase @relation(fields: [insuranceCaseId], references: [id], onDelete: Cascade)

  requestNumber String        @db.VarChar(48)
  version       Int           @default(1)
  status        PreauthStatus @default(PREAUTH_DRAFT)

  requestedAmount Decimal? @db.Decimal(14, 2)
  approvedAmount  Decimal? @db.Decimal(14, 2)

  packageCode      String? @db.VarChar(48)
  procedureSummary String?
  clinicalNotes    String?

  // Clinical coding (structured, for NHCX/FHIR submission)
  primaryDiagnosisCode    String?  @db.VarChar(16) // ICD-10
  primaryDiagnosisDesc    String?  @db.VarChar(240)
  secondaryDiagnosisCodes String[] @default([]) // additional ICD-10 codes
  procedureCodes          String[] @default([]) // ICD-10-PCS / CPT / internal
  hbpPackageCode          String?  @db.VarChar(48) // PM-JAY HBP code
  implantDetails          String? // implant description if applicable
  investigationSummary    String? // summary of investigations
  otNotes                 String? // OT/surgical notes summary

  submittedAt       DateTime?
  submittedByUserId String?
  submittedByUser   User?     @relation("Preauth_SubmittedBy", fields: [submittedByUserId], references: [id], onDelete: SetNull)

  approvedAt       DateTime?
  approvedByUserId String?

  rejectedAt      DateTime?
  rejectionReason String?

  validTill DateTime?

  enhancementAmount Decimal? @db.Decimal(14, 2)
  enhancementReason String?

  gatewayRefId String? @db.VarChar(128)

  meta Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  queries       PreauthQuery[]
  documentLinks InsuranceDocumentLink[]

  @@index([insuranceCaseId, status])
  @@index([branchId, status])
}

// ---- 4. PreauthQuery ----
model PreauthQuery {
  id String @id @default(cuid())

  preauthId String
  preauth   PreauthRequest @relation(fields: [preauthId], references: [id], onDelete: Cascade)

  queryText   String
  querySource PreauthQuerySource

  queriedAt       DateTime @default(now())
  queriedByUserId String?
  queriedByUser   User?    @relation("PreauthQuery_QueriedBy", fields: [queriedByUserId], references: [id], onDelete: SetNull)

  responseText      String?
  respondedAt       DateTime?
  respondedByUserId String?
  respondedByUser   User?     @relation("PreauthQuery_RespondedBy", fields: [respondedByUserId], references: [id], onDelete: SetNull)

  deadline       DateTime?
  attachmentUrls String[]  @default([])

  meta Json?

  createdAt DateTime @default(now())

  @@index([preauthId, queriedAt])
}

// ---- 5. Claim ----
model Claim {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  insuranceCaseId String
  insuranceCase   InsuranceCase @relation(fields: [insuranceCaseId], references: [id], onDelete: Cascade)

  claimNumber String      @db.VarChar(48)
  claimType   ClaimType   @default(FINAL)
  version     Int         @default(1)
  status      ClaimStatus @default(CLAIM_DRAFT)

  totalAmount    Decimal? @db.Decimal(14, 2)
  approvedAmount Decimal? @db.Decimal(14, 2)
  deductedAmount Decimal? @db.Decimal(14, 2)
  paidAmount     Decimal? @db.Decimal(14, 2)

  submittedAt       DateTime?
  submittedByUserId String?
  submittedByUser   User?     @relation("Claim_SubmittedBy", fields: [submittedByUserId], references: [id], onDelete: SetNull)

  acknowledgedAt DateTime?

  approvedAt       DateTime?
  approvedByUserId String?

  rejectedAt      DateTime?
  rejectionReason String?

  paidAt DateTime?

  gatewayRefId String? @db.VarChar(128)

  // Self-relation for resubmission chain
  resubmissionOfId String?
  resubmissionOf   Claim?  @relation("ClaimResubmission", fields: [resubmissionOfId], references: [id], onDelete: SetNull)
  resubmissions    Claim[] @relation("ClaimResubmission")

  notes String?
  meta  Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lineItems      ClaimLineItem[]
  deductions     ClaimDeduction[]
  versions       ClaimVersion[]
  documentLinks  InsuranceDocumentLink[]
  paymentAdvices PaymentAdvice[]

  @@unique([branchId, claimNumber])
  @@index([insuranceCaseId, status])
  @@index([branchId, status])
}

// ---- 6. ClaimLineItem ----
model ClaimLineItem {
  id String @id @default(cuid())

  claimId String
  claim   Claim  @relation(fields: [claimId], references: [id], onDelete: Cascade)

  serviceItemId String?
  serviceItem   ServiceItem? @relation("ClaimLine_ServiceItem", fields: [serviceItemId], references: [id], onDelete: Restrict)

  chargeMasterItemId String?
  chargeMasterItem   ChargeMasterItem? @relation("ClaimLine_ChargeMaster", fields: [chargeMasterItemId], references: [id], onDelete: Restrict)

  description String  @db.VarChar(240)
  quantity    Int     @default(1)
  unitPrice   Decimal @db.Decimal(12, 2)
  totalPrice  Decimal @db.Decimal(12, 2)

  // Clinical coding (structured, for NHCX/FHIR compliant submissions)
  icdCode        String?  @db.VarChar(16) // ICD-10-CM diagnosis code
  icdDescription String?  @db.VarChar(240)
  cptCode        String?  @db.VarChar(16) // CPT / ASHA / local procedure code
  cptDescription String?  @db.VarChar(240)
  snomedCode     String?  @db.VarChar(24) // SNOMED CT concept id
  modifiers      String[] @default([]) // up to 4 HCPCS/CPT modifiers
  placeOfService String?  @db.VarChar(4) // "IP" | "OP" | "ER" | "DC" (day-care)
  diagnosisRef   String?  @db.VarChar(64) // reference to clinical diagnosis (encounter-level)

  approvedQuantity  Int?
  approvedUnitPrice Decimal? @db.Decimal(12, 2)
  approvedTotal     Decimal? @db.Decimal(12, 2)

  deniedAmount     Decimal? @db.Decimal(12, 2)
  denialReasonCode String?  @db.VarChar(48)
  denialNotes      String?

  packageCode String? @db.VarChar(48)
  hsnSac      String? @db.VarChar(16)

  meta Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([claimId])
}

// ---- 7. ClaimDeduction ----
model ClaimDeduction {
  id String @id @default(cuid())

  claimId String
  claim   Claim  @relation(fields: [claimId], references: [id], onDelete: Cascade)

  reasonCode     String            @db.VarChar(48)
  reasonCategory DeductionCategory @default(OTHER)
  description    String
  amount         Decimal           @db.Decimal(12, 2)

  isDisputed   Boolean @default(false)
  disputeNotes String?

  createdAt DateTime @default(now())

  @@index([claimId])
}

// ---- 8. ClaimVersion ----
model ClaimVersion {
  id String @id @default(cuid())

  claimId String
  claim   Claim  @relation(fields: [claimId], references: [id], onDelete: Cascade)

  versionNumber Int
  snapshot      Json // full claim + line items frozen

  createdAt       DateTime @default(now())
  createdByUserId String?
  createdByUser   User?    @relation("ClaimVersion_CreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  changeReason String?

  @@unique([claimId, versionNumber])
}

// ---- 9. InsuranceDocument ----
model InsuranceDocument {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  title         String  @db.VarChar(240)
  fileUrl       String  @db.VarChar(500)
  fileMime      String? @db.VarChar(128)
  fileSizeBytes Int?
  checksum      String? @db.VarChar(128)

  docRole InsuranceDocRole @default(DOC_OTHER)
  version Int              @default(1)

  uploadedAt       DateTime @default(now())
  uploadedByUserId String?
  uploadedByUser   User?    @relation("InsDoc_UploadedBy", fields: [uploadedByUserId], references: [id], onDelete: SetNull)

  verifiedAt       DateTime?
  verifiedByUserId String?
  verifiedByUser   User?     @relation("InsDoc_VerifiedBy", fields: [verifiedByUserId], references: [id], onDelete: SetNull)

  tags String[] @default([])
  meta Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  links InsuranceDocumentLink[]

  @@index([branchId, docRole])
}

// ---- 10. InsuranceDocumentLink ----
model InsuranceDocumentLink {
  id String @id @default(cuid())

  documentId String
  document   InsuranceDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  entityType InsuranceDocEntityType
  entityId   String

  isRequired Boolean @default(false)

  // Optional typed relations (Prisma requires these for referential integrity)
  insuranceCaseId String?
  insuranceCase   InsuranceCase? @relation(fields: [insuranceCaseId], references: [id], onDelete: SetNull)

  preauthRequestId String?
  preauthRequest   PreauthRequest? @relation(fields: [preauthRequestId], references: [id], onDelete: SetNull)

  claimId String?
  claim   Claim?  @relation(fields: [claimId], references: [id], onDelete: SetNull)

  policyId String?
  policy   PatientInsurancePolicy? @relation(fields: [policyId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@unique([documentId, entityType, entityId])
  @@index([entityType, entityId])
}

// ---- 11. PayerIntegrationConfig ----
model PayerIntegrationConfig {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  payerId String
  payer   Payer  @relation(fields: [payerId], references: [id], onDelete: Cascade)

  integrationMode IntegrationMode @default(MANUAL)

  // HCX / NHCX
  hcxParticipantCode String? @db.VarChar(128)
  hcxEndpointUrl     String? @db.VarChar(500)
  hcxAuthConfig      Json?

  // Direct API
  apiBaseUrl    String? @db.VarChar(500)
  apiAuthMethod String? @db.VarChar(32)
  apiAuthConfig Json?

  // SFTP
  sftpHost       String? @db.VarChar(256)
  sftpPort       Int?
  sftpPath       String? @db.VarChar(256)
  sftpAuthConfig Json?

  // Portal-assisted
  portalUrl   String? @db.VarChar(500)
  portalNotes String?

  // Webhook
  webhookSecret String? @db.VarChar(256)
  webhookUrl    String? @db.VarChar(500)

  // Retry config
  retryMaxAttempts  Int  @default(3)
  retryBackoffMs    Int  @default(5000)
  pollingIntervalMs Int?

  isActive Boolean @default(true)
  meta     Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  gatewayTransactions GatewayTransaction[]

  @@unique([branchId, payerId])
  @@index([branchId, integrationMode, isActive])
}

// ---- 12. PaymentAdvice ----
model PaymentAdvice {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  claimId String
  claim   Claim  @relation(fields: [claimId], references: [id], onDelete: Cascade)

  adviceNumber String?  @db.VarChar(64)
  utrNumber    String?  @db.VarChar(64)
  paymentDate  DateTime

  amount      Decimal     @db.Decimal(14, 2)
  paymentMode PaymentMode @default(NEFT)

  status PaymentAdviceStatus @default(PA_RECEIVED)

  bankReference      String? @db.VarChar(128)
  shortPaymentReason String?

  reconciledAt       DateTime?
  reconciledByUserId String?
  reconciledByUser   User?     @relation("PaymentAdvice_ReconciledBy", fields: [reconciledByUserId], references: [id], onDelete: SetNull)

  meta Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([claimId])
  @@index([branchId, paymentDate])
}

// ---- 13. GatewayTransaction ----
model GatewayTransaction {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  payerIntegrationConfigId String
  payerIntegrationConfig   PayerIntegrationConfig @relation(fields: [payerIntegrationConfigId], references: [id], onDelete: Cascade)

  txType   GatewayTxType
  txStatus GatewayTxStatus @default(GATEWAY_QUEUED)

  entityType String @db.VarChar(32) // "PREAUTH" | "CLAIM"
  entityId   String

  requestPayload  Json?
  responsePayload Json?
  externalRefId   String? @db.VarChar(128)

  sentAt      DateTime?
  respondedAt DateTime?

  attempts    Int       @default(0)
  lastError   String?
  nextRetryAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([entityType, entityId])
  @@index([txStatus, nextRetryAt])
  @@index([branchId, txType])
}

// ================================================================
// Document Checklist System (payer-wise required document templates)
// ================================================================

enum DocChecklistScope {
  ALL_CASES
  CASHLESS_ONLY
  REIMBURSEMENT_ONLY
  PACKAGE_ONLY
}

// ---- PayerDocumentTemplate — defines a set of required documents per payer + case type ----
model PayerDocumentTemplate {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  payerId String
  payer   Payer  @relation("Payer_DocTemplates", fields: [payerId], references: [id], onDelete: Cascade)

  name        String              @db.VarChar(160) // e.g. "Star Health — Cashless IPD"
  scope       DocChecklistScope   @default(ALL_CASES)
  caseTypes   InsuranceCaseType[] @default([]) // empty = all types
  description String?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  rules PayerDocumentRule[]

  @@unique([branchId, payerId, name])
  @@index([branchId, payerId])
}

// ---- PayerDocumentRule — individual required doc within a template ----
model PayerDocumentRule {
  id         String                @id @default(cuid())
  templateId String
  template   PayerDocumentTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  docRole     InsuranceDocRole // which document role is required
  label       String           @db.VarChar(160) // human-readable name
  description String? // instructions / help text for upload
  isRequired  Boolean          @default(true) // required vs recommended
  requiredAt  String?          @db.VarChar(48) // stage: "PREAUTH_SUBMIT" | "CLAIM_SUBMIT" | "DISCHARGE"
  sortOrder   Int              @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([templateId])
}

// ================== COMPLIANCE INFRASTRUCTURE ==================

enum ComplianceWorkspaceType {
  ORG_TEMPLATE
  BRANCH
}

enum ComplianceWorkspaceStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum EnvironmentType {
  SANDBOX
  PRODUCTION
}

enum VerificationStatus {
  NOT_SUBMITTED
  PENDING
  VERIFIED
  REJECTED
}

enum RegistrationStatus {
  UNVERIFIED
  VERIFIED
  EXPIRED
  MISMATCH
}

// SchemeType reused from existing enum at line ~5425

enum EmpanelmentStatus {
  DRAFT
  ACTIVE
  SUSPENDED
}

enum CityCategory {
  A
  B
  C
}

enum RateCardStatus {
  DRAFT
  ACTIVE
  FROZEN
  ARCHIVED
}

enum NabhItemStatus {
  NOT_STARTED
  IN_PROGRESS
  IMPLEMENTED
  VERIFIED
  NON_COMPLIANT
}

enum RiskLevel {
  CRITICAL
  MAJOR
  MINOR
}

enum EvidenceStatus {
  ACTIVE
  ARCHIVED
}

enum ComplianceApprovalStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  CANCELLED
}

enum AuditCycleStatus {
  PLANNED
  IN_PROGRESS
  CLOSED
}

enum FindingSeverity {
  CRITICAL
  MAJOR
  MINOR
}

enum CapaStatus {
  OPEN
  IN_PROGRESS
  CLOSED
}

enum ComplianceEntityType {
  COMPLIANCE_WORKSPACE
  ABDM_CONFIG
  HFR_PROFILE
  HPR_LINK
  SCHEME_EMPANELMENT
  SCHEME_RATE_CARD
  SCHEME_MAPPING
  NABH_TEMPLATE
  NABH_ITEM
  EVIDENCE
  AUDIT_CYCLE
  FINDING
  CAPA
  APPROVAL
  SCHEME_API_CREDENTIAL
  SCHEME_SYNC
}

// ---- ComplianceWorkspace ----
model ComplianceWorkspace {
  id       String                    @id @default(cuid())
  orgId    String
  branchId String?
  type     ComplianceWorkspaceType
  name     String
  status   ComplianceWorkspaceStatus @default(DRAFT)

  readinessScore Float?
  lastComputedAt DateTime?

  org    Organization @relation(fields: [orgId], references: [id])
  branch Branch?      @relation(fields: [branchId], references: [id])

  abdmConfigs          AbdmConfig[]
  hfrProfile           HfrFacilityProfile?
  hprLinks             HprProfessionalLink[]
  empanelments         SchemeEmpanelment[]
  rateCards            SchemeRateCard[]
  schemeMappings       SchemeMapping[]
  nabhItems            NabhWorkspaceItem[]
  evidenceArtifacts    EvidenceArtifact[]
  approvals            ComplianceApproval[]
  schemeApiCredentials SchemeApiCredential[]
  auditCycles          AuditCycle[]
  auditLogs            ComplianceAuditLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId, branchId])
  @@index([status, type])
  @@map("compliance_workspaces")
}

// ---- AbdmConfig ----
model AbdmConfig {
  id          String @id @default(cuid())
  workspaceId String

  environment EnvironmentType @default(SANDBOX)

  clientId           String?
  clientSecretEnc    String?
  callbackUrls       String[]
  featureTogglesJson Json?

  status       String    @default("NOT_CONFIGURED")
  lastTestedAt DateTime?

  workspace ComplianceWorkspace @relation(fields: [workspaceId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([workspaceId, environment])
  @@map("abdm_configs")
}

// ---- HfrFacilityProfile ----
model HfrFacilityProfile {
  id          String @id @default(cuid())
  workspaceId String @unique

  facilityName      String
  ownershipType     String
  facilityType      String
  systemsOfMedicine String[]
  servicesOffered   String[]

  addressLine1 String
  addressLine2 String?
  city         String
  state        String
  pincode      String
  latitude     Float?
  longitude    Float?
  contactPhone String?
  contactEmail String?

  hfrId              String?
  verificationStatus VerificationStatus @default(NOT_SUBMITTED)
  verificationNotes  String?
  lastSyncedAt       DateTime?

  workspace ComplianceWorkspace @relation(fields: [workspaceId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("hfr_facility_profiles")
}

// ---- HprProfessionalLink ----
model HprProfessionalLink {
  id          String @id @default(cuid())
  workspaceId String
  staffId     String

  hprId              String
  category           String
  registrationStatus RegistrationStatus @default(UNVERIFIED)

  verifiedAt        DateTime?
  verifiedByStaffId String?
  notes             String?

  workspace  ComplianceWorkspace @relation(fields: [workspaceId], references: [id])
  staff      Staff               @relation("HprStaffLink", fields: [staffId], references: [id])
  verifiedBy Staff?              @relation("HprVerifiedBy", fields: [verifiedByStaffId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([workspaceId, staffId])
  @@unique([workspaceId, hprId])
  @@index([workspaceId, registrationStatus])
  @@map("hpr_professional_links")
}

// ---- SchemeEmpanelment ----
model SchemeEmpanelment {
  id          String @id @default(cuid())
  workspaceId String

  scheme            SchemeType
  empanelmentNumber String

  shaCode      String?
  state        String?
  cityCategory CityCategory?

  status EmpanelmentStatus @default(DRAFT)

  // --- Linking to Infrastructure GovernmentSchemeConfig ---
  govSchemeConfigId String?                 @unique
  govSchemeConfig   GovernmentSchemeConfig? @relation("EmpanelmentToGovScheme", fields: [govSchemeConfigId], references: [id])
  lastSyncedAt      DateTime?

  workspace ComplianceWorkspace @relation(fields: [workspaceId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([workspaceId, scheme])
  @@index([workspaceId, scheme, status])
  @@map("scheme_empanelments")
}

// ---- SchemeRateCard ----
model SchemeRateCard {
  id          String     @id @default(cuid())
  workspaceId String
  scheme      SchemeType

  version       String
  effectiveFrom DateTime
  effectiveTo   DateTime?

  status RateCardStatus @default(DRAFT)

  items     SchemeRateCardItem[]
  workspace ComplianceWorkspace  @relation(fields: [workspaceId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([workspaceId, scheme, version])
  @@index([workspaceId, scheme, status])
  @@map("scheme_rate_cards")
}

// ---- SchemeRateCardItem ----
model SchemeRateCardItem {
  id         String @id @default(cuid())
  rateCardId String

  code String
  name String
  rate Decimal @db.Decimal(12, 2)

  inclusions String?
  exclusions String?
  metadata   Json?

  rateCard SchemeRateCard @relation(fields: [rateCardId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([rateCardId, code])
  @@index([rateCardId, name])
  @@map("scheme_rate_card_items")
}

// ---- SchemeMapping ----
model SchemeMapping {
  id          String     @id @default(cuid())
  workspaceId String
  scheme      SchemeType

  externalCode String
  externalName String?

  internalServiceId    String?
  internalTariffItemId String?

  rules Json?

  workspace ComplianceWorkspace @relation(fields: [workspaceId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([workspaceId, scheme, externalCode])
  @@index([workspaceId, scheme])
  @@map("scheme_mappings")
}

// ---- SchemeApiCredential ----
model SchemeApiCredential {
  id          String     @id @default(cuid())
  workspaceId String
  scheme      SchemeType

  apiKeyEnc    String?
  apiSecretEnc String?
  baseUrl      String?
  environment  EnvironmentType @default(SANDBOX)

  status       String    @default("NOT_CONFIGURED")
  lastTestedAt DateTime?

  workspace ComplianceWorkspace @relation(fields: [workspaceId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([workspaceId, scheme, environment])
  @@map("scheme_api_credentials")
}

// ---- NabhTemplate ----
model NabhTemplate {
  id    String @id @default(cuid())
  orgId String
  name  String

  isActive Boolean @default(true)

  items NabhTemplateItem[]
  org   Organization       @relation(fields: [orgId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId, isActive])
  @@map("nabh_templates")
}

// ---- NabhTemplateItem ----
model NabhTemplateItem {
  id         String @id @default(cuid())
  templateId String

  chapter      String
  standardCode String
  meCode       String

  title       String
  description String?

  evidenceRequired Boolean   @default(true)
  riskLevel        RiskLevel @default(MAJOR)

  template NabhTemplate @relation(fields: [templateId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([templateId, standardCode, meCode])
  @@index([templateId, chapter])
  @@map("nabh_template_items")
}

// ---- NabhWorkspaceItem ----
model NabhWorkspaceItem {
  id          String @id @default(cuid())
  workspaceId String

  chapter      String
  standardCode String
  meCode       String

  title       String
  description String?

  status           NabhItemStatus @default(NOT_STARTED)
  riskLevel        RiskLevel      @default(MAJOR)
  evidenceRequired Boolean        @default(true)

  ownerStaffId String?
  dueDate      DateTime?
  notes        String?

  verifiedAt        DateTime?
  verifiedByStaffId String?

  workspace  ComplianceWorkspace @relation(fields: [workspaceId], references: [id])
  owner      Staff?              @relation("NabhOwner", fields: [ownerStaffId], references: [id])
  verifiedBy Staff?              @relation("NabhVerifiedBy", fields: [verifiedByStaffId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([workspaceId, standardCode, meCode])
  @@index([workspaceId, chapter, status])
  @@map("nabh_workspace_items")
}

// ---- EvidenceArtifact ----
model EvidenceArtifact {
  id          String @id @default(cuid())
  workspaceId String

  title  String
  tags   String[]
  status EvidenceStatus @default(ACTIVE)

  fileKey   String
  fileName  String
  mimeType  String
  sizeBytes Int

  expiresAt         DateTime?
  uploadedByStaffId String?

  workspace  ComplianceWorkspace @relation(fields: [workspaceId], references: [id])
  uploadedBy Staff?              @relation("EvidenceUploader", fields: [uploadedByStaffId], references: [id])

  links EvidenceLink[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workspaceId, expiresAt])
  @@map("evidence_artifacts")
}

// ---- EvidenceLink ----
model EvidenceLink {
  id         String @id @default(cuid())
  evidenceId String

  targetType ComplianceEntityType
  targetId   String

  evidence EvidenceArtifact @relation(fields: [evidenceId], references: [id])

  createdAt DateTime @default(now())

  @@unique([evidenceId, targetType, targetId])
  @@index([targetType, targetId])
  @@map("evidence_links")
}

// ---- AuditCycle ----
model AuditCycle {
  id          String @id @default(cuid())
  workspaceId String

  name      String
  startDate DateTime
  endDate   DateTime

  status          AuditCycleStatus @default(PLANNED)
  auditorStaffIds String[]

  findings  AuditFinding[]
  workspace ComplianceWorkspace @relation(fields: [workspaceId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workspaceId, status])
  @@map("audit_cycles")
}

// ---- AuditFinding ----
model AuditFinding {
  id      String  @id @default(cuid())
  auditId String
  itemId  String?

  severity          FindingSeverity
  description       String
  recommendedAction String?
  dueDate           DateTime?

  capa  CapaAction?
  audit AuditCycle  @relation(fields: [auditId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([auditId, severity])
  @@map("audit_findings")
}

// ---- CapaAction ----
model CapaAction {
  id        String @id @default(cuid())
  findingId String @unique

  ownerStaffId String
  dueDate      DateTime
  actionPlan   String

  status       CapaStatus @default(OPEN)
  closureNotes String?
  closedAt     DateTime?

  finding AuditFinding @relation(fields: [findingId], references: [id])
  owner   Staff        @relation("CapaOwner", fields: [ownerStaffId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerStaffId, status])
  @@map("capa_actions")
}

// ---- ComplianceApproval ----
model ComplianceApproval {
  id          String @id @default(cuid())
  workspaceId String

  status ComplianceApprovalStatus @default(DRAFT)

  changeType String
  entityType ComplianceEntityType
  entityId   String

  payloadDraft Json
  notes        String?

  requestedByStaffId String
  decidedByStaffId   String?
  decidedAt          DateTime?
  decisionNotes      String?

  workspace   ComplianceWorkspace @relation(fields: [workspaceId], references: [id])
  requestedBy Staff               @relation("ComplianceApprovalRequestedBy", fields: [requestedByStaffId], references: [id])
  decidedBy   Staff?              @relation("ComplianceApprovalDecidedBy", fields: [decidedByStaffId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workspaceId, status])
  @@map("compliance_approvals")
}

// ---- ComplianceAuditLog ----
model ComplianceAuditLog {
  id          String @id @default(cuid())
  workspaceId String

  entityType ComplianceEntityType
  entityId   String

  action String
  before Json?
  after  Json?

  actorStaffId String?
  actorIp      String?
  userAgent    String?

  workspace ComplianceWorkspace @relation(fields: [workspaceId], references: [id])
  actor     Staff?              @relation("ComplianceAuditActor", fields: [actorStaffId], references: [id])

  createdAt DateTime @default(now())

  @@index([workspaceId, entityType, entityId])
  @@map("compliance_audit_logs")
}

// ============================================================================
// BLOOD BANK MODULE
// ============================================================================

enum BloodBankType {
  HOSPITAL_BASED
  STANDALONE
  STORAGE_CENTRE
  COMPONENT_SEPARATION_CENTRE
}

enum ComponentType {
  WHOLE_BLOOD
  PRBC
  FFP
  PLATELET_RDP
  PLATELET_SDP
  CRYOPRECIPITATE
  CRYO_POOR_PLASMA
}

enum BagType {
  SINGLE
  DOUBLE
  TRIPLE
  QUADRUPLE
}

enum DonorType {
  VOLUNTARY
  REPLACEMENT
  DIRECTED
  AUTOLOGOUS
}

enum DonorStatus {
  ELIGIBLE
  TEMPORARILY_DEFERRED
  PERMANENTLY_DEFERRED
}

enum CollectionType {
  WHOLE_BLOOD_350
  WHOLE_BLOOD_450
  APHERESIS_SDP
  APHERESIS_PLASMA
}

enum BloodUnitStatus {
  COLLECTED
  TESTING
  QUARANTINED
  AVAILABLE
  RESERVED
  CROSS_MATCHED
  ISSUED
  TRANSFER_PENDING
  IN_TRANSIT
  TRANSFUSED
  DISCARDED
  SEPARATED
  RETURNED
}

enum TTITestResult {
  REACTIVE
  NON_REACTIVE
  INDETERMINATE
  PENDING
}

enum CrossMatchMethod {
  IMMEDIATE_SPIN
  AHG_INDIRECT_COOMBS
  ELECTRONIC
}

enum CrossMatchResult {
  COMPATIBLE
  INCOMPATIBLE
  PENDING
}

enum BloodRequestUrgency {
  ROUTINE
  URGENT
  EMERGENCY
  MTP
}

enum BloodRequestStatus {
  PENDING
  SAMPLE_RECEIVED
  CROSS_MATCHING
  READY
  ISSUED
  COMPLETED
  CANCELLED
}

enum TransfusionReactionType {
  FEBRILE
  ALLERGIC
  HEMOLYTIC_ACUTE
  HEMOLYTIC_DELAYED
  TRALI
  TACO
  ANAPHYLAXIS
  BACTERIAL
  OTHER
}

enum DiscardReason {
  EXPIRED
  TTI_REACTIVE
  BAG_LEAK
  CLOT
  LIPEMIC
  HEMOLYZED
  QC_FAILURE
  RETURN_TIMEOUT
  OTHER
}

enum BBEquipmentType {
  REFRIGERATOR
  DEEP_FREEZER
  PLATELET_AGITATOR
  CELL_SEPARATOR
  BLOOD_WARMER
  CENTRIFUGE
  OTHER
}

// ---- Blood Bank Facility ----

model BloodBankFacility {
  id       String @id @default(cuid())
  branchId String @unique
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  facilityType   BloodBankType
  drugLicenseNo  String?  @db.VarChar(64)
  sbtcRegNo      String?  @db.VarChar(64)
  nacoId         String?  @db.VarChar(64)
  licenseValidTo DateTime?

  operatingHours Json? // { weekday: { open, close }, emergency24x7: bool, onCallRoster: [...] }
  physicalLayout Json? // { rooms: [{ name, type, area }] }
  defaultStorageEquipmentId String?
  defaultStorageEquipment   BloodBankEquipment? @relation("FacilityDefaultStorage", fields: [defaultStorageEquipmentId], references: [id], onDelete: SetNull)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("bb_facilities")
}

// ---- Blood Component Master ----

model BloodComponentMaster {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  componentType ComponentType
  name          String       @db.VarChar(120)
  code          String       @db.VarChar(32)

  shelfLifeDays      Int
  storageMinTempC    Decimal  @db.Decimal(5, 2)
  storageMaxTempC    Decimal  @db.Decimal(5, 2)
  volumeMinMl        Int?
  volumeMaxMl        Int?
  preparationMethod  String?  @db.VarChar(200)
  requiresAgitation  Boolean  @default(false)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tariffConfigs BBTariffConfig[]

  @@unique([branchId, code])
  @@index([branchId, isActive])
  @@map("bb_component_masters")
}

// ---- Blood Bank Equipment ----

model BloodBankEquipment {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  equipmentType    BBEquipmentType
  equipmentId      String  @db.VarChar(64)
  make             String? @db.VarChar(120)
  model            String? @db.VarChar(120)
  serialNumber     String? @db.VarChar(120)
  location         String? @db.VarChar(200)
  capacityUnits    Int?
  tempRangeMinC    Decimal? @db.Decimal(5, 2)
  tempRangeMaxC    Decimal? @db.Decimal(5, 2)
  alarmThresholdMinC Decimal? @db.Decimal(5, 2)
  alarmThresholdMaxC Decimal? @db.Decimal(5, 2)
  pollingIntervalSec Int     @default(300)

  calibrationDueDate  DateTime?
  calibrationInterval Int? // days
  lastCalibratedAt    DateTime?
  calibratedByStaffId String?

  iotSensorId String? @db.VarChar(120)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tempLogs       EquipmentTempLog[]
  inventorySlots BloodInventorySlot[]
  qcRecords      QualityControlRecord[]
  defaultForFacilities BloodBankFacility[] @relation("FacilityDefaultStorage")

  @@unique([branchId, equipmentId])
  @@index([branchId, equipmentType, isActive])
  @@map("bb_equipment")
}

// ---- Equipment Temperature Log (IoT) ----

model EquipmentTempLog {
  id          String @id @default(cuid())
  equipmentId String
  equipment   BloodBankEquipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  temperatureC Decimal  @db.Decimal(5, 2)
  recordedAt   DateTime @default(now())
  isBreaching  Boolean  @default(false)
  acknowledged Boolean  @default(false)
  acknowledgedByStaffId String?
  acknowledgedAt        DateTime?

  @@index([equipmentId, recordedAt])
  @@index([equipmentId, isBreaching])
  @@map("bb_equipment_temp_logs")
}

// ---- Blood Bank Reagent ----

model BloodBankReagent {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  name     String @db.VarChar(120)
  code     String @db.VarChar(32)
  category String @db.VarChar(64) // Anti-A, Anti-B, Anti-D, AHG, Screening Cells, ELISA kits, etc.

  lotNumber   String?   @db.VarChar(64)
  expiryDate  DateTime?
  stockQty    Int       @default(0)
  minStockQty Int       @default(0)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([branchId, code])
  @@index([branchId, isActive])
  @@map("bb_reagents")
}

// ---- Blood Bank Tariff Configuration ----

model BBTariffConfig {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  componentMasterId String?
  componentMaster   BloodComponentMaster? @relation(fields: [componentMasterId], references: [id], onDelete: SetNull)

  chargeType  String  @db.VarChar(48) // PROCESSING, CROSS_MATCH, IRRADIATION, LEUKO_REDUCTION, WASHING, VOLUME_REDUCTION
  amount      Decimal @db.Decimal(12, 2)
  currency    String  @default("INR") @db.VarChar(8)
  gstPercent  Decimal @default(0) @db.Decimal(5, 2)

  govSchemeCode String? @db.VarChar(48) // PMJAY, CGHS, STATE_SCHEME
  govSchemeRate Decimal? @db.Decimal(12, 2)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([branchId, chargeType, isActive])
  @@map("bb_tariff_configs")
}

// ---- Donor ----

model Donor {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  donorNumber String    @db.VarChar(32)
  donorType   DonorType @default(VOLUNTARY)

  name       String  @db.VarChar(160)
  gender     String  @db.VarChar(16)
  dateOfBirth DateTime?
  age        Int?
  mobile     String? @db.VarChar(20)
  email      String? @db.VarChar(120)
  aadhaarNo  String? @db.VarChar(16)
  address    String? @db.VarChar(500)
  photoUrl   String? @db.VarChar(500)

  bloodGroup   BloodGroup?
  donorStatus  DonorStatus @default(ELIGIBLE)
  donationCount Int        @default(0)
  lastDonationDate DateTime?
  nextEligibleDate DateTime?

  // Optional UHID link
  patientId String?
  patient   Patient? @relation(fields: [patientId], references: [id], onDelete: SetNull)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deferrals  DonorDeferral[]
  screenings DonorScreening[]
  bloodUnits BloodUnit[]
  lookbackCases BloodLookbackCase[]

  @@unique([branchId, donorNumber])
  @@index([branchId, donorStatus, isActive])
  @@index([branchId, bloodGroup])
  @@index([mobile])
  @@map("bb_donors")
}

// ---- Donor Deferral ----

model DonorDeferral {
  id      String @id @default(cuid())
  donorId String
  donor   Donor  @relation(fields: [donorId], references: [id], onDelete: Cascade)

  deferralType String   @db.VarChar(32) // TEMPORARY, PERMANENT
  reason       String   @db.VarChar(500)
  startDate    DateTime @default(now())
  endDate      DateTime?

  deferredByStaffId String?
  notes             String? @db.VarChar(1000)

  createdAt DateTime @default(now())

  @@index([donorId, startDate])
  @@map("bb_donor_deferrals")
}

// ---- Donor Screening ----

model DonorScreening {
  id      String @id @default(cuid())
  donorId String
  donor   Donor  @relation(fields: [donorId], references: [id], onDelete: Cascade)

  screeningDate DateTime @default(now())

  // Digital DHQ
  dhqResponses Json? // { questions: [{ id, question, answer, flagged }] }

  // Physical Examination
  hemoglobinGdl  Decimal? @db.Decimal(4, 1)
  weightKg       Decimal? @db.Decimal(5, 1)
  bpSystolic     Int?
  bpDiastolic    Int?
  pulseRate      Int?
  temperatureC   Decimal? @db.Decimal(4, 1)
  veinAssessment String?  @db.VarChar(200)

  // Decision
  eligibilityDecision String @db.VarChar(32) // ELIGIBLE, DEFERRED_TEMP, DEFERRED_PERM
  decisionNotes       String? @db.VarChar(500)
  decidedByStaffId    String?

  // Consent
  consentGiven    Boolean   @default(false)
  consentSignature String?  @db.VarChar(500) // base64 or URL
  consentTimestamp DateTime?

  createdAt DateTime @default(now())

  @@index([donorId, screeningDate])
  @@map("bb_donor_screenings")
}

// ---- Blood Unit (Master Collection Record) ----

model BloodUnit {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  unitNumber String @db.VarChar(48) // [BB Code]-[Year]-[Seq] or ISBT 128
  barcode    String @db.VarChar(64)

  donorId String
  donor   Donor  @relation(fields: [donorId], references: [id])

  bagType        BagType
  collectionType CollectionType
  bloodGroup     BloodGroup?
  rhFactor       String?      @db.VarChar(16)

  collectionStartAt DateTime?
  collectionEndAt   DateTime?
  volumeCollectedMl Int?
  segmentCount      Int?

  status BloodUnitStatus @default(COLLECTED)

  // Parent-child for component separation
  parentUnitId String?
  parentUnit   BloodUnit?  @relation("UnitSeparation", fields: [parentUnitId], references: [id], onDelete: SetNull)
  childUnits   BloodUnit[] @relation("UnitSeparation")

  // Component info (for separated child units)
  componentType ComponentType?
  expiryDate    DateTime?

  // Donor adverse event during collection
  donorAdverseEvent     String? @db.VarChar(200) // vasovagal, hematoma, nerve injury
  donorAdverseSeverity  String? @db.VarChar(32)

  // Staff tracking
  collectedByStaffId    String?
  pilotTubeLabels       Json? // [{ tubeId, purpose: "grouping"|"tti"|"serology" }]

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  groupingResults BloodGroupingResult[]
  ttiTests        TTITestRecord[]
  inventorySlot   BloodInventorySlot?
  crossMatchTests CrossMatchTest[]
  bloodIssues     BloodIssue[]
  transferItems   BloodUnitTransferItem[]

  @@unique([branchId, unitNumber])
  @@index([branchId, status, bloodGroup])
  @@index([branchId, expiryDate])
  @@index([donorId])
  @@map("bb_blood_units")
}

// ---- Blood Grouping Result ----

model BloodGroupingResult {
  id         String @id @default(cuid())
  bloodUnitId String
  bloodUnit   BloodUnit @relation(fields: [bloodUnitId], references: [id], onDelete: Cascade)

  // Forward grouping (Anti-A, Anti-B, Anti-D reactions)
  forwardGrouping Json? // { antiA: "4+", antiB: "0", antiD: "4+" }
  // Reverse grouping (A1 cells, B cells reactions)
  reverseGrouping Json? // { a1Cells: "0", bCells: "4+" }

  aboGroup       String?  @db.VarChar(8)  // A, B, AB, O
  rhType         String?  @db.VarChar(16) // Positive, Negative
  confirmedGroup BloodGroup?

  // Antibody screen
  antibodyScreenResult String? @db.VarChar(32) // POSITIVE, NEGATIVE
  antibodyIdentified   String? @db.VarChar(200)

  hasDiscrepancy Boolean @default(false)
  discrepancyNotes String? @db.VarChar(500)

  method       String? @db.VarChar(48) // TUBE, GEL_CARD, MICROPLATE
  testedByStaffId  String?
  verifiedByStaffId String?
  verifiedAt       DateTime?

  createdAt DateTime @default(now())

  @@index([bloodUnitId])
  @@map("bb_grouping_results")
}

// ---- TTI Test Record ----

model TTITestRecord {
  id         String @id @default(cuid())
  bloodUnitId String
  bloodUnit   BloodUnit @relation(fields: [bloodUnitId], references: [id], onDelete: Cascade)

  testName   String        @db.VarChar(48) // HIV, HBsAg, HCV, SYPHILIS, MALARIA
  method     String?       @db.VarChar(48) // ELISA, CLIA, RAPID, RPR
  kitName    String?       @db.VarChar(120)
  kitLotNo   String?       @db.VarChar(64)
  result     TTITestResult @default(PENDING)
  rawValue   String?       @db.VarChar(120)

  testedByStaffId  String?
  verifiedByStaffId String?
  verifiedAt       DateTime?

  createdAt DateTime @default(now())

  @@index([bloodUnitId, testName])
  @@map("bb_tti_tests")
}

// ---- Blood Inventory Slot ----

model BloodInventorySlot {
  id         String @id @default(cuid())
  bloodUnitId String @unique
  bloodUnit   BloodUnit @relation(fields: [bloodUnitId], references: [id], onDelete: Cascade)

  equipmentId String
  equipment   BloodBankEquipment @relation(fields: [equipmentId], references: [id])

  shelf String? @db.VarChar(32)
  slot  String? @db.VarChar(32)

  assignedAt  DateTime @default(now())
  removedAt   DateTime?

  @@index([equipmentId])
  @@map("bb_inventory_slots")
}

// ---- Blood Request ----

model BloodRequest {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  requestNumber String @db.VarChar(48)

  patientId   String
  patient     Patient @relation(fields: [patientId], references: [id])
  encounterId String?

  requestedComponent ComponentType
  quantityUnits      Int
  urgency            BloodRequestUrgency @default(ROUTINE)
  indication         String?             @db.VarChar(500)
  diagnosis          String?             @db.VarChar(500)

  status BloodRequestStatus @default(PENDING)

  requestedByStaffId String?
  requestedAt        DateTime @default(now())

  // SLA tracking
  slaTargetMinutes Int? // 45 routine, 15 urgent, 5 emergency

  notes String? @db.VarChar(1000)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  patientSample PatientBloodSample?
  crossMatches  CrossMatchTest[]
  bloodIssues   BloodIssue[]

  @@unique([branchId, requestNumber])
  @@index([branchId, status, urgency])
  @@index([patientId])
  @@map("bb_blood_requests")
}

// ---- Patient Blood Sample ----

model PatientBloodSample {
  id        String @id @default(cuid())
  requestId String @unique
  request   BloodRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  sampleId        String   @db.VarChar(48)
  collectedAt     DateTime @default(now())
  collectedByStaffId String?

  // Two-person verification for first sample
  verifiedByStaffId  String?
  verificationMethod String? @db.VarChar(48) // WRISTBAND_SCAN, MANUAL

  // Patient grouping on this sample
  patientBloodGroup BloodGroup?
  patientAntibodies String? @db.VarChar(500)
  groupHistoryConsistent Boolean?

  createdAt DateTime @default(now())

  crossMatches CrossMatchTest[]

  @@map("bb_patient_samples")
}

// ---- Cross-Match Test ----

model CrossMatchTest {
  id        String @id @default(cuid())
  requestId String
  request   BloodRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  sampleId String
  sample   PatientBloodSample @relation(fields: [sampleId], references: [id])

  bloodUnitId String
  bloodUnit   BloodUnit @relation(fields: [bloodUnitId], references: [id])

  method CrossMatchMethod
  result CrossMatchResult @default(PENDING)

  certificateNumber String? @db.VarChar(48)
  validUntil        DateTime? // 72 hours from test

  testedByStaffId  String?
  verifiedByStaffId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bloodIssues BloodIssue[]

  @@index([requestId, result])
  @@index([bloodUnitId])
  @@map("bb_cross_match_tests")
}

// ---- Blood Issue ----

model BloodIssue {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  issueNumber String @db.VarChar(48)

  bloodUnitId  String
  bloodUnit    BloodUnit @relation(fields: [bloodUnitId], references: [id])

  requestId    String
  request      BloodRequest @relation(fields: [requestId], references: [id])

  crossMatchId String?
  crossMatch   CrossMatchTest? @relation(fields: [crossMatchId], references: [id])

  issuedToWard    String? @db.VarChar(120)
  issuedToPerson  String? @db.VarChar(160)
  transportBoxTemp Decimal? @db.Decimal(4, 1)

  // Visual inspection checklist
  visualInspectionOk Boolean @default(true)
  inspectionNotes    String? @db.VarChar(500)

  issuedByStaffId String?
  issuedAt        DateTime @default(now())

  // Return tracking
  isReturned      Boolean   @default(false)
  returnedAt      DateTime?
  returnReason    String?   @db.VarChar(200)
  restockEligible Boolean?

  // Emergency/MTP flag
  isEmergencyIssue Boolean @default(false)
  mtpSessionId     String?
  mtpSession       MTPSession? @relation(fields: [mtpSessionId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transfusionRecord TransfusionRecord?

  @@unique([branchId, issueNumber])
  @@index([branchId, issuedAt])
  @@index([bloodUnitId])
  @@index([requestId])
  @@map("bb_blood_issues")
}

// ---- Transfusion Record ----

model TransfusionRecord {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  issueId String @unique
  issue   BloodIssue @relation(fields: [issueId], references: [id], onDelete: Cascade)

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  // Bedside verification
  bedsideVerifiedAt     DateTime?
  bedsideVerifier1StaffId String?
  bedsideVerifier2StaffId String?
  patientWristbandScan  Boolean @default(false)
  unitBarcodeScan       Boolean @default(false)
  bedsideVerificationOk Boolean?

  // Transfusion timing
  startedAt   DateTime?
  endedAt     DateTime?
  totalVolumeMl Int?

  // Vitals at intervals
  preVitals       Json? // { temp, bp, pulse }
  vitals15Min     Json?
  vitals30Min     Json?
  vitals1Hr       Json?
  postVitals      Json?

  // Reaction flag
  hasReaction Boolean @default(false)

  administeredByStaffId String?
  doctorNotifiedAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reactions TransfusionReaction[]

  @@index([patientId])
  @@map("bb_transfusion_records")
}

// ---- Transfusion Reaction ----

model TransfusionReaction {
  id               String @id @default(cuid())
  transfusionId    String
  transfusionRecord TransfusionRecord @relation(fields: [transfusionId], references: [id], onDelete: Cascade)

  reactionType     TransfusionReactionType
  severity         String  @db.VarChar(32) // MILD, MODERATE, SEVERE, LIFE_THREATENING
  onsetAt          DateTime?
  description      String? @db.VarChar(1000)

  // Management
  transfusionStopped Boolean @default(true)
  managementNotes    String? @db.VarChar(1000)

  // Investigation
  investigationResults Json? // { dct, repeat_grouping, cultures, haptoglobin, ... }
  rootCause            String? @db.VarChar(500)
  correctiveAction     String? @db.VarChar(500)

  reportedByStaffId String?
  investigatedByStaffId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([transfusionId])
  @@map("bb_transfusion_reactions")
}

// ---- Quality Control Record ----

model QualityControlRecord {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  recordType  String @db.VarChar(32) // IQC, EQAS, CALIBRATION
  testSystem  String @db.VarChar(120) // e.g., "Blood Grouping Gel Card", "HIV ELISA"

  equipmentId String?
  equipment   BloodBankEquipment? @relation(fields: [equipmentId], references: [id])

  // IQC specific
  qcLevel        String?  @db.VarChar(32) // LOW, NORMAL, HIGH
  expectedValue  String?  @db.VarChar(64)
  observedValue  String?  @db.VarChar(64)
  westgardResult String?  @db.VarChar(32) // PASS, FAIL, WARNING
  westgardRule   String?  @db.VarChar(32) // 1-2s, 1-3s, 2-2s, R4s, etc.

  // EQAS specific
  eqasCycleId    String? @db.VarChar(64)
  eqasProvider   String? @db.VarChar(120)
  eqasResult     String? @db.VarChar(32) // SATISFACTORY, UNSATISFACTORY

  // Calibration specific
  calibrationValues Json?
  calibrationPassFail String? @db.VarChar(16)

  correctiveAction String? @db.VarChar(500)

  performedByStaffId String?
  performedAt        DateTime @default(now())
  reviewedByStaffId  String?
  reviewedAt         DateTime?

  createdAt DateTime @default(now())

  @@index([branchId, recordType, performedAt])
  @@map("bb_qc_records")
}

// ---- Blood Donation Camp ----

model BloodDonationCamp {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  campCode     String   @db.VarChar(32)
  campDate     DateTime
  location     String   @db.VarChar(500)
  organizer    String   @db.VarChar(200)

  estimatedDonors Int?
  actualDonors    Int?
  unitsCollected  Int?

  teamAllocation Json? // [{ staffId, role }]
  equipmentChecklist Json? // [{ item, packed: bool, returned: bool }]

  status String @default("PLANNED") @db.VarChar(32) // PLANNED, IN_PROGRESS, COMPLETED, CANCELLED
  syncedAt DateTime?
  summary  Json? // post-camp summary data

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([branchId, campCode])
  @@index([branchId, status])
  @@map("bb_donation_camps")
}

// ---- Massive Transfusion Protocol Session ----

model MTPSession {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  patientId   String
  patient     Patient @relation(fields: [patientId], references: [id])
  encounterId String?

  activatedByStaffId   String?
  activatedAt          DateTime @default(now())
  deactivatedByStaffId String?
  deactivatedAt        DateTime?

  // Pack ratio config (e.g., 6 PRBC : 4 FFP : 1 SDP)
  packRatio Json? // { prbc: 6, ffp: 4, sdp: 1 }

  status String @default("ACTIVE") @db.VarChar(32) // ACTIVE, DEACTIVATED

  summary Json? // reconciliation summary

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bloodIssues BloodIssue[]

  @@index([branchId, status])
  @@index([patientId])
  @@map("bb_mtp_sessions")
}

// ---- MSBOS Configuration ----

model MSBOSConfig {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  procedureCode String @db.VarChar(48)
  procedureName String @db.VarChar(200)

  recommendedPRBC     Int @default(0)
  recommendedFFP      Int @default(0)
  recommendedPlatelet Int @default(0)
  recommendedCryo     Int @default(0)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([branchId, procedureCode])
  @@index([branchId, isActive])
  @@map("bb_msbos_configs")
}

// -----------------------------------------------------------------------------
// Central Notifications (Option B: separate Read vs Ack/Resolve)
// -----------------------------------------------------------------------------

enum NotificationSeverity {
  INFO
  WARNING
  CRITICAL
}

enum NotificationStatus {
  OPEN
  ACKNOWLEDGED
  RESOLVED
}

enum NotificationChannel {
  IN_APP
  EMAIL
  SMS
  WHATSAPP
}

enum NotificationDigest {
  NONE
  DAILY
  WEEKLY
}

model Notification {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  title   String  @db.VarChar(200)
  message String? @db.VarChar(2000)

  severity NotificationSeverity @default(INFO)
  status   NotificationStatus   @default(OPEN)

  // Where did this alert come from (e.g., BLOOD_BANK, IAM, BILLING)?
  source   String? @db.VarChar(64)
  entity   String? @db.VarChar(64)
  entityId String? @db.VarChar(64)

  // Free-form meta for the producer (safe for future expansion)
  meta Json?

  // Optional targeted user (NULL => branch-wide alert)
  toUserId String?
  toUser   User? @relation("NotificationToUser", fields: [toUserId], references: [id], onDelete: SetNull)

  // Ack/Resolve are operational actions (separate from read/unread)
  ackByUserId String?
  ackByUser   User? @relation("NotificationAckBy", fields: [ackByUserId], references: [id], onDelete: SetNull)
  ackAt       DateTime?

  resolvedByUserId String?
  resolvedByUser   User? @relation("NotificationResolvedBy", fields: [resolvedByUserId], references: [id], onDelete: SetNull)
  resolvedAt       DateTime?

  // De-duplication key to prevent spamming repeated alerts (producer-defined)
  dedupeKey String? @db.VarChar(200)

  // Useful tags for filtering in UI (Postgres text[])
  tags String[]

  reads NotificationRead[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([branchId, status, severity, createdAt])
  @@index([toUserId, status, createdAt])
  @@index([dedupeKey])
  @@map("notifications")
}

model NotificationRead {
  id             String       @id @default(cuid())
  notificationId String
  notification   Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  readAt DateTime @default(now())

  @@unique([notificationId, userId])
  @@index([userId, readAt])
  @@map("notification_reads")
}

model NotificationPreference {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  enabled     Boolean              @default(true)
  severityMin NotificationSeverity @default(INFO)
  channels    NotificationChannel[]
  digest      NotificationDigest   @default(NONE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("notification_preferences")
}

// -----------------------------------------------------------------------------
// Blood Bank: Transfers, Lookback, Report Runs (PRD completeness)
// -----------------------------------------------------------------------------

enum BloodUnitTransferStatus {
  INITIATED
  DISPATCHED
  RECEIVED
  REJECTED
  CANCELLED
}

model BloodUnitTransfer {
  id           String @id @default(cuid())
  fromBranchId String
  fromBranch   Branch @relation("BBTransferFromBranch", fields: [fromBranchId], references: [id], onDelete: Cascade)

  toBranchId String
  toBranch   Branch @relation("BBTransferToBranch", fields: [toBranchId], references: [id], onDelete: Cascade)

  status BloodUnitTransferStatus @default(INITIATED)

  courierName   String? @db.VarChar(120)
  courierRef    String? @db.VarChar(120)
  dispatchTempC Float?
  receivedTempC Float?
  notes         String? @db.VarChar(500)

  createdByUserId String?
  createdByUser   User? @relation("BBTransferCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  dispatchedByUserId String?
  dispatchedByUser   User? @relation("BBTransferDispatchedBy", fields: [dispatchedByUserId], references: [id], onDelete: SetNull)
  dispatchedAt       DateTime?

  receivedByUserId String?
  receivedByUser   User? @relation("BBTransferReceivedBy", fields: [receivedByUserId], references: [id], onDelete: SetNull)
  receivedAt       DateTime?

  items BloodUnitTransferItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([fromBranchId, status, createdAt])
  @@index([toBranchId, status, createdAt])
  @@map("bb_unit_transfers")
}

model BloodUnitTransferItem {
  id         String @id @default(cuid())
  transferId String
  transfer   BloodUnitTransfer @relation(fields: [transferId], references: [id], onDelete: Cascade)

  bloodUnitId String
  bloodUnit   BloodUnit @relation(fields: [bloodUnitId], references: [id], onDelete: Cascade)

  @@unique([transferId, bloodUnitId])
  @@index([bloodUnitId])
  @@map("bb_unit_transfer_items")
}

enum LookbackStatus {
  OPEN
  INVESTIGATING
  CLOSED
}

enum LookbackTriggerType {
  REACTIVE_TTI
  POST_ISSUE_REVIEW
  MANUAL
}

model BloodLookbackCase {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  status      LookbackStatus      @default(OPEN)
  triggerType LookbackTriggerType @default(MANUAL)

  donorId String?
  donor   Donor? @relation(fields: [donorId], references: [id], onDelete: SetNull)

  notes String? @db.VarChar(1000)

  // Stored snapshot (impacted units + recipients + any auto-quarantine actions)
  computedData Json?

  createdByUserId String?
  createdByUser   User? @relation("BBLookbackCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  closedByUserId String?
  closedByUser   User? @relation("BBLookbackClosedBy", fields: [closedByUserId], references: [id], onDelete: SetNull)
  closedAt       DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([branchId, status, createdAt])
  @@index([donorId])
  @@map("bb_lookback_cases")
}

enum BBReportType {
  DAILY_SUMMARY
  UTILIZATION
  DISCARD_ANALYSIS
  DONOR_DEFERRAL
  TTI_SEROPREVALENCE
  HAEMOVIGILANCE
  NACO_ANNUAL
  SBTC_QUARTERLY
}

enum BBReportRunStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

model BBReportRun {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  type   BBReportType
  status BBReportRunStatus @default(DRAFT)

  // report input parameters (date range, quarter, etc.)
  params Json?

  // computed report output stored for deterministic exports
  data Json?

  createdByUserId String?
  createdByUser   User? @relation("BBReportRunCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  submittedByUserId String?
  submittedByUser   User? @relation("BBReportRunSubmittedBy", fields: [submittedByUserId], references: [id], onDelete: SetNull)
  submittedAt       DateTime?

  approvedByUserId String?
  approvedByUser   User? @relation("BBReportRunApprovedBy", fields: [approvedByUserId], references: [id], onDelete: SetNull)
  approvedAt       DateTime?

  rejectedByUserId String?
  rejectedByUser   User? @relation("BBReportRunRejectedBy", fields: [rejectedByUserId], references: [id], onDelete: SetNull)
  rejectedAt       DateTime?
  rejectReason     String? @db.VarChar(500)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([branchId, type, status, createdAt])
  @@map("bb_report_runs")
}
