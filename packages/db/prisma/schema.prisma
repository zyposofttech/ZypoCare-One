generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated/client"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ConsentScope {
  VIEW
  STORE
  SHARE
}

enum ConsentStatus {
  GRANTED
  WITHDRAWN
}

enum RtbfStatus {
  REQUESTED
  IN_REVIEW
  APPROVED
  REJECTED
  FULFILLED
}

enum EncounterType {
  OPD
  IPD
  ER
}

enum FacilityCategory {
  SERVICE
  CLINICAL
  SUPPORT
}

enum BedState {
  VACANT
  OCCUPIED
  CLEANING
  MAINTENANCE
}

enum OutboxStatus {
  PENDING
  PROCESSING
  SENT
  FAILED
}

model Branch {
  id   String @id @default(cuid())
  code String @unique @db.VarChar(32)
  name String
  city String

  address       String? @db.VarChar(240)
  contactPhone1 String? @db.VarChar(20)
  contactPhone2 String? @db.VarChar(20)
  contactEmail  String? @db.VarChar(120)

  gstNumber String? @db.VarChar(15)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  departments Department[]
  users       User[]
  patients    Patient[]
  wards       Ward[]
  tariffPlans TariffPlan[]
  assets      Asset[]
  Specialty   Specialty[]
  Staff       Staff[]
  Encounter   Encounter[]
  Bed         Bed[]
  Admission   Admission[]

  // Facilities enabled for this branch (multi-select from FacilityCatalog)
  branchFacilities BranchFacility[]
  rooms            Room[]
  // Opposite relations (required for Prisma validation)
  statutoryCases   StatutoryCase[]
  auditEvents      AuditEvent[]

  // ✅ Policy Governance (opposite relations)
  policyVersions        PolicyVersion[]       @relation("PolicyVersion_Branch")
  policyVersionBranches PolicyVersionBranch[] @relation("PolicyTarget_Branch")

  // ---------------- Infrastructure (Setup Studio) ----------------
  locationNodes         LocationNode[]
  branchUnitTypes       BranchUnitType[]
  units                 Unit[]
  unitRooms             UnitRoom[]
  unitResources         UnitResource[]
  procedureBookings     ProcedureBooking[]
  equipmentAssets       EquipmentAsset[]
  chargeMasterItems     ChargeMasterItem[]
  serviceItems          ServiceItem[]
  serviceChargeMappings ServiceChargeMapping[]
  fixItTasks            FixItTask[]
  bulkImportJobs        BulkImportJob[]
  goLiveReports         GoLiveReport[]

  otSuites OtSuite[] @relation("OtSuite_Branch")

  infraConfig BranchInfraConfig?
}

model FacilityCatalog {
  id       String           @id @default(cuid())
  code     String           @unique @db.VarChar(48)
  name     String           @db.VarChar(160)
  category FacilityCategory

  isActive  Boolean @default(true)
  sortOrder Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Branch enablement (multi-select)
  branchLinks BranchFacility[]

  // Departments created under this facility
  departments Department[]

  @@index([category, isActive, sortOrder])
}

model BranchFacility {
  id String @id @default(cuid())

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  facilityId String
  facility   FacilityCatalog @relation(fields: [facilityId], references: [id], onDelete: Cascade)

  isEnabled Boolean  @default(true)
  enabledAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([branchId, facilityId])
  @@index([branchId, isEnabled])
  @@index([facilityId, isEnabled])
}

model Department {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  facilityId String
  facility   FacilityCatalog @relation(fields: [facilityId], references: [id])
  code       String
  name       String

  headStaffId String?
  headStaff   Staff?  @relation("DepartmentHead", fields: [headStaffId], references: [id], onDelete: SetNull)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  staff Staff[] @relation("DepartmentStaff")

  doctorAssignments DepartmentDoctor[]

  // ✅ Many-to-many link to specialties (single source of truth for mapping)
  departmentSpecialties DepartmentSpecialty[]

  // ---------------- Infrastructure (Setup Studio) ----------------
  units          Unit[]
  equipmentOwned EquipmentAsset[] @relation("EquipmentOwnerDepartment")

  @@unique([branchId, facilityId, code])
  @@index([branchId, facilityId, isActive])
}

model DepartmentDoctor {
  id String @id @default(cuid())

  departmentId String
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)

  isPrimary  Boolean  @default(false)
  assignedAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([departmentId, staffId])
  @@index([departmentId])
  @@index([staffId])
}

model DepartmentSpecialty {
  id String @id @default(cuid())

  departmentId String
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  specialtyId String
  specialty   Specialty @relation(fields: [specialtyId], references: [id], onDelete: Cascade)
  isPrimary   Boolean   @default(false)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([departmentId, specialtyId])
  @@index([departmentId, isActive])
  @@index([specialtyId, isActive])
}

model Specialty {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  code      String
  name      String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  staff Staff[]

  // ✅ Many-to-many link to departments
  departmentLinks DepartmentSpecialty[]

  @@unique([branchId, code])
}

model Staff {
  id           String      @id @default(cuid())
  branchId     String
  branch       Branch      @relation(fields: [branchId], references: [id])
  departmentId String?
  department   Department? @relation("DepartmentStaff", fields: [departmentId], references: [id])
  specialtyId  String?
  specialty    Specialty?  @relation(fields: [specialtyId], references: [id])

  empCode           String
  name              String
  designation       String
  phone             String?
  email             String?
  isActive          Boolean            @default(true)
  // Doctor assignment to departments (many-to-many)
  doctorAssignments DepartmentDoctor[]

  // Departments where this staff is Head of Department
  headedDepartments Department[] @relation("DepartmentHead")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User?

  @@unique([branchId, empCode])
}

model User {
  id    String @id @default(cuid())
  email String @unique
  name  String

  // Keep a simple role string for UI/back-compat (your code references this)
  role String @default("BRANCH_ADMIN")

  phone    String?
  branchId String?
  branch   Branch? @relation(fields: [branchId], references: [id])

  staffId String? @unique
  staff   Staff?  @relation(fields: [staffId], references: [id])

  isActive Boolean @default(true)

  passwordHash       String?
  mustChangePassword Boolean @default(false)

  passwordResetToken   String?              @unique
  passwordResetExpires DateTime?
  roleVersionId        String?
  roleVersion          RoleTemplateVersion? @relation("UserRoleVersion", fields: [roleVersionId], references: [id])

  createdRoleVersions RoleTemplateVersion[] @relation("RoleVersionCreatedBy")
  auditEventsAsActor  AuditEvent[]          @relation("AuditActor")

  // Policy governance opposite relations
  policyVersionsCreatedBy   PolicyVersion[] @relation("PolicyVersionCreatedBy")
  policyVersionsSubmittedBy PolicyVersion[] @relation("PolicyVersionSubmittedBy")
  policyVersionsApprovedBy  PolicyVersion[] @relation("PolicyVersionApprovedBy")
  policyVersionsRejectedBy  PolicyVersion[] @relation("PolicyVersionRejectedBy")
  policyVersionsRetiredBy   PolicyVersion[] @relation("PolicyVersionRetiredBy")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ---------------- Infrastructure (Setup Studio) ----------------
  createdLocationRevisions LocationNodeRevision[] @relation("LocationRevisionCreatedBy")
  createdImportJobs        BulkImportJob[]        @relation("ImportJobCreatedBy")
  assignedFixIts           FixItTask[]            @relation("FixItAssignedTo")
  createdBookings          ProcedureBooking[]     @relation("BookingCreatedBy")
  createdGoLiveReports     GoLiveReport[]         @relation("GoLiveCreatedBy")
}

model Patient {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  uhid    String
  name    String
  gender  String?
  dob     DateTime?
  phone   String?
  email   String?
  address String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  encounters Encounter[]
  Admission  Admission[]

  // Opposite relations (required for Prisma validation)
  consentRecords ConsentRecord[]
  rtbfRequests   RtbfRequest[]
  statutoryCases StatutoryCase[]

  @@unique([branchId, uhid])
}

model Encounter {
  id        String  @id @default(cuid())
  branchId  String
  branch    Branch  @relation(fields: [branchId], references: [id])
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  type      EncounterType
  startedAt DateTime      @default(now())
  endedAt   DateTime?
  status    String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  admissions Admission[]
}

model Ward {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  code      String
  name      String
  specialty String?
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  rooms Room[]

  @@unique([branchId, code])
}

model Room {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])
  wardId   String
  ward     Ward   @relation(fields: [wardId], references: [id])

  code     String
  name     String
  floor    String?
  type     String?
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  beds Bed[]

  @@unique([wardId, code])
  @@index([branchId, wardId, isActive])
}

model Bed {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])
  roomId   String
  room     Room   @relation(fields: [roomId], references: [id])

  code     String
  state    BedState @default(VACANT)
  isActive Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  admissions Admission[]

  @@unique([roomId, code])
  @@index([branchId, roomId, isActive])
}

model Admission {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  encounterId String?
  encounter   Encounter? @relation(fields: [encounterId], references: [id])

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  bedId String?
  bed   Bed?    @relation(fields: [bedId], references: [id])

  admittedAt   DateTime  @default(now())
  dischargedAt DateTime?
  status       String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Asset {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  code      String
  name      String
  category  String
  location  String?
  status    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([branchId, code])
}

model TariffPlan {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  code   String
  name   String
  status String

  // Fields your billing controller expects
  payerType     String
  effectiveFrom DateTime
  effectiveTo   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations your billing controller expects
  rates TariffRate[]

  @@unique([branchId, code])
  @@index([branchId, effectiveFrom])
}

model ServiceCatalogItem {
  id        String   @id @default(cuid())
  code      String   @unique
  name      String
  category  String
  unit      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TariffRate {
  id           String     @id @default(cuid())
  tariffPlanId String
  tariffPlan   TariffPlan @relation(fields: [tariffPlanId], references: [id], onDelete: Cascade)

  serviceCode String
  amount      Decimal @db.Decimal(12, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tariffPlanId, serviceCode])
  @@index([tariffPlanId])
}

model ConsentRecord {
  id        String  @id @default(cuid())
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  scope   ConsentScope
  purpose String
  status  ConsentStatus @default(GRANTED)

  createdAt DateTime @default(now())

  @@index([patientId, createdAt])
}

model RtbfRequest {
  id        String  @id @default(cuid())
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  reason String
  status RtbfStatus @default(REQUESTED)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, createdAt])
  @@index([patientId, createdAt])
}

model StatutoryCase {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  program String
  disease String
  status  String @default("DRAFT")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([branchId, updatedAt])
  @@index([program, updatedAt])
  @@index([patientId, updatedAt])
}

model AuditEvent {
  id String @id @default(cuid())

  branchId String?
  branch   Branch? @relation(fields: [branchId], references: [id], onDelete: SetNull)

  actorUserId String?
  actorUser   User?   @relation("AuditActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  action   String
  entity   String
  entityId String?
  meta     Json?

  createdAt DateTime @default(now())

  @@index([branchId, createdAt])
  @@index([actorUserId, createdAt])
  @@index([action, createdAt])
  @@index([entity, entityId])
}

model OutboxEvent {
  id          String       @id @default(cuid())
  topic       String
  key         String?
  payload     Json
  status      OutboxStatus @default(PENDING)
  attempts    Int          @default(0)
  availableAt DateTime     @default(now())
  lockedAt    DateTime?
  sentAt      DateTime?
  error       String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([status, availableAt])
}

enum RoleScope {
  GLOBAL
  BRANCH
}

enum RoleVersionStatus {
  DRAFT
  ACTIVE
  RETIRED
}

model Permission {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  category    String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  roleGrants RoleTemplatePermission[]
}

model RoleTemplate {
  id          String    @id @default(cuid())
  code        String    @unique
  name        String
  scope       RoleScope @default(BRANCH)
  description String?
  isSystem    Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  versions RoleTemplateVersion[]
}

model RoleTemplateVersion {
  id             String            @id @default(cuid())
  roleTemplateId String
  roleTemplate   RoleTemplate      @relation(fields: [roleTemplateId], references: [id])
  version        Int
  status         RoleVersionStatus @default(DRAFT)
  notes          String?

  createdByUserId String?
  createdByUser   User?   @relation("RoleVersionCreatedBy", fields: [createdByUserId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  permissions RoleTemplatePermission[]

  // NAME THIS RELATION TOO (users assigned to this role version)
  users User[] @relation("UserRoleVersion")

  @@unique([roleTemplateId, version])
}

model RoleTemplatePermission {
  id            String              @id @default(cuid())
  roleVersionId String
  roleVersion   RoleTemplateVersion @relation(fields: [roleVersionId], references: [id])
  permissionId  String
  permission    Permission          @relation(fields: [permissionId], references: [id])

  // allow/deny flag for future; keep allow-only for now
  allowed Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([roleVersionId, permissionId])
}

// ---------------------------------------------------------------------------
// Policy Governance (global baselines + branch overrides with maker-checker)
// ---------------------------------------------------------------------------

enum PolicyScope {
  GLOBAL
  BRANCH_OVERRIDE
}

enum PolicyVersionStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  RETIRED
}

model PolicyDefinition {
  id          String  @id @default(cuid())
  code        String  @unique
  name        String
  type        String
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Canonical versions for this definition
  versions PolicyVersion[] @relation("PolicyDefinitionVersions")
}

model PolicyVersion {
  id String @id @default(cuid())

  // FK to the policy definition catalog (governance.service.ts expects this)
  policyId String
  policy   PolicyDefinition @relation("PolicyDefinitionVersions", fields: [policyId], references: [id])
  scope    PolicyScope      @default(GLOBAL)
  branchId String?
  branch   Branch?          @relation("PolicyVersion_Branch", fields: [branchId], references: [id], onDelete: SetNull)

  version Int
  status  PolicyVersionStatus @default(DRAFT)

  effectiveAt DateTime @default(now())
  notes       String?
  payload     Json

  applyToAllBranches Boolean               @default(true)
  branches           PolicyVersionBranch[]

  createdByUserId String?
  createdByUser   User?   @relation("PolicyVersionCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  submittedAt       DateTime?
  submittedByUserId String?
  submittedByUser   User?     @relation("PolicyVersionSubmittedBy", fields: [submittedByUserId], references: [id], onDelete: SetNull)

  approvedAt       DateTime?
  approvedByUserId String?
  approvedByUser   User?     @relation("PolicyVersionApprovedBy", fields: [approvedByUserId], references: [id], onDelete: SetNull)
  approvalNote     String?

  rejectedAt       DateTime?
  rejectedByUserId String?
  rejectedByUser   User?     @relation("PolicyVersionRejectedBy", fields: [rejectedByUserId], references: [id], onDelete: SetNull)
  rejectionReason  String?

  retiredAt       DateTime?
  retiredByUserId String?
  retiredByUser   User?     @relation("PolicyVersionRetiredBy", fields: [retiredByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // NOTE: We intentionally model the relation via policyId.
  // Any legacy/experimental policyDefinitionId field was removed to keep the schema unambiguous.

  @@index([policyId, scope, status])
  @@index([branchId, status])
  @@index([policyId, scope, version])
  @@index([policyId, branchId, version])
}

model PolicyVersionBranch {
  id              String        @id @default(cuid())
  policyVersionId String
  policyVersion   PolicyVersion @relation(fields: [policyVersionId], references: [id], onDelete: Cascade)

  branchId String
  branch   Branch @relation("PolicyTarget_Branch", fields: [branchId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([policyVersionId, branchId])
  @@index([branchId])
}

// ---------------------------------------------------------------------------
// Infrastructure / Setup Studio (Admin Branch Onboarding)
// ---------------------------------------------------------------------------

enum LocationKind {
  CAMPUS
  BUILDING
  FLOOR
  ZONE
}

model LocationNode {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  kind     LocationKind
  parentId String?
  parent   LocationNode?  @relation("LocationTree", fields: [parentId], references: [id])
  children LocationNode[] @relation("LocationTree")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Units mapped to this location node
  units     Unit[]
  revisions LocationNodeRevision[]
  // OT Setup mappings
  otSuites  OtSuite[]              @relation("OtSuite_LocationNode")
  otSpaces  OtSpace[]              @relation("OtSpace_LocationNode")

  @@index([branchId, kind])
  @@index([branchId, parentId])
}

model LocationNodeRevision {
  id     String       @id @default(cuid())
  nodeId String
  node   LocationNode @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  code     String
  name     String
  isActive Boolean @default(true)

  effectiveFrom DateTime
  effectiveTo   DateTime?

  createdByUserId String?
  createdByUser   User?   @relation("LocationRevisionCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([nodeId, effectiveFrom])
  @@index([code])
}

// ---------------- Unit Types Enablement ----------------

model UnitTypeCatalog {
  id   String @id @default(cuid())
  code String @unique @db.VarChar(32)
  name String @db.VarChar(120)

  usesRoomsDefault     Boolean @default(true)
  schedulableByDefault Boolean @default(false)

  isActive  Boolean @default(true)
  sortOrder Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  branchLinks BranchUnitType[]
  units       Unit[]

  @@index([isActive, sortOrder])
}

model BranchUnitType {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  unitTypeId String
  unitType   UnitTypeCatalog @relation(fields: [unitTypeId], references: [id], onDelete: Cascade)

  isEnabled Boolean   @default(true)
  enabledAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([branchId, unitTypeId], name: "branchId_unitTypeId")
  @@index([branchId, isEnabled])
}

// ---------------- Units / Rooms / Resources ----------------

enum UnitResourceType {
  BED
  BAY
  CHAIR
  OT_TABLE
  PROCEDURE_TABLE
  DIALYSIS_STATION
  RECOVERY_BAY
  EXAM_SLOT
  INCUBATOR
}

enum UnitResourceState {
  AVAILABLE
  OCCUPIED
  CLEANING
  MAINTENANCE
  INACTIVE
}

model Unit {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  // Location binding: unit belongs to a specific location node under the same branch
  locationNodeId String?
  locationNode   LocationNode? @relation(fields: [locationNodeId], references: [id], onDelete: Restrict)

  departmentId String
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Restrict)

  unitTypeId String
  unitType   UnitTypeCatalog @relation(fields: [unitTypeId], references: [id], onDelete: Restrict)

  code String @db.VarChar(32)
  name String @db.VarChar(160)

  usesRooms Boolean @default(true)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  rooms     UnitRoom[]
  resources UnitResource[]
  bookings  ProcedureBooking[]

  @@unique([branchId, code], name: "branchId_unitCode")
  @@index([branchId, departmentId, isActive])
  @@index([branchId, locationNodeId, isActive])
}

model UnitRoom {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  unitId String
  unit   Unit   @relation(fields: [unitId], references: [id], onDelete: Cascade)

  code String @db.VarChar(64)
  name String @db.VarChar(160)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  resources UnitResource[]

  @@unique([unitId, code], name: "unitId_roomCode")
  @@index([branchId, unitId, isActive])
}

model UnitResource {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  unitId String
  unit   Unit   @relation(fields: [unitId], references: [id], onDelete: Cascade)

  roomId String?
  room   UnitRoom? @relation(fields: [roomId], references: [id], onDelete: SetNull)

  resourceType UnitResourceType
  code         String           @db.VarChar(96)
  name         String           @db.VarChar(160)

  state         UnitResourceState @default(AVAILABLE)
  isActive      Boolean           @default(true)
  isSchedulable Boolean           @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bookings ProcedureBooking[]

  @@unique([unitId, code], name: "unitId_resourceCode")
  @@index([branchId, unitId, isActive])
  @@index([branchId, resourceType, isSchedulable])
}

model BranchInfraConfig {
  id       String @id @default(cuid())
  branchId String @unique
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  housekeepingGateEnabled Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ---------------- Equipment Register ----------------

enum EquipmentCategory {
  GENERAL
  RADIOLOGY
  ULTRASOUND
}

enum EquipmentOperationalStatus {
  OPERATIONAL
  DOWN
  MAINTENANCE
  RETIRED
}

model EquipmentAsset {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  code String @db.VarChar(64)
  name String @db.VarChar(160)

  category EquipmentCategory @default(GENERAL)

  make   String?
  model  String?
  serial String?

  ownerDepartmentId String?
  ownerDepartment   Department? @relation("EquipmentOwnerDepartment", fields: [ownerDepartmentId], references: [id], onDelete: SetNull)

  unitId         String?
  roomId         String?
  locationNodeId String?

  operationalStatus EquipmentOperationalStatus @default(OPERATIONAL)

  amcVendor       String?
  amcValidFrom    DateTime?
  amcValidTo      DateTime?
  warrantyValidTo DateTime?

  pmFrequencyDays Int?
  nextPmDueAt     DateTime?

  aerbLicenseNo String?
  aerbValidTo   DateTime?

  pcpndtRegNo   String?
  pcpndtValidTo DateTime?

  isSchedulable Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  downtimeTickets DowntimeTicket[]

  @@unique([branchId, code], name: "branchId_equipmentCode")
  @@index([branchId, category])
}

enum DowntimeStatus {
  OPEN
  CLOSED
}

model DowntimeTicket {
  id      String         @id @default(cuid())
  assetId String
  asset   EquipmentAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  reason String
  notes  String?
  status DowntimeStatus @default(OPEN)

  openedAt DateTime  @default(now())
  closedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([assetId, status])
}

// ---------------- Service Catalog + Charge Master + Mapping ----------------

model ChargeMasterItem {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  code String @db.VarChar(48)
  name String @db.VarChar(160)

  category String?
  unit     String?
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  mappings ServiceChargeMapping[]

  @@unique([branchId, code], name: "branchId_code")
  @@index([branchId, isActive])
}

model ServiceItem {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  code String @db.VarChar(48)
  name String @db.VarChar(160)

  category String  @db.VarChar(80)
  unit     String?

  isOrderable Boolean @default(true)
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  mappings ServiceChargeMapping[]
  fixIts   FixItTask[]

  @@unique([branchId, code], name: "branchId_serviceCode")
  @@index([branchId, category, isActive])
}

model ServiceChargeMapping {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  serviceItemId String
  serviceItem   ServiceItem @relation(fields: [serviceItemId], references: [id], onDelete: Cascade)

  chargeMasterItemId String
  chargeMasterItem   ChargeMasterItem @relation(fields: [chargeMasterItemId], references: [id], onDelete: Cascade)

  effectiveFrom DateTime
  effectiveTo   DateTime?
  version       Int       @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([branchId, serviceItemId, effectiveFrom])
}

// ---------------- Fix-It Queue ----------------

enum FixItTaskType {
  SERVICE_CHARGE_MAPPING_MISSING
}

enum FixItStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  DISMISSED
}

model FixItTask {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  type   FixItTaskType
  status FixItStatus   @default(OPEN)

  title   String
  details Json?

  serviceItemId String?
  serviceItem   ServiceItem? @relation(fields: [serviceItemId], references: [id], onDelete: SetNull)

  assignedToUserId String?
  assignedToUser   User?   @relation("FixItAssignedTo", fields: [assignedToUserId], references: [id], onDelete: SetNull)

  resolvedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([branchId, status])
}

// ---------------- Bulk Import Jobs ----------------

enum BulkImportStatus {
  VALIDATED
  COMMITTED
  FAILED
}

enum BulkImportEntityType {
  LOCATIONS
  UNITS
  ROOMS
  RESOURCES
  EQUIPMENT
  SERVICE_ITEMS
  CHARGE_MASTER
}

model BulkImportJob {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  entityType BulkImportEntityType
  status     BulkImportStatus     @default(VALIDATED)

  fileName String?

  payload Json
  errors  Json?

  totalRows   Int
  validRows   Int
  invalidRows Int

  committedAt DateTime?

  createdByUserId String?
  createdByUser   User?   @relation("ImportJobCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([branchId, entityType, status])
}

// ---------------- Scheduling (OT / Procedure-capable Units) ----------------

enum BookingStatus {
  SCHEDULED
  CANCELLED
  COMPLETED
}

model ProcedureBooking {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  unitId String
  unit   Unit   @relation(fields: [unitId], references: [id], onDelete: Cascade)

  resourceId String
  resource   UnitResource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  patientId    String?
  departmentId String?

  startAt DateTime
  endAt   DateTime
  status  BookingStatus @default(SCHEDULED)

  consentOk    Boolean @default(false)
  anesthesiaOk Boolean @default(false)
  checklistOk  Boolean @default(false)

  createdByUserId String?
  createdByUser   User?   @relation("BookingCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  cancelledAt DateTime?

  createdAt DateTime @default(now())

  @@index([branchId, resourceId, startAt, endAt])
  @@index([branchId, unitId, startAt])
}

// ---------------- Go-Live Validator Snapshot ----------------

model GoLiveReport {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  score    Int
  blockers Json
  warnings Json
  snapshot Json

  createdByUserId String?
  createdByUser   User?   @relation("GoLiveCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([branchId, createdAt])
}

// =========================
// Operation Theatre Setup
// =========================

enum OtSuiteStatus {
  draft
  ready
  active
  booked
  in_use
  maintenance
  archived
}

enum OtSpaceType {
  THEATRE
  RECOVERY_BAY
  PREOP_HOLDING
  INDUCTION_ROOM
  SCRUB_ROOM
  STERILE_STORE
  ANESTHESIA_STORE
  EQUIPMENT_STORE
  STAFF_CHANGE
  OTHER
}

enum OtTheatreType {
  GENERAL
  MODULAR
  LAMINAR
  HYBRID
}

enum OtAirflowType {
  STANDARD
  LAMINAR
}

enum OtPressureType {
  POSITIVE
  NEGATIVE
  NEUTRAL
}

enum OtEquipmentCategory {
  ANESTHESIA_MACHINE
  AIRWAY_MANAGEMENT
  VENTILATION_RESPIRATORY
  PATIENT_MONITORING
  HEMODYNAMIC_MONITORING
  SURGICAL_INSTRUMENTS
  OR_FURNITURE
  OR_LIGHTING
  ELECTROSURGERY_ENERGY
  ENDOSCOPY_LAPAROSCOPY
  IMAGING_INTRAOP
  STERILIZATION_CSSD
  DISINFECTION_CLEANING
  STERILE_STORAGE_PACKAGING
  MEDICAL_GASES
  SUCTION_SYSTEMS
  POWER_BACKUP
  PATIENT_WARMING
  DVT_PROPHYLAXIS
  SAFETY_EMERGENCY
  RECOVERY_PACU_EQUIPMENT
  IT_AV_EQUIPMENT
  CONSUMABLES_DISPOSABLES
  OTHER
}

model OtSuite {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation("OtSuite_Branch", fields: [branchId], references: [id])

  // Optional: link suite to a location node representing OT complex area (floor/wing)
  locationNodeId String?
  locationNode   LocationNode? @relation("OtSuite_LocationNode", fields: [locationNodeId], references: [id])

  code   String
  name   String
  status OtSuiteStatus @default(draft)

  // Suite-level config (turnaround time, cleaning time, min recovery bays, etc.)
  config Json?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  spaces    OtSpace[]
  equipment OtEquipment[]

  @@unique([branchId, code])
  @@index([branchId])
  @@index([locationNodeId])
}

model OtSpace {
  id      String  @id @default(cuid())
  suiteId String
  suite   OtSuite @relation(fields: [suiteId], references: [id], onDelete: Cascade)

  type OtSpaceType
  code String
  name String

  // Optional: map each OT space to a specific LocationNode (room) in your location tree
  locationNodeId String?
  locationNode   LocationNode? @relation("OtSpace_LocationNode", fields: [locationNodeId], references: [id])

  notes String?
  meta  Json?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  theatre     OtTheatre?
  recoveryBay OtRecoveryBay?
  equipment   OtEquipment[]

  @@unique([suiteId, code])
  @@index([suiteId, type])
  @@index([locationNodeId])
}

model OtTheatre {
  id      String  @id @default(cuid())
  spaceId String  @unique
  space   OtSpace @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  theatreType OtTheatreType  @default(GENERAL)
  airflow     OtAirflowType  @default(STANDARD)
  pressure    OtPressureType @default(POSITIVE)

  // Optional classification fields (keep flexible for later)
  isoClass String?
  meta     Json?

  // If your DB is Postgres, String[] is fine. Otherwise switch to Json.
  specialtyCodes String[] @default([])

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tables OtTable[]

  @@index([spaceId])
}

model OtRecoveryBay {
  id      String  @id @default(cuid())
  spaceId String  @unique
  space   OtSpace @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  bedCount     Int @default(1)
  monitorCount Int @default(0)
  oxygenPoints Int @default(0)

  meta Json?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OtTable {
  id        String    @id @default(cuid())
  theatreId String
  theatre   OtTheatre @relation(fields: [theatreId], references: [id], onDelete: Cascade)

  code      String
  name      String
  isPrimary Boolean @default(true)

  manufacturer String?
  model        String?
  serialNo     String?
  installedAt  DateTime?

  meta Json?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([theatreId, code])
  @@index([theatreId])
}

model OtEquipment {
  id String @id @default(cuid())

  suiteId String
  suite   OtSuite @relation(fields: [suiteId], references: [id], onDelete: Cascade)

  // Optional: assign equipment to a specific OT space (theatre/recovery/etc.)
  spaceId String?
  space   OtSpace? @relation(fields: [spaceId], references: [id], onDelete: SetNull)

  category OtEquipmentCategory @default(OTHER)
  name     String
  qty      Int                 @default(1)

  manufacturer String?
  model        String?
  serialNo     String?

  lastServiceAt           DateTime?
  nextServiceAt           DateTime?
  maintenanceIntervalDays Int?

  meta Json?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([suiteId, category])
  @@index([spaceId])
}

// ================================
// Diagnostics Configuration (Lab + Imaging)
// Merge into your main schema.prisma
// ================================

enum DiagnosticKind {
  LAB
  IMAGING
  PROCEDURE
}

enum DiagnosticResultDataType {
  NUMERIC
  TEXT
  BOOLEAN
  CHOICE
}

enum DiagnosticTemplateKind {
  IMAGING_REPORT
  LAB_REPORT
}

model DiagnosticSection {
  id        String   @id @default(cuid())
  branchId  String
  code      String
  name      String
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  categories DiagnosticCategory[]
  items      DiagnosticItem[]

  @@unique([branchId, code])
  @@index([branchId, isActive])
}

model DiagnosticCategory {
  id        String   @id @default(cuid())
  branchId  String
  sectionId String
  code      String
  name      String
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  section DiagnosticSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  items   DiagnosticItem[]

  @@unique([branchId, code])
  @@index([branchId, sectionId, isActive])
}

model SpecimenType {
  id            String   @id @default(cuid())
  branchId      String
  code          String
  name          String
  container     String?
  minVolumeMl   Float?
  handlingNotes String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  items DiagnosticItem[]

  @@unique([branchId, code])
  @@index([branchId, isActive])
}

model DiagnosticItem {
  id       String         @id @default(cuid())
  branchId String
  code     String
  name     String
  kind     DiagnosticKind

  // taxonomy
  sectionId  String
  categoryId String?

  // lab
  specimenId     String?
  tatMinsRoutine Int?
  tatMinsStat    Int?

  // imaging/procedure
  requiresAppointment Boolean @default(false)
  preparationText     String?
  consentRequired     Boolean @default(false)

  // panels
  isPanel Boolean @default(false)

  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  section  DiagnosticSection   @relation(fields: [sectionId], references: [id], onDelete: Restrict)
  category DiagnosticCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  specimen SpecimenType?       @relation(fields: [specimenId], references: [id], onDelete: SetNull)

  // panel composition
  panelChildren DiagnosticPanelItem[] @relation("PanelParent")
  panelParents  DiagnosticPanelItem[] @relation("PanelChild")

  // lab results
  parameters DiagnosticParameter[]

  // templates
  templates DiagnosticTemplate[]

  // billing
  chargeMaps DiagnosticChargeMap[]

  @@unique([branchId, code])
  @@index([branchId, kind, isActive])
  @@index([branchId, sectionId, categoryId])
}

model DiagnosticPanelItem {
  id        String   @id @default(cuid())
  panelId   String
  itemId    String
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  panel DiagnosticItem @relation("PanelParent", fields: [panelId], references: [id], onDelete: Cascade)
  item  DiagnosticItem @relation("PanelChild", fields: [itemId], references: [id], onDelete: Restrict)

  @@unique([panelId, itemId])
  @@index([panelId, isActive])
}

model DiagnosticParameter {
  id          String                   @id @default(cuid())
  testId      String
  code        String
  name        String
  dataType    DiagnosticResultDataType
  unit        String?
  precision   Int? // decimals
  allowedText String? // for CHOICE: comma separated values (simple MVP)

  // critical thresholds (for NUMERIC)
  criticalLow  Float?
  criticalHigh Float?

  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  test   DiagnosticItem             @relation(fields: [testId], references: [id], onDelete: Cascade)
  ranges DiagnosticReferenceRange[]

  @@unique([testId, code])
  @@index([testId, isActive])
}

model DiagnosticReferenceRange {
  id          String @id @default(cuid())
  parameterId String

  // demographics
  sex        String? // M/F/O or null
  ageMinDays Int?
  ageMaxDays Int?

  // range
  low       Float?
  high      Float?
  textRange String?

  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  parameter DiagnosticParameter @relation(fields: [parameterId], references: [id], onDelete: Cascade)

  @@index([parameterId, isActive])
}

model DiagnosticTemplate {
  id        String                 @id @default(cuid())
  itemId    String
  kind      DiagnosticTemplateKind @default(IMAGING_REPORT)
  name      String
  body      String
  isActive  Boolean                @default(true)
  createdAt DateTime               @default(now())
  updatedAt DateTime               @updatedAt

  item DiagnosticItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId, kind, isActive])
}

model DiagnosticChargeMap {
  id               String @id @default(cuid())
  branchId         String
  diagnosticItemId String

  // Billing mapping (adapt relation name to your charge master model)
  chargeMasterId String
  price          Float?

  effectiveFrom DateTime?
  effectiveTo   DateTime?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  diagnosticItem DiagnosticItem @relation(fields: [diagnosticItemId], references: [id], onDelete: Cascade)

  @@unique([branchId, diagnosticItemId, chargeMasterId])
  @@index([branchId, isActive])
  @@index([diagnosticItemId, isActive])
}
