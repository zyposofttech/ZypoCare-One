generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated/client"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  //directUrl = env("DIRECT_URL")
}

enum ConsentScope {
  VIEW
  STORE
  SHARE
}

enum ConsentStatus {
  GRANTED
  WITHDRAWN
}

enum RtbfStatus {
  REQUESTED
  IN_REVIEW
  APPROVED
  REJECTED
  FULFILLED
}

enum EncounterType {
  OPD
  IPD
  ER
}

enum FacilityCategory {
  SERVICE
  CLINICAL
  SUPPORT
}

enum SpecialtyKind {
  SPECIALTY
  SUPER_SPECIALTY
}

enum BedState {
  VACANT
  OCCUPIED
  CLEANING
  MAINTENANCE
}

enum OutboxStatus {
  PENDING
  PROCESSING
  SENT
  FAILED
}

// ---------------- Service Catalog (Orderables) ----------------

enum CareContext {
  OPD
  IPD
  ER
  OT
  DAYCARE
  TELECONSULT
  HOMECARE
}

enum ServiceItemType {
  DIAGNOSTIC_LAB
  DIAGNOSTIC_IMAGING
  PROCEDURE
  NURSING
  THERAPY
  BED_CHARGE
  ADMIN
  PACKAGE
  OTHER
}

enum ServiceItemLifecycleStatus {
  DRAFT
  IN_REVIEW
  APPROVED
  PUBLISHED
  DEPRECATED
}

enum ServiceCatalogueScope {
  ENTERPRISE
  BRANCH
}

enum ServiceCatalogueStatus {
  DRAFT
  IN_REVIEW
  APPROVED
  PUBLISHED
  RETIRED
}

enum CatalogueChannel {
  DEFAULT
  QUICK_ORDER
  ORDER_SET
  OT_PICKLIST
}

enum ResourceRequirementKind {
  UNIT_RESOURCE_TYPE
  EQUIPMENT_TAG
  SERVICE_POINT_TAG
}

model Organization {
  id   String @id @default(cuid())
  code String @unique @db.VarChar(32)
  name String @db.VarChar(160)

  isActive Boolean @default(true)

  branches Branch[]
  staff    Staff[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
}

model Branch {
  id   String @id @default(cuid())
  code String @unique @db.VarChar(32)
  name String
  city String

  // Organization (hospital group / chain)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  // Soft lifecycle toggle (preferred over delete)
  isActive Boolean @default(true)

  // ---- Required identity/legal (enforced at API layer; DB allows null for backfill) ----
  legalEntityName String? @db.VarChar(160)

  // Address (store as full text + PIN; keep city separately for quick filtering)
  address String? @db.VarChar(240)
  pinCode String? @db.VarChar(10)
  state   String? @db.VarChar(80)
  country String? @db.VarChar(80)

  // Contact
  contactPhone1 String? @db.VarChar(20)
  contactPhone2 String? @db.VarChar(20)
  contactEmail  String? @db.VarChar(120)

  // Statutory / registrations
  gstNumber            String? @db.VarChar(15)
  panNumber            String? @db.VarChar(10)
  clinicalEstRegNumber String? @db.VarChar(64)
  rohiniId             String? @db.VarChar(64)
  hfrId                String? @db.VarChar(64) // ABDM (auto-populated after registration)

  // Optional branding + public links
  logoUrl         String?   @db.VarChar(500)
  website         String?   @db.VarChar(200)
  socialLinks     Json?
  accreditations  Json? // e.g. ["NABH","JCI"]
  bedCount        Int?
  establishedDate DateTime?

  // Branch settings (defaults are India-centric but configurable)
  defaultCurrency      String  @default("INR") @db.VarChar(8)
  timezone             String  @default("Asia/Kolkata") @db.VarChar(64)
  fiscalYearStartMonth Int     @default(4)
  workingHours         Json? // flexible schema for future (text or structured)
  emergency24x7        Boolean @default(true)
  multiLanguageSupport Boolean @default(false)
  supportedLanguages   Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  departments                Department[]
  users                      User[]
  patients                   Patient[]
  wards                      Ward[]
  tariffPlans                TariffPlan[]
  // Advanced billing setup (branch-scoped)
  taxCodes                   TaxCode[]
  payers                     Payer[]
  payerContracts             PayerContract[]
  assets                     Asset[]
  specialties                Specialty[]
  homeStaff                  Staff[]                     @relation("StaffHomeBranch")
  primaryStaff               Staff[]                     @relation("StaffPrimaryBranch")
  staffAssignments           StaffAssignment[]
  userRoleBindings           UserRoleBinding[]
  staffDocuments             StaffDocument[]
  staffProviderProfiles      StaffProviderProfile[]
  staffPrivilegeGrants       StaffPrivilegeGrant[]
  staffOnboardingItems       StaffOnboardingItem[]
  staffCompliancePacks       StaffCompliancePack[]
  staffComplianceAssignments StaffComplianceAssignment[]

  // HR Ops / Workforce Management
  staffRosters       StaffRoster[]
  staffAttendances   StaffAttendance[]
  staffLeaveRequests StaffLeaveRequest[]
  staffTrainings     StaffTrainingRecord[]
  staffAppraisals    StaffAppraisal[]
  staffSeparations   StaffSeparation[]
  Encounter          Encounter[]
  Bed                Bed[]
  Admission          Admission[]

  // Facilities enabled for this branch (multi-select from FacilityCatalog)
  branchFacilities BranchFacility[]
  rooms            Room[]
  // Opposite relations (required for Prisma validation)
  statutoryCases   StatutoryCase[]
  auditEvents      AuditEvent[]

  // ✅ Policy Governance (opposite relations)
  policyVersions        PolicyVersion[]       @relation("PolicyVersion_Branch")
  policyVersionBranches PolicyVersionBranch[] @relation("PolicyTarget_Branch")

  // ---------------- Infrastructure (Setup Studio) ----------------
  locationNodes           LocationNode[]
  branchUnitTypes         BranchUnitType[]
  units                   Unit[]
  unitRooms               UnitRoom[]
  unitResources           UnitResource[]
  procedureBookings       ProcedureBooking[]
  equipmentAssets         EquipmentAsset[]
  chargeMasterItems       ChargeMasterItem[]
  serviceItems            ServiceItem[]
  serviceCatalogues       ServiceCatalogue[]
  serviceChargeMappings   ServiceChargeMapping[]
  fixItTasks              FixItTask[]
  bulkImportJobs          BulkImportJob[]
  goLiveReports           GoLiveReport[]
  diagnosticServicePoints DiagnosticServicePoint[]
  diagnosticCapabilities  DiagnosticCapability[]

  otSuites OtSuite[] @relation("OtSuite_Branch")

  infraConfig                 BranchInfraConfig?
  EquipmentPlacement          EquipmentPlacement[]
  EquipmentMovement           EquipmentMovement[]
  EquipmentDocument           EquipmentDocument[]
  EquipmentContract           EquipmentContract[]
  EquipmentMaintenanceTask    EquipmentMaintenanceTask[]
  EquipmentComplianceEvidence EquipmentComplianceEvidence[]
  GovernedChangeRequest       GovernedChangeRequest[]
  ServicePackage              ServicePackage[]
  OrderSet                    OrderSet[]
  ServiceItemStandardMapping  ServiceItemStandardMapping[]
  ServiceAvailabilityCalendar ServiceAvailabilityCalendar[]
  ExternalDirectorySource     ExternalDirectorySource[]
  ExternalDirectoryMapping    ExternalDirectoryMapping[]
}

model FacilityCatalog {
  id       String           @id @default(cuid())
  code     String           @unique @db.VarChar(48)
  name     String           @db.VarChar(160)
  category FacilityCategory

  isActive  Boolean @default(true)
  sortOrder Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Branch enablement (multi-select)
  branchLinks BranchFacility[]

  // Departments created under this facility
  departments     Department[]
  StaffAssignment StaffAssignment[]

  @@index([category, isActive, sortOrder])
}

model BranchFacility {
  id String @id @default(cuid())

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  facilityId String
  facility   FacilityCatalog @relation(fields: [facilityId], references: [id], onDelete: Cascade)

  isEnabled Boolean  @default(true)
  enabledAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([branchId, facilityId])
  @@index([branchId, isEnabled])
  @@index([facilityId, isEnabled])
}

model Department {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  facilityId String
  facility   FacilityCatalog @relation(fields: [facilityId], references: [id])
  code       String
  name       String

  headStaffId String?
  headStaff   Staff?  @relation("DepartmentHead", fields: [headStaffId], references: [id], onDelete: SetNull)

  // Optional department hierarchy (enforced in service layer)
  parentDepartmentId String?
  parentDepartment   Department?  @relation("DepartmentHierarchy", fields: [parentDepartmentId], references: [id], onDelete: SetNull)
  childDepartments   Department[] @relation("DepartmentHierarchy")

  isActive Boolean @default(true)

  // Soft deactivation metadata (required by deactivation flows)
  deactivatedAt       DateTime?
  deactivationReason  String?   @db.VarChar(500)
  deactivatedByUserId String?
  deactivatedByUser   User?     @relation("DepartmentDeactivatedBy", fields: [deactivatedByUserId], references: [id], onDelete: SetNull)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  doctorAssignments DepartmentDoctor[]

  staffAssignments      StaffAssignment[]
  staffProviderProfiles StaffProviderProfile[]
  facilityType          FacilityCategory       @default(CLINICAL)
  costCenterCode        String?                @db.VarChar(64)
  extensions            Json?
  operatingHours        Json?

  locations DepartmentLocation[]

  // ✅ Many-to-many link to specialties (single source of truth for mapping)
  departmentSpecialties DepartmentSpecialty[]

  // ---------------- Infrastructure (Setup Studio) ----------------
  units             Unit[]
  equipmentOwned    EquipmentAsset[]   @relation("EquipmentOwnerDepartment")
  serviceItems      ServiceItem[]
  serviceCatalogues ServiceCatalogue[]
  OrderSet          OrderSet[]

  // BRD: department code unique within branch (not per facility)
  @@unique([branchId, code], name: "branchId_departmentCode")
  @@index([branchId, facilityId, isActive])
  @@index([branchId, isActive])
  @@index([deactivatedByUserId])
}

model DepartmentLocation {
  id String @id @default(cuid())

  departmentId String
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  locationNodeId String
  locationNode   LocationNode @relation(fields: [locationNodeId], references: [id], onDelete: Cascade)

  isPrimary Boolean @default(false)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([departmentId, locationNodeId])
  @@index([departmentId, isActive])
  @@index([locationNodeId, isActive])
}

model DepartmentDoctor {
  id String @id @default(cuid())

  departmentId String
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)

  isPrimary  Boolean  @default(false)
  assignedAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([departmentId, staffId])
  @@index([departmentId])
  @@index([staffId])
}

model DepartmentSpecialty {
  id String @id @default(cuid())

  departmentId String
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  specialtyId String
  specialty   Specialty @relation(fields: [specialtyId], references: [id], onDelete: Cascade)
  isPrimary   Boolean   @default(false)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([departmentId, specialtyId])
  @@index([departmentId, isActive])
  @@index([specialtyId, isActive])
}

model Specialty {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  code String
  name String

  kind SpecialtyKind @default(SPECIALTY)

  isActive Boolean @default(true)

  departmentLinks       DepartmentSpecialty[]
  staffAssignments      StaffAssignment[]
  staffProviderProfiles StaffProviderProfile[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([branchId, code])
  @@index([branchId, isActive])
}

enum UserSource {
  ADMIN
  STAFF
  MANUAL
  SYSTEM
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum StaffTitle {
  DR
  MR
  MS
  MRS
  PROF
  OTHER
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum BloodGroup {
  A_POS
  A_NEG
  B_POS
  B_NEG
  O_POS
  O_NEG
  AB_POS
  AB_NEG
}

enum MaritalStatus {
  SINGLE
  MARRIED
  DIVORCED
  SEPARATED
  WIDOWED
}

enum StaffType {
  DOCTOR_CONSULTANT
  DOCTOR_RESIDENT
  DOCTOR_INTERN
  NURSE_HEAD
  NURSE_STAFF
  NURSE_TRAINEE
  TECHNICIAN_LAB
  TECHNICIAN_RADIOLOGY
  TECHNICIAN_OT
  TECHNICIAN_DIALYSIS
  TECHNICIAN_ANESTHESIA
  PHARMACIST
  PHARMACIST_ASSISTANT
  PHYSIOTHERAPIST
  DIETICIAN
  COUNSELOR
  RECEPTIONIST
  CASHIER
  HOUSEKEEPING
  SECURITY
  ADMIN_STAFF
  OTHER
}

enum StaffEmploymentType {
  PERMANENT
  CONTRACT
  CONSULTANT
  VISITING
  LOCUM
  INTERN
  TRAINEE
  VENDOR
  OTHER
}

enum StaffEmploymentStatus {
  ACTIVE
  ON_LEAVE
  SUSPENDED
  RESIGNED
  TERMINATED
  RETIRED
  OFFBOARDED
}

enum StaffVerificationStatus {
  UNVERIFIED
  PENDING
  VERIFIED
  REJECTED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum StaffShiftType {
  MORNING
  EVENING
  NIGHT
  ROTATIONAL
  CUSTOM
}

enum StaffRosterStatus {
  DRAFT
  ACTIVE
  PUBLISHED
  CANCELLED
}

enum StaffAttendanceStatus {
  PRESENT
  ABSENT
  LEAVE
  HALF_DAY
  LATE
  HOLIDAY
  WEEK_OFF
}

enum StaffLeaveStatus {
  APPLIED
  APPROVED
  REJECTED
  CANCELLED
}

enum StaffTrainingStatus {
  ENROLLED
  COMPLETED
  FAILED
  DROPPED
}

enum StaffAppraisalStatus {
  DRAFT
  SUBMITTED
  REVIEWED
  APPROVED
}

enum StaffCredentialStatus {
  VALID
  EXPIRING_SOON
  EXPIRED
  RENEWED
}

enum StaffCredentialAlertStage {
  D90
  D60
  D30
  D15
  D7
  D0
  POST_7
  POST_30
}

enum StaffAlertDeliveryStatus {
  PENDING
  SENT
  CANCELLED
  FAILED
}

enum StaffCategory {
  CLINICAL     @map("MEDICAL")
  NON_CLINICAL @map("NON_MEDICAL")
}

enum StaffStatus {
  ACTIVE
  SUSPENDED
  OFFBOARDED
}

enum StaffEngagementType {
  EMPLOYEE
  CONSULTANT
  VISITING
  LOCUM
  CONTRACTOR
  INTERN
  TRAINEE
  VENDOR
}

enum StaffAssignmentType {
  PERMANENT
  TEMPORARY
  ROTATION
  VISITING
  LOCUM
  CONTRACTOR
  DEPUTATION
  TRANSFER
}

enum StaffAssignmentStatus {
  ACTIVE
  PLANNED
  SUSPENDED
  ENDED
}

enum StaffCredentialType {
  MEDICAL_REG
  NURSING_REG
  PHARMACY_REG
  TECH_CERT
  OTHER
}

enum StaffCredentialVerificationStatus {
  UNVERIFIED
  PENDING
  VERIFIED
  REJECTED
}

enum StaffIdentifierType {
  AADHAAR
  PAN
  PASSPORT
  HPR_ID
  OTHER
}

enum StaffOnboardingStatus {
  DRAFT
  IN_REVIEW
  ACTIVE
}

enum StaffDocumentType {
  PROFILE_PHOTO
  SIGNATURE
  STAMP
  ID_PROOF
  EDUCATION_DEGREE
  TRAINING_CERTIFICATE
  EMPLOYMENT_CONTRACT
  MEDICAL_REG_EVIDENCE
  OTHER
}

enum StaffDocumentVerificationStatus {
  UNVERIFIED
  PENDING
  VERIFIED
  REJECTED
}

enum StaffOnboardingItemType {
  DOCUMENT
  CREDENTIAL
  IDENTIFIER
  ASSIGNMENT
  SYSTEM_ACCESS
  PRIVILEGE
  OTHER
}

enum StaffOnboardingItemStatus {
  PENDING
  DONE
  WAIVED
  REJECTED
}

enum StaffPrivilegeArea {
  OPD
  IPD
  ER
  OT
  ICU
  DIAGNOSTICS
  LAB
  RADIOLOGY
  PHARMACY
  BILLING
  ADMIN
}

enum StaffPrivilegeAction {
  VIEW
  ORDER
  PRESCRIBE
  PERFORM
  ATTEST
  DISCHARGE
  SIGN
  APPROVE
  OTHER
}

enum StaffPrivilegeTargetType {
  NONE
  SERVICE_ITEM
  DIAGNOSTIC_ITEM
  ORDER_SET
  OTHER
}

enum StaffPrivilegeStatus {
  ACTIVE
  SUSPENDED
  REVOKED
  EXPIRED
}

enum StaffComplianceRequirementKind {
  DOCUMENT
  CREDENTIAL
  IDENTIFIER
}

enum StaffComplianceAssignmentStatus {
  ACTIVE
  INACTIVE
}

model Staff {
  id String @id @default(cuid())

  // Enterprise staff code (optional in real world, but kept required here for backward compatibility)
  empCode String @unique @db.VarChar(32)

  // Display name (enterprise master)
  name String @db.VarChar(160)

  // Default designation (assignment may override)
  designation String @db.VarChar(120)

  // Structured identity (workflow-aligned; source of truth for UI + validations)
  title       StaffTitle?
  firstName   String?     @db.VarChar(80)
  middleName  String?     @db.VarChar(80)
  lastName    String?     @db.VarChar(80)
  displayName String?     @db.VarChar(160)

  dateOfBirth   DateTime?
  gender        Gender?
  bloodGroup    BloodGroup?
  maritalStatus MaritalStatus?

  primaryPhone   String? @db.VarChar(20)
  secondaryPhone String? @db.VarChar(20)
  personalEmail  String? @db.VarChar(120)
  officialEmail  String? @db.VarChar(120)

  emergencyContact Json?
  currentAddress   Json?
  permanentAddress Json?
  isSameAsCurrent  Boolean @default(false)

  staffType        StaffType?
  employmentType   StaffEmploymentType?
  employmentStatus StaffEmploymentStatus?

  joiningDate       DateTime?
  confirmationDate  DateTime?
  probationEndDate  DateTime?
  contractStartDate DateTime?
  contractEndDate   DateTime?

  defaultShiftType    StaffShiftType?
  isFullTime          Boolean?
  workingHoursPerWeek Int?
  weeklyOffDays       Json?

  hasSystemAccess Boolean @default(false)

  isAvailableForAppointment Boolean @default(false)
  isAvailableForDuty        Boolean @default(true)
  canPrescribe              Boolean @default(false)
  canAdmitPatients          Boolean @default(false)
  canPerformSurgery         Boolean @default(false)

  hprVerificationStatus  StaffVerificationStatus?
  hprLastVerifiedAt      DateTime?
  hprVerificationPayload Json?

  backgroundVerificationStatus  StaffVerificationStatus?
  policeVerificationStatus      StaffVerificationStatus?
  backgroundVerificationPayload Json?

  category       StaffCategory       @default(NON_CLINICAL)
  engagementType StaffEngagementType @default(EMPLOYEE)
  status         StaffStatus         @default(ACTIVE)

  phone String? @db.VarChar(20)
  email String? @db.VarChar(120)

  // Organization (hospital group) + primary branch (multi-branch sharing)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)

  primaryBranchId String?
  primaryBranch   Branch? @relation("StaffPrimaryBranch", fields: [primaryBranchId], references: [id], onDelete: SetNull)

  // Legacy anchor (kept for back-compat; prefer primaryBranchId)
  homeBranchId String?
  homeBranch   Branch? @relation("StaffHomeBranch", fields: [homeBranchId], references: [id], onDelete: SetNull)

  // Reporting line (optional)
  reportingToStaffId String?
  reportingTo        Staff?  @relation("StaffReportingLine", fields: [reportingToStaffId], references: [id], onDelete: SetNull)
  directReports      Staff[] @relation("StaffReportingLine")

  // ABDM/HPR identifier (optional; can also be stored as identifier)
  hprId String? @unique @db.VarChar(64)

  isActive         Boolean   @default(true)
  // Suspension tracking (BRD FR6.2)
  suspendedAt      DateTime?
  suspendedUntil   DateTime?
  suspensionReason String?   @db.VarChar(240)

  // Optional profile notes
  notes             String?
  personalDetails   Json?
  contactDetails    Json?
  employmentDetails Json?
  medicalDetails    Json?
  systemAccess      Json?

  // Onboarding workflow (ops readiness)
  onboardingStatus            StaffOnboardingStatus @default(DRAFT)
  onboardingStartedAt         DateTime?
  onboardingCompletedAt       DateTime?
  onboardingCompletedByUserId String?
  onboardingCompletedByUser   User?                 @relation("StaffOnboardingCompletedBy", fields: [onboardingCompletedByUserId], references: [id], onDelete: SetNull)

  // Convenience pointers (documents still live in StaffDocument vault)
  profilePhotoDocumentId String?        @unique
  profilePhotoDocument   StaffDocument? @relation("StaffProfilePhoto", fields: [profilePhotoDocumentId], references: [id], onDelete: SetNull)

  signatureDocumentId String?        @unique
  signatureDocument   StaffDocument? @relation("StaffSignatureDoc", fields: [signatureDocumentId], references: [id], onDelete: SetNull)

  stampDocumentId String?        @unique
  stampDocument   StaffDocument? @relation("StaffStampDoc", fields: [stampDocumentId], references: [id], onDelete: SetNull)

  // PCPNDT / compliance marker (BRD FR5.3)
  isUsgAuthorized       Boolean   @default(false)
  usgAuthorizedAt       DateTime?
  usgAuthorizedByUserId String?
  usgAuthorizedByUser   User?     @relation("StaffUsgAuthorizedBy", fields: [usgAuthorizedByUserId], references: [id], onDelete: SetNull)
  usgAuthorizationNotes String?   @db.VarChar(240)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Assignments (multi-branch postings)
  assignments StaffAssignment[]

  // Credentialing & identifiers
  credentials StaffCredential[]
  identifiers StaffIdentifier[]

  // Documents + onboarding + privileging + provider profile (enterprise-grade staff backbone)
  documents             StaffDocument[]             @relation("StaffDocuments")
  onboardingItems       StaffOnboardingItem[]
  privilegeGrants       StaffPrivilegeGrant[]       @relation("StaffPrivilegeGrants")
  providerProfiles      StaffProviderProfile[]      @relation("StaffProviderProfiles")
  complianceAssignments StaffComplianceAssignment[]

  // HR Ops / Workforce Management
  rosters           StaffRoster[]
  attendances       StaffAttendance[]
  leaveRequests     StaffLeaveRequest[]
  trainings         StaffTrainingRecord[]
  appraisals        StaffAppraisal[]
  separations       StaffSeparation[]
  healthRecords     StaffHealthRecord[]
  insurancePolicies StaffInsurancePolicy[]

  // User linkage (preferred 1:1)
  user User? @relation("StaffUserLink")

  // Existing relations kept for compatibility
  doctorAssignments        DepartmentDoctor[]
  headedDepartments        Department[]               @relation("DepartmentHead")
  EquipmentMaintenanceTask EquipmentMaintenanceTask[]

  // Merge audit
  mergeSourceLogs StaffMergeLog[] @relation("StaffMergeSource")
  mergeTargetLogs StaffMergeLog[] @relation("StaffMergeTarget")

  @@index([name])
  @@index([displayName])
  @@index([phone])
  @@index([primaryPhone])
  @@index([email])
  @@index([personalEmail])
  @@index([status, isActive])
  @@index([primaryBranchId])
  @@index([category])
  @@index([engagementType])
  @@index([isUsgAuthorized])
  @@index([suspendedUntil])
  @@index([onboardingStatus])
  @@index([onboardingCompletedAt])
}

model StaffAssignment {
  id String @id @default(cuid())

  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  facilityId String?
  facility   FacilityCatalog? @relation(fields: [facilityId], references: [id], onDelete: SetNull)

  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  specialtyId String?
  specialty   Specialty? @relation(fields: [specialtyId], references: [id], onDelete: SetNull)

  unitId String?
  unit   Unit?   @relation(fields: [unitId], references: [id], onDelete: SetNull)

  // Branch-local employee code (if different across branches)
  branchEmpCode String? @db.VarChar(32)

  // Assignment-specific designation (may differ across branches)
  designation String? @db.VarChar(120)

  // Assignment-local role label (may differ per branch)
  role String? @db.VarChar(100)

  assignmentType StaffAssignmentType   @default(PERMANENT)
  status         StaffAssignmentStatus @default(ACTIVE)

  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?

  isPrimary Boolean @default(false)

  // Multi-branch availability & OPD configuration
  daysAvailable              Json? // Array<DayOfWeek>
  workingHours               Json? // { [day]: { startTime,endTime,breakStart?,breakEnd? } }
  opdConfiguration           Json? // { slotDuration,maxSlotsPerDay,consultationRooms: string[] }
  consultationChargeOverride Decimal? @db.Decimal(10, 2)

  // Administrative / approval workflow
  isActive         Boolean        @default(true)
  requiresApproval Boolean        @default(false)
  approvalStatus   ApprovalStatus @default(APPROVED)

  assignedByUserId String?
  assignedByUser   User?     @relation("StaffAssignmentAssignedBy", fields: [assignedByUserId], references: [id], onDelete: SetNull)
  assignedAt       DateTime?

  approvedByUserId String?
  approvedByUser   User?     @relation("StaffAssignmentApprovedBy", fields: [approvedByUserId], references: [id], onDelete: SetNull)
  approvedAt       DateTime?
  approvalNotes    String?   @db.VarChar(240)

  // Branch-level clinical privileges
  canAdmitPatients  Boolean @default(false)
  canPerformSurgery Boolean @default(false)
  hasOTPrivileges   Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Optional tie-back for access bindings
  userRoleBindings     UserRoleBinding[]
  staffDocuments       StaffDocument[]
  staffPrivilegeGrants StaffPrivilegeGrant[]

  @@unique([staffId, branchId])
  @@index([staffId, status])
  @@index([branchId, status])
  @@index([departmentId, status])
  @@index([specialtyId, status])
  @@index([effectiveTo])
  @@index([isPrimary])
  @@index([requiresApproval, approvalStatus])
  @@index([approvalStatus])
}

model UserRoleBinding {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  roleVersionId String
  roleVersion   RoleTemplateVersion @relation(fields: [roleVersionId], references: [id], onDelete: Cascade)

  staffAssignmentId String?
  staffAssignment   StaffAssignment? @relation(fields: [staffAssignmentId], references: [id], onDelete: SetNull)

  isPrimary Boolean @default(false)
  isActive  Boolean @default(true)

  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, branchId, roleVersionId, staffAssignmentId])
  @@index([userId, isActive])
  @@index([branchId, isActive])
  @@index([roleVersionId, isActive])
  @@index([effectiveTo])
}

model StaffCredential {
  id String @id @default(cuid())

  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)

  type      StaffCredentialType @default(OTHER)
  authority String?             @db.VarChar(120)

  registrationNumber String? @db.VarChar(64)

  validFrom DateTime?
  validTo   DateTime?

  // Computed lifecycle (kept explicit for filtering + alerts)
  status               StaffCredentialStatus @default(VALID)
  isCritical           Boolean               @default(false)
  renewalRequired      Boolean               @default(false)
  renewalWindowDays    Int?
  lastStatusComputedAt DateTime?

  verificationStatus StaffCredentialVerificationStatus @default(UNVERIFIED)
  verifiedAt         DateTime?
  verifiedByUserId   String?
  verifiedByUser     User?                             @relation(fields: [verifiedByUserId], references: [id], onDelete: SetNull)

  // Legacy single URL (keep for back-compat). Prefer StaffCredentialEvidence -> StaffDocument
  documentUrl String?

  evidences StaffCredentialEvidence[]
  alerts    StaffCredentialAlert[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([staffId, type])
  @@index([validTo])
  @@index([verificationStatus])
}

model StaffIdentifier {
  id String @id @default(cuid())

  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)

  type StaffIdentifierType @default(OTHER)

  // DPDP-safe storage: store hash + last4 only
  valueHash  String  @db.VarChar(128)
  valueLast4 String? @db.VarChar(8)

  issuedBy String?   @db.VarChar(120)
  issuedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([type, valueHash])
  @@index([staffId, type])
}

model StaffDocument {
  id String @id @default(cuid())

  staffId String
  staff   Staff  @relation("StaffDocuments", fields: [staffId], references: [id], onDelete: Cascade)

  // Optional: branch/assignment scoping (some docs are enterprise-wide, some are branch-local)
  branchId String?
  branch   Branch? @relation(fields: [branchId], references: [id], onDelete: SetNull)

  staffAssignmentId String?
  staffAssignment   StaffAssignment? @relation(fields: [staffAssignmentId], references: [id], onDelete: SetNull)

  type        StaffDocumentType @default(OTHER)
  title       String?           @db.VarChar(160)
  description String?

  refNo     String?   @db.VarChar(80)
  issuedBy  String?   @db.VarChar(120)
  issuedAt  DateTime?
  validFrom DateTime?
  validTo   DateTime?

  // Storage pointer (S3/minio/local file service)
  fileUrl       String  @db.VarChar(512)
  fileMime      String? @db.VarChar(120)
  fileSizeBytes Int?
  checksum      String? @db.VarChar(128)

  tags     Json?
  isActive Boolean @default(true)

  uploadedByUserId String?
  uploadedByUser   User?   @relation("StaffDocumentUploadedBy", fields: [uploadedByUserId], references: [id], onDelete: SetNull)

  verificationStatus StaffDocumentVerificationStatus @default(UNVERIFIED)
  verifiedAt         DateTime?
  verifiedByUserId   String?
  verifiedByUser     User?                           @relation("StaffDocumentVerifiedBy", fields: [verifiedByUserId], references: [id], onDelete: SetNull)
  verificationNotes  String?                         @db.VarChar(240)

  // Back-relations for convenience pointers on Staff
  profilePhotoFor Staff? @relation("StaffProfilePhoto")
  signatureFor    Staff? @relation("StaffSignatureDoc")
  stampFor        Staff? @relation("StaffStampDoc")

  // Evidence links
  credentialEvidences StaffCredentialEvidence[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([staffId, type])
  @@index([branchId, type])
  @@index([staffAssignmentId])
  @@index([validTo])
  @@index([verificationStatus])
  @@index([isActive])
}

model StaffCredentialEvidence {
  id String @id @default(cuid())

  staffCredentialId String
  staffCredential   StaffCredential @relation(fields: [staffCredentialId], references: [id], onDelete: Cascade)

  staffDocumentId String
  staffDocument   StaffDocument @relation(fields: [staffDocumentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([staffCredentialId, staffDocumentId])
  @@index([staffCredentialId])
  @@index([staffDocumentId])
}

model StaffCredentialAlert {
  id String @id @default(cuid())

  staffCredentialId String
  staffCredential   StaffCredential @relation(fields: [staffCredentialId], references: [id], onDelete: Cascade)

  stage       StaffCredentialAlertStage
  scheduledAt DateTime
  status      StaffAlertDeliveryStatus  @default(PENDING)
  sentAt      DateTime?

  // Optional outbox integration
  outboxEventId String?
  outboxEvent   OutboxEvent? @relation(fields: [outboxEventId], references: [id], onDelete: SetNull)

  error String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([staffCredentialId, stage])
  @@index([status, scheduledAt])
}

model StaffRoster {
  id String @id @default(cuid())

  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  periodStart DateTime
  periodEnd   DateTime

  status StaffRosterStatus @default(DRAFT)
  meta   Json?

  entries StaffRosterEntry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([branchId, periodStart])
  @@index([staffId, periodStart])
}

model StaffRosterEntry {
  id String @id @default(cuid())

  rosterId String
  roster   StaffRoster @relation(fields: [rosterId], references: [id], onDelete: Cascade)

  startAt   DateTime
  endAt     DateTime
  shiftType StaffShiftType?
  meta      Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([startAt])
  @@index([rosterId, startAt])
}

model StaffAttendance {
  id String @id @default(cuid())

  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  date   DateTime              @db.Date
  status StaffAttendanceStatus @default(PRESENT)

  checkInAt  DateTime?
  checkOutAt DateTime?
  source     Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([staffId, branchId, date])
  @@index([branchId, date])
  @@index([staffId, date])
}

model StaffLeaveRequest {
  id String @id @default(cuid())

  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  leaveType String   @db.VarChar(80)
  startDate DateTime @db.Date
  endDate   DateTime @db.Date
  reason    String?  @db.VarChar(240)

  status StaffLeaveStatus @default(APPLIED)

  reportingManagerApproval         ApprovalStatus @default(PENDING)
  reportingManagerApprovedByUserId String?
  reportingManagerApprovedByUser   User?          @relation("StaffLeaveRMApprovedBy", fields: [reportingManagerApprovedByUserId], references: [id], onDelete: SetNull)
  reportingManagerApprovedAt       DateTime?

  hrApproval         ApprovalStatus @default(PENDING)
  hrApprovedByUserId String?
  hrApprovedByUser   User?          @relation("StaffLeaveHRApprovedBy", fields: [hrApprovedByUserId], references: [id], onDelete: SetNull)
  hrApprovedAt       DateTime?

  meta Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([branchId, startDate])
  @@index([staffId, status])
}

model StaffTrainingRecord {
  id String @id @default(cuid())

  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)

  branchId String?
  branch   Branch? @relation(fields: [branchId], references: [id], onDelete: SetNull)

  programName String  @db.VarChar(160)
  provider    String? @db.VarChar(160)

  status      StaffTrainingStatus @default(ENROLLED)
  completedAt DateTime?
  score       Decimal?            @db.Decimal(5, 2)

  evidenceDocumentId String? // Link to StaffDocument.id (kept as scalar to avoid strong coupling)
  meta               Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([staffId, status])
  @@index([branchId, status])
}

model StaffAppraisal {
  id String @id @default(cuid())

  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)

  branchId String?
  branch   Branch? @relation(fields: [branchId], references: [id], onDelete: SetNull)

  cycleLabel String               @db.VarChar(80) // e.g. "FY2025" or "2025-Q4"
  status     StaffAppraisalStatus @default(DRAFT)

  rating  Decimal? @db.Decimal(4, 2)
  summary String?  @db.VarChar(240)
  meta    Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([staffId, cycleLabel])
  @@index([branchId, cycleLabel])
  @@index([status])
}

model StaffSeparation {
  id String @id @default(cuid())

  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)

  branchId String?
  branch   Branch? @relation(fields: [branchId], references: [id], onDelete: SetNull)

  separationDate DateTime @db.Date
  reason         String?  @db.VarChar(240)
  meta           Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([staffId, separationDate])
  @@index([branchId, separationDate])
}

model StaffHealthRecord {
  id String @id @default(cuid())

  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)

  recordedAt DateTime @default(now())
  meta       Json?

  @@index([staffId, recordedAt])
}

model StaffInsurancePolicy {
  id String @id @default(cuid())

  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)

  policyType   String  @db.VarChar(80) // e.g. "Indemnity", "GroupHealth"
  provider     String? @db.VarChar(160)
  policyNumber String? @db.VarChar(64)

  validFrom DateTime?
  validTo   DateTime?

  meta Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([staffId, policyType])
  @@index([validTo])
}

model StaffProviderProfile {
  id String @id @default(cuid())

  staffId String
  staff   Staff  @relation("StaffProviderProfiles", fields: [staffId], references: [id], onDelete: Cascade)

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  isActive Boolean @default(true)

  // Branch/provider code used in scheduling/billing integrations
  providerCode String? @db.VarChar(32)
  displayName  String? @db.VarChar(160)

  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  specialtyId String?
  specialty   Specialty? @relation(fields: [specialtyId], references: [id], onDelete: SetNull)

  // Hooks for future modules (keep flexible)
  consultationModes Json?
  schedulingProfile Json?
  billingProfile    Json?
  clinicalProfile   Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([staffId, branchId])
  @@index([branchId, isActive])
  @@index([departmentId])
  @@index([specialtyId])
}

model StaffPrivilegeGrant {
  id String @id @default(cuid())

  staffId String
  staff   Staff  @relation("StaffPrivilegeGrants", fields: [staffId], references: [id], onDelete: Cascade)

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  staffAssignmentId String?
  staffAssignment   StaffAssignment? @relation(fields: [staffAssignmentId], references: [id], onDelete: SetNull)

  area   StaffPrivilegeArea
  action StaffPrivilegeAction

  // Optional: scope to a specific target (procedure/service/test/order set)
  targetType StaffPrivilegeTargetType @default(NONE)
  targetId   String?                  @db.VarChar(80)
  targetMeta Json?

  status StaffPrivilegeStatus @default(ACTIVE)

  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?

  grantedByUserId String?
  grantedByUser   User?   @relation("StaffPrivilegeGrantedBy", fields: [grantedByUserId], references: [id], onDelete: SetNull)

  notes String? @db.VarChar(240)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([staffId, branchId, area, action])
  @@index([branchId, status])
  @@index([effectiveTo])
  @@index([targetType, targetId])
  @@index([staffAssignmentId])
}

model StaffOnboardingItem {
  id String @id @default(cuid())

  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)

  branchId String?
  branch   Branch? @relation(fields: [branchId], references: [id], onDelete: SetNull)

  type        StaffOnboardingItemType
  title       String                  @db.VarChar(160)
  description String?

  status     StaffOnboardingItemStatus @default(PENDING)
  isRequired Boolean                   @default(true)

  dueAt DateTime?

  completedAt       DateTime?
  completedByUserId String?
  completedByUser   User?     @relation("StaffOnboardingItemCompletedBy", fields: [completedByUserId], references: [id], onDelete: SetNull)

  meta Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([staffId, status])
  @@index([branchId, status])
  @@index([type, status])
  @@index([dueAt])
}

model StaffCompliancePack {
  id String @id @default(cuid())

  name        String  @db.VarChar(160)
  description String?

  // Applicability (optional)
  category       StaffCategory?
  roleTemplateId String?
  roleTemplate   RoleTemplate?  @relation(fields: [roleTemplateId], references: [id], onDelete: SetNull)

  branchId String?
  branch   Branch? @relation(fields: [branchId], references: [id], onDelete: SetNull)

  isActive Boolean @default(true)

  requirements StaffComplianceRequirement[]
  assignments  StaffComplianceAssignment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([roleTemplateId])
  @@index([branchId])
  @@index([isActive])
}

model StaffComplianceRequirement {
  id String @id @default(cuid())

  packId String
  pack   StaffCompliancePack @relation(fields: [packId], references: [id], onDelete: Cascade)

  kind        StaffComplianceRequirementKind
  title       String                         @db.VarChar(160)
  isMandatory Boolean                        @default(true)

  // One of these based on kind
  documentType   StaffDocumentType?
  credentialType StaffCredentialType?
  identifierType StaffIdentifierType?

  // Optional renewal expectations
  renewalRequired   Boolean @default(false)
  renewalWindowDays Int?

  meta Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([packId, kind])
  @@index([documentType])
  @@index([credentialType])
  @@index([identifierType])
}

model StaffComplianceAssignment {
  id String @id @default(cuid())

  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)

  packId String
  pack   StaffCompliancePack @relation(fields: [packId], references: [id], onDelete: Cascade)

  // Optional branch scoping for packs applied only in certain branches
  branchId String?
  branch   Branch? @relation(fields: [branchId], references: [id], onDelete: SetNull)

  status StaffComplianceAssignmentStatus @default(ACTIVE)

  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?

  assignedByUserId String?
  assignedByUser   User?   @relation("StaffComplianceAssignedBy", fields: [assignedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([staffId, packId, branchId])
  @@index([staffId, status])
  @@index([packId, status])
  @@index([branchId, status])
  @@index([effectiveTo])
}

model StaffMergeLog {
  id String @id @default(cuid())

  sourceStaffId String
  sourceStaff   Staff  @relation("StaffMergeSource", fields: [sourceStaffId], references: [id], onDelete: Restrict)

  targetStaffId String
  targetStaff   Staff  @relation("StaffMergeTarget", fields: [targetStaffId], references: [id], onDelete: Restrict)

  reason String? @db.VarChar(240)
  notes  String?

  mergedByUserId String?
  mergedByUser   User?   @relation(fields: [mergedByUserId], references: [id], onDelete: SetNull)

  mergedAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sourceStaffId])
  @@index([targetStaffId])
}

model User {
  id    String @id @default(cuid())
  email String @unique
  name  String

  // Keep a simple role string for UI/back-compat (your code references this)
  role String @default("BRANCH_ADMIN")

  phone    String?
  branchId String?
  branch   Branch? @relation(fields: [branchId], references: [id])

  staffId String? @unique
  staff   Staff?  @relation("StaffUserLink", fields: [staffId], references: [id])

  isActive Boolean @default(true)

  // Origin of the account (used to hide staff-managed users from IAM list by default)
  source UserSource @default(ADMIN)

  /// Authorization version. Increment whenever role/branch/status changes so
  /// cached principals (and sessions) can be invalidated deterministically.
  authzVersion Int @default(1)

  passwordHash       String?
  mustChangePassword Boolean @default(false)

  passwordResetToken                 String?                     @unique
  passwordResetExpires               DateTime?
  roleVersionId                      String?
  roleVersion                        RoleTemplateVersion?        @relation("UserRoleVersion", fields: [roleVersionId], references: [id])
  usgAuthorizedStaff                 Staff[]                     @relation("StaffUsgAuthorizedBy")
  completedStaffOnboardings          Staff[]                     @relation("StaffOnboardingCompletedBy")
  grantedStaffPrivilegeGrants        StaffPrivilegeGrant[]       @relation("StaffPrivilegeGrantedBy")
  completedStaffOnboardingItems      StaffOnboardingItem[]       @relation("StaffOnboardingItemCompletedBy")
  assignedStaffComplianceAssignments StaffComplianceAssignment[] @relation("StaffComplianceAssignedBy")
  assignedStaffAssignments           StaffAssignment[]           @relation("StaffAssignmentAssignedBy")
  approvedStaffAssignments           StaffAssignment[]           @relation("StaffAssignmentApprovedBy")
  rmApprovedLeaveRequests            StaffLeaveRequest[]         @relation("StaffLeaveRMApprovedBy")
  hrApprovedLeaveRequests            StaffLeaveRequest[]         @relation("StaffLeaveHRApprovedBy")

  // Multi-branch role bindings (Doctor@BranchA, Doctor@BranchB, ...)
  roleBindings UserRoleBinding[]

  createdRoleVersions RoleTemplateVersion[] @relation("RoleVersionCreatedBy")
  auditEventsAsActor  AuditEvent[]          @relation("AuditActor")

  // Opposite relation for department deactivation metadata
  deactivatedDepartments   Department[]   @relation("DepartmentDeactivatedBy")
  // ---- Deactivation actor back-relations (infra) ----
  deactivatedUnits         Unit[]         @relation("UnitDeactivatedBy")
  deactivatedUnitRooms     UnitRoom[]     @relation("UnitRoomDeactivatedBy")
  deactivatedUnitResources UnitResource[] @relation("UnitResourceDeactivatedBy")

  // Policy governance opposite relations
  policyVersionsCreatedBy   PolicyVersion[] @relation("PolicyVersionCreatedBy")
  policyVersionsSubmittedBy PolicyVersion[] @relation("PolicyVersionSubmittedBy")
  policyVersionsApprovedBy  PolicyVersion[] @relation("PolicyVersionApprovedBy")
  policyVersionsRejectedBy  PolicyVersion[] @relation("PolicyVersionRejectedBy")
  policyVersionsRetiredBy   PolicyVersion[] @relation("PolicyVersionRetiredBy")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ---------------- Infrastructure (Setup Studio) ----------------
  createdLocationRevisions        LocationNodeRevision[]    @relation("LocationRevisionCreatedBy")
  createdImportJobs               BulkImportJob[]           @relation("ImportJobCreatedBy")
  // ---------------- Service Catalog (Orderables) ----------------
  createdServiceItems             ServiceItem[]             @relation("ServiceItemCreatedBy")
  updatedServiceItems             ServiceItem[]             @relation("ServiceItemUpdatedBy")
  createdServiceItemVersions      ServiceItemVersion[]      @relation("ServiceItemVersionCreatedBy")
  createdServiceCatalogues        ServiceCatalogue[]        @relation("ServiceCatalogueCreatedBy")
  updatedServiceCatalogues        ServiceCatalogue[]        @relation("ServiceCatalogueUpdatedBy")
  createdServiceCatalogueVersions ServiceCatalogueVersion[] @relation("ServiceCatalogueVersionCreatedBy")
  submittedServiceItems           ServiceItem[]             @relation("ServiceItemSubmittedBy")
  approvedServiceItems            ServiceItem[]             @relation("ServiceItemApprovedBy")
  publishedServiceItems           ServiceItem[]             @relation("ServiceItemPublishedBy")

  submittedServiceCatalogues    ServiceCatalogue[]      @relation("ServiceCatalogueSubmittedBy")
  approvedServiceCatalogues     ServiceCatalogue[]      @relation("ServiceCatalogueApprovedBy")
  publishedServiceCatalogues    ServiceCatalogue[]      @relation("ServiceCataloguePublishedBy")
  assignedFixIts                FixItTask[]             @relation("FixItAssignedTo")
  createdBookings               ProcedureBooking[]      @relation("BookingCreatedBy")
  createdGoLiveReports          GoLiveReport[]          @relation("GoLiveCreatedBy")
  createdDiagnosticPackVersions DiagnosticPackVersion[] @relation("DiagnosticPackVersionCreatedBy")

  // ---------------- Service Packages (Bundles) ----------------
  createdServicePackages        ServicePackage[]        @relation("ServicePackageCreatedBy")
  updatedServicePackages        ServicePackage[]        @relation("ServicePackageUpdatedBy")
  submittedServicePackages      ServicePackage[]        @relation("ServicePackageSubmittedBy")
  approvedServicePackages       ServicePackage[]        @relation("ServicePackageApprovedBy")
  publishedServicePackages      ServicePackage[]        @relation("ServicePackagePublishedBy")
  createdServicePackageVersions ServicePackageVersion[] @relation("ServicePackageVersionCreatedBy")

  // ---------------- Order Sets (Clinical Presets) ----------------
  createdOrderSets        OrderSet[]        @relation("OrderSetCreatedBy")
  updatedOrderSets        OrderSet[]        @relation("OrderSetUpdatedBy")
  submittedOrderSets      OrderSet[]        @relation("OrderSetSubmittedBy")
  approvedOrderSets       OrderSet[]        @relation("OrderSetApprovedBy")
  publishedOrderSets      OrderSet[]        @relation("OrderSetPublishedBy")
  createdOrderSetVersions OrderSetVersion[] @relation("OrderSetVersionCreatedBy")

  // ---------------- Tariffs (Rates) ----------------
  createdTariffRates TariffRate[] @relation("TariffRateCreatedBy")

  // ---------------- Equipment Register (Infrastructure) ----------------
  createdEquipmentRevisions        EquipmentAssetRevision[]      @relation("EquipmentRevisionCreatedBy")
  createdEquipmentPlacements       EquipmentPlacement[]          @relation("EquipmentPlacementCreatedBy")
  movedEquipmentMovements          EquipmentMovement[]           @relation("EquipmentMovedBy")
  uploadedEquipmentDocuments       EquipmentDocument[]           @relation("EquipmentDocUploadedBy")
  createdEquipmentContracts        EquipmentContract[]           @relation("EquipmentContractCreatedBy")
  createdEquipmentMaintenanceTasks EquipmentMaintenanceTask[]    @relation("EquipmentMaintCreatedBy")
  verifiedEquipmentEvidences       EquipmentComplianceEvidence[] @relation("EquipmentEvidenceVerifiedBy")

  // ---------------- Governance (Maker–Checker) ----------------
  governedChangeRequestsCreated   GovernedChangeRequest[] @relation("GovernedChangeCreatedBy")
  governedChangeRequestsSubmitted GovernedChangeRequest[] @relation("GovernedChangeSubmittedBy")
  governedChangeRequestsApproved  GovernedChangeRequest[] @relation("GovernedChangeApprovedBy")
  governedChangeRequestsRejected  GovernedChangeRequest[] @relation("GovernedChangeRejectedBy")
  staffDocumentsUploaded          StaffDocument[]         @relation("StaffDocumentUploadedBy")
  staffDocumentsVerified          StaffDocument[]         @relation("StaffDocumentVerifiedBy")
  StaffCredential                 StaffCredential[]
  StaffMergeLog                   StaffMergeLog[]
}

model Patient {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  uhid    String
  name    String
  gender  String?
  dob     DateTime?
  phone   String?
  email   String?
  address String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  encounters Encounter[]
  Admission  Admission[]

  // Opposite relations (required for Prisma validation)
  consentRecords ConsentRecord[]
  rtbfRequests   RtbfRequest[]
  statutoryCases StatutoryCase[]

  @@unique([branchId, uhid])
}

model Encounter {
  id        String  @id @default(cuid())
  branchId  String
  branch    Branch  @relation(fields: [branchId], references: [id])
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  type      EncounterType
  startedAt DateTime      @default(now())
  endedAt   DateTime?
  status    String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  admissions Admission[]
}

model Ward {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  code      String
  name      String
  specialty String?
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  rooms Room[]

  @@unique([branchId, code])
}

model Room {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])
  wardId   String
  ward     Ward   @relation(fields: [wardId], references: [id])

  code     String
  name     String
  floor    String?
  type     String?
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  beds Bed[]

  @@unique([wardId, code])
  @@index([branchId, wardId, isActive])
}

model Bed {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])
  roomId   String
  room     Room   @relation(fields: [roomId], references: [id])

  code     String
  state    BedState @default(VACANT)
  isActive Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  admissions Admission[]

  @@unique([roomId, code])
  @@index([branchId, roomId, isActive])
}

model Admission {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  encounterId String?
  encounter   Encounter? @relation(fields: [encounterId], references: [id])

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id])

  bedId String?
  bed   Bed?    @relation(fields: [bedId], references: [id])

  admittedAt   DateTime  @default(now())
  dischargedAt DateTime?
  status       String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Asset {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  code      String
  name      String
  category  String
  location  String?
  status    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([branchId, code])
}

model TaxCode {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  code String @db.VarChar(32)
  name String @db.VarChar(160)

  taxType TaxType @default(GST)

  // e.g. 18.0000 (supports precise percentages)
  ratePercent Decimal @db.Decimal(7, 4)

  // Optional breakdown (CGST/SGST/IGST), exemptions, notes, etc.
  components Json?

  // Optional default HSN/SAC mapped to this tax code
  hsnSac String? @db.VarChar(16)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  chargeMasterItems ChargeMasterItem[]
  serviceItems      ServiceItem[]
  tariffRates       TariffRate[]
  servicePackages   ServicePackage[]

  @@unique([branchId, code])
  @@index([branchId, taxType, isActive])
}

model Payer {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  code String @db.VarChar(48)
  name String @db.VarChar(160)

  kind     PayerKind @default(OTHER)
  isActive Boolean   @default(true)

  meta Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contracts   PayerContract[]
  tariffPlans TariffPlan[]

  @@unique([branchId, code])
  @@index([branchId, kind, isActive])
}

model PayerContract {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  payerId String
  payer   Payer  @relation(fields: [payerId], references: [id], onDelete: Cascade)

  code String @db.VarChar(48)
  name String @db.VarChar(160)

  status  ContractStatus @default(ACTIVE)
  startAt DateTime?
  endAt   DateTime?

  terms Json?
  meta  Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tariffPlans TariffPlan[]

  @@unique([branchId, code])
  @@index([branchId, payerId, status])
}

model TariffPlan {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  // Option B+ (payer/contract linked price lists)
  kind       TariffPlanKind   @default(PRICE_LIST)
  planStatus TariffPlanStatus @default(DRAFT)

  code String @db.VarChar(48)
  name String @db.VarChar(160)

  description String?

  // Operational flags
  isActive  Boolean @default(true)
  isDefault Boolean @default(false)

  // Legacy fields kept for backward compatibility
  status    String @default("ACTIVE")
  payerType String @default("SELF")

  // Optional linkage: cash price list (no payer/contract) OR contract-based plan
  payerId String?
  payer   Payer?  @relation(fields: [payerId], references: [id], onDelete: SetNull)

  contractId String?
  contract   PayerContract? @relation(fields: [contractId], references: [id], onDelete: SetNull)

  currency       String  @default("INR") @db.VarChar(8)
  isTaxInclusive Boolean @default(false)

  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?

  // plan-level versioning
  version Int @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  rates TariffRate[]

  @@unique([branchId, code])
  @@index([branchId, kind, planStatus])
  @@index([branchId, isDefault])
  @@index([branchId, effectiveFrom])
  @@index([branchId, payerId])
  @@index([branchId, contractId])
}

model ServiceCatalogItem {
  id        String   @id @default(cuid())
  code      String   @unique
  name      String
  category  String
  unit      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TariffRate {
  id           String     @id @default(cuid())
  tariffPlanId String
  tariffPlan   TariffPlan @relation(fields: [tariffPlanId], references: [id], onDelete: Cascade)

  // ✅ Primary rate anchor (Option B)
  chargeMasterItemId String?
  chargeMasterItem   ChargeMasterItem? @relation(fields: [chargeMasterItemId], references: [id], onDelete: SetNull)

  // Legacy anchor (kept for old /billing/tariffs/rates)
  serviceCode String? @db.VarChar(48)

  // Amount & currency
  rateAmount Decimal @db.Decimal(12, 2)
  currency   String  @default("INR") @db.VarChar(8)

  // Optional per-rate overrides
  taxCodeId      String?
  taxCode        TaxCode? @relation(fields: [taxCodeId], references: [id], onDelete: SetNull)
  isTaxInclusive Boolean  @default(false)

  rules Json?
  notes String?

  // Lifecycle & history
  isActive      Boolean   @default(true)
  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?
  version       Int       @default(1)

  createdByUserId String?
  createdByUser   User?   @relation("TariffRateCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tariffPlanId, chargeMasterItemId, version])
  @@unique([tariffPlanId, serviceCode, version])
  @@index([tariffPlanId])
  @@index([tariffPlanId, chargeMasterItemId])
  @@index([tariffPlanId, serviceCode])
}

model ConsentRecord {
  id        String  @id @default(cuid())
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  scope   ConsentScope
  purpose String
  status  ConsentStatus @default(GRANTED)

  createdAt DateTime @default(now())

  @@index([patientId, createdAt])
}

model RtbfRequest {
  id        String  @id @default(cuid())
  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  reason String
  status RtbfStatus @default(REQUESTED)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, createdAt])
  @@index([patientId, createdAt])
}

model StatutoryCase {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  patientId String
  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  program String
  disease String
  status  String @default("DRAFT")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([branchId, updatedAt])
  @@index([program, updatedAt])
  @@index([patientId, updatedAt])
}

model AuditEvent {
  id String @id @default(cuid())

  branchId String?
  branch   Branch? @relation(fields: [branchId], references: [id], onDelete: SetNull)

  actorUserId String?
  actorUser   User?   @relation("AuditActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  action   String
  entity   String
  entityId String?
  meta     Json?

  createdAt DateTime @default(now())

  @@index([branchId, createdAt])
  @@index([actorUserId, createdAt])
  @@index([action, createdAt])
  @@index([entity, entityId])
}

model OutboxEvent {
  id          String       @id @default(cuid())
  topic       String
  key         String?
  payload     Json
  status      OutboxStatus @default(PENDING)
  attempts    Int          @default(0)
  availableAt DateTime     @default(now())
  lockedAt    DateTime?
  sentAt      DateTime?
  error       String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Opposite relation(s)
  staffCredentialAlerts StaffCredentialAlert[]

  @@index([status, availableAt])
}

enum RoleScope {
  GLOBAL
  BRANCH
}

enum RoleVersionStatus {
  DRAFT
  ACTIVE
  RETIRED
}

model Permission {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  category    String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  roleGrants RoleTemplatePermission[]
}

model RoleTemplate {
  id          String    @id @default(cuid())
  code        String    @unique
  name        String
  scope       RoleScope @default(BRANCH)
  description String?
  isSystem    Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  versions             RoleTemplateVersion[]
  staffCompliancePacks StaffCompliancePack[]
}

model RoleTemplateVersion {
  id             String            @id @default(cuid())
  roleTemplateId String
  roleTemplate   RoleTemplate      @relation(fields: [roleTemplateId], references: [id])
  version        Int
  status         RoleVersionStatus @default(DRAFT)
  notes          String?

  createdByUserId String?
  createdByUser   User?   @relation("RoleVersionCreatedBy", fields: [createdByUserId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  permissions RoleTemplatePermission[]

  // NAME THIS RELATION TOO (users assigned to this role version)
  users           User[]            @relation("UserRoleVersion")
  UserRoleBinding UserRoleBinding[]

  @@unique([roleTemplateId, version])
}

model RoleTemplatePermission {
  id            String              @id @default(cuid())
  roleVersionId String
  roleVersion   RoleTemplateVersion @relation(fields: [roleVersionId], references: [id])
  permissionId  String
  permission    Permission          @relation(fields: [permissionId], references: [id])

  // allow/deny flag for future; keep allow-only for now
  allowed Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([roleVersionId, permissionId])
}

// ---------------------------------------------------------------------------
// Policy Governance (global baselines + branch overrides with maker-checker)
// ---------------------------------------------------------------------------

enum PolicyScope {
  GLOBAL
  BRANCH_OVERRIDE
}

enum PolicyVersionStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  RETIRED
}

model PolicyDefinition {
  id          String  @id @default(cuid())
  code        String  @unique
  name        String
  type        String
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Canonical versions for this definition
  versions PolicyVersion[] @relation("PolicyDefinitionVersions")
}

model PolicyVersion {
  id String @id @default(cuid())

  // FK to the policy definition catalog (governance.service.ts expects this)
  policyId String
  policy   PolicyDefinition @relation("PolicyDefinitionVersions", fields: [policyId], references: [id])
  scope    PolicyScope      @default(GLOBAL)
  branchId String?
  branch   Branch?          @relation("PolicyVersion_Branch", fields: [branchId], references: [id], onDelete: SetNull)

  version Int
  status  PolicyVersionStatus @default(DRAFT)

  effectiveAt DateTime @default(now())
  notes       String?
  payload     Json

  applyToAllBranches Boolean               @default(true)
  branches           PolicyVersionBranch[]

  createdByUserId String?
  createdByUser   User?   @relation("PolicyVersionCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  submittedAt       DateTime?
  submittedByUserId String?
  submittedByUser   User?     @relation("PolicyVersionSubmittedBy", fields: [submittedByUserId], references: [id], onDelete: SetNull)

  approvedAt       DateTime?
  approvedByUserId String?
  approvedByUser   User?     @relation("PolicyVersionApprovedBy", fields: [approvedByUserId], references: [id], onDelete: SetNull)
  approvalNote     String?

  rejectedAt       DateTime?
  rejectedByUserId String?
  rejectedByUser   User?     @relation("PolicyVersionRejectedBy", fields: [rejectedByUserId], references: [id], onDelete: SetNull)
  rejectionReason  String?

  retiredAt       DateTime?
  retiredByUserId String?
  retiredByUser   User?     @relation("PolicyVersionRetiredBy", fields: [retiredByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // NOTE: We intentionally model the relation via policyId.
  // Any legacy/experimental policyDefinitionId field was removed to keep the schema unambiguous.

  @@index([policyId, scope, status])
  @@index([branchId, status])
  @@index([policyId, scope, version])
  @@index([policyId, branchId, version])
}

model PolicyVersionBranch {
  id              String        @id @default(cuid())
  policyVersionId String
  policyVersion   PolicyVersion @relation(fields: [policyVersionId], references: [id], onDelete: Cascade)

  branchId String
  branch   Branch @relation("PolicyTarget_Branch", fields: [branchId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([policyVersionId, branchId])
  @@index([branchId])
}

// ---------------------------------------------------------------------------
// Infrastructure / Setup Studio (Admin Branch Onboarding)
// ---------------------------------------------------------------------------

enum LocationKind {
  CAMPUS
  BUILDING
  FLOOR
  ZONE
  AREA
}

model LocationNode {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  kind     LocationKind
  parentId String?
  parent   LocationNode?  @relation("LocationTree", fields: [parentId], references: [id])
  children LocationNode[] @relation("LocationTree")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Units mapped to this location node
  units                   Unit[]
  revisions               LocationNodeRevision[]
  // OT Setup mappings
  otSuites                OtSuite[]                @relation("OtSuite_LocationNode")
  otSpaces                OtSpace[]                @relation("OtSpace_LocationNode")
  // Diagnostics setup mappings
  diagnosticServicePoints DiagnosticServicePoint[]
  EquipmentPlacement      EquipmentPlacement[]
  departmentLocations     DepartmentLocation[]

  @@index([branchId, kind])
  @@index([branchId, parentId])
}

model LocationNodeRevision {
  id     String       @id @default(cuid())
  nodeId String
  node   LocationNode @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  code     String
  name     String
  isActive Boolean @default(true)

  // 2.2.2 Location Attributes
  gpsLat      Float?
  gpsLng      Float?
  floorNumber Int?

  wheelchairAccess Boolean @default(false)
  stretcherAccess  Boolean @default(false)
  emergencyExit    Boolean @default(false)

  fireZone String?

  effectiveFrom DateTime
  effectiveTo   DateTime?

  createdByUserId String?
  createdByUser   User?   @relation("LocationRevisionCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([nodeId, effectiveFrom])
  @@index([code])
}

// ---------------- Unit Types Enablement ----------------
enum UnitRoomType {
  CONSULTATION
  PROCEDURE
  EXAMINATION
  PATIENT_ROOM
  ISOLATION
  NEGATIVE_PRESSURE
  POSITIVE_PRESSURE
  NURSING_STATION
  WAITING
  STORAGE
  UTILITY
  RECOVERY
}

enum IsolationType {
  CONTACT
  DROPLET
  AIRBORNE
  PROTECTIVE
}

enum MaintenanceStatus {
  OPERATIONAL
  UNDER_MAINTENANCE
  CLEANING_IN_PROGRESS
  BLOCKED
  OUT_OF_SERVICE
}

enum UnitCategory {
  OUTPATIENT
  INPATIENT
  CRITICAL_CARE
  PROCEDURE
  DIAGNOSTIC
  SUPPORT
}

enum PricingTier {
  ECONOMY
  STANDARD
  DELUXE
  SUITE
  VIP
}

model UnitTypeCatalog {
  id   String @id @default(cuid())
  code String @unique @db.VarChar(32)
  name String @db.VarChar(120)

  category UnitCategory @default(OUTPATIENT)

  usesRoomsDefault       Boolean @default(true)
  schedulableByDefault   Boolean @default(false)
  bedBasedDefault        Boolean @default(false)
  requiresPreAuthDefault Boolean @default(false)

  isActive  Boolean @default(true)
  sortOrder Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  branchLinks BranchUnitType[]
  units       Unit[]

  defaultOperatingHours Json?
  standardEquipment     Json?

  isSystemDefined Boolean @default(false)

  @@index([category])
  @@index([isActive, sortOrder])
}

model BranchUnitType {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  unitTypeId String
  unitType   UnitTypeCatalog @relation(fields: [unitTypeId], references: [id], onDelete: Cascade)

  isEnabled Boolean   @default(true)
  enabledAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([branchId, unitTypeId], name: "branchId_unitTypeId")
  @@index([branchId, isEnabled])
}

// ---------------- Units / Rooms / Resources ----------------

enum UnitResourceType {
  // Bed Resources
  GENERAL_BED
  ICU_BED
  NICU_INCUBATOR
  CRIB
  TROLLEY
  STRETCHER
  WHEELCHAIR_POSITION

  // Procedure Resources
  OT_TABLE
  DIALYSIS_STATION
  CHEMOTHERAPY_CHAIR
  PROCEDURE_CHAIR
  PROCEDURE_TABLE
  RECOVERY_BAY
  DENTAL_CHAIR
  EXAMINATION_TABLE

  // Diagnostic Resources
  XRAY_MACHINE_SLOT
  CT_SCANNER_SLOT
  MRI_SCANNER_SLOT
  USG_MACHINE_SLOT
  ECG_MACHINE_SLOT
  ECHO_MACHINE_SLOT
  SAMPLE_COLLECTION_COUNTER

  // Other / Slots
  CONSULTATION_SLOT
  EXAM_SLOT

  // Legacy (kept for backward compatibility)
  BED
  BAY
  CHAIR
  INCUBATOR
}

enum UnitResourceState {
  AVAILABLE
  RESERVED
  OCCUPIED
  CLEANING
  SANITIZATION
  MAINTENANCE
  BLOCKED
  INACTIVE
}

enum UnitResourceCategory {
  BED
  PROCEDURE
  DIAGNOSTIC
  CONSULTATION
  OTHER
}

model Unit {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  // Location binding: unit belongs to a specific location node under the same branch
  locationNodeId String?
  locationNode   LocationNode? @relation(fields: [locationNodeId], references: [id], onDelete: Restrict)

  departmentId String
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Restrict)

  unitTypeId String
  unitType   UnitTypeCatalog @relation(fields: [unitTypeId], references: [id], onDelete: Restrict)

  code              String    @db.VarChar(32)
  name              String    @db.VarChar(160)
  // Physical / capacity metadata (captured during onboarding; optional)
  totalRoomCount    Int       @default(0)
  totalBedCapacity  Int?
  commissioningDate DateTime?

  // Convenience fields (optional; can be derived from Location/Staff modules)
  floorNumber     Int?
  wingZone        String? @db.VarChar(120)
  inchargeStaffId String? @db.VarChar(64)
  nursingStation  String? @db.VarChar(160)

  usesRooms Boolean @default(true)
  isActive  Boolean @default(true)

  // Soft deactivation metadata (future-proof; aligns with BRD reason-required flows)
  deactivatedAt       DateTime?
  deactivationReason  String?   @db.VarChar(500)
  deactivatedByUserId String?
  deactivatedByUser   User?     @relation("UnitDeactivatedBy", fields: [deactivatedByUserId], references: [id], onDelete: SetNull)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  rooms                   UnitRoom[]
  resources               UnitResource[]
  bookings                ProcedureBooking[]
  // Diagnostics: service points optionally linked to this unit
  diagnosticServicePoints DiagnosticServicePoint[]
  EquipmentPlacement      EquipmentPlacement[]
  StaffAssignment         StaffAssignment[]

  @@unique([branchId, code], name: "branchId_unitCode")
  @@index([branchId, departmentId, isActive])
  @@index([branchId, locationNodeId, isActive])
}

model UnitRoom {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  unitId String
  unit   Unit   @relation(fields: [unitId], references: [id], onDelete: Cascade)

  code       String  @db.VarChar(64)
  roomNumber String? @db.VarChar(32) // UI will require; DB kept nullable for safe migration
  name       String  @db.VarChar(160)

  roomType UnitRoomType?

  // Physical Attributes
  areaSqFt            Int?
  hasAttachedBathroom Boolean @default(false)
  hasAC               Boolean @default(false)
  hasTV               Boolean @default(false)
  hasOxygen           Boolean @default(false)
  hasSuction          Boolean @default(false)
  hasVentilator       Boolean @default(false)
  hasMonitor          Boolean @default(false)
  hasCallButton       Boolean @default(false)

  // Capacity
  maxOccupancy     Int @default(1)
  currentOccupancy Int @default(0)

  // Pricing
  pricingTier      PricingTier?
  baseChargePerDay Decimal?     @db.Decimal(12, 2)

  // Isolation/Special
  isIsolation   Boolean        @default(false)
  isolationType IsolationType?

  // Status
  isActive          Boolean           @default(true)
  isAvailable       Boolean           @default(true)
  maintenanceStatus MaintenanceStatus @default(OPERATIONAL)
  lastCleanedAt     DateTime?

  // Soft deactivation metadata (future-proof)
  deactivatedAt       DateTime?
  deactivationReason  String?   @db.VarChar(500)
  deactivatedByUserId String?
  deactivatedByUser   User?     @relation("UnitRoomDeactivatedBy", fields: [deactivatedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  resources                   UnitResource[]
  diagnosticServicePointRooms DiagnosticServicePointRoom[]
  diagnosticCapabilityRooms   DiagnosticCapabilityRoom[]
  EquipmentPlacement          EquipmentPlacement[]

  @@unique([unitId, code], name: "unitId_roomCode")
  @@unique([unitId, roomNumber], name: "unitId_roomNumber")
  @@index([branchId, unitId, isActive])
  @@index([deactivatedByUserId])
}

model UnitResource {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  unitId String
  unit   Unit   @relation(fields: [unitId], references: [id], onDelete: Cascade)

  roomId String?
  room   UnitRoom? @relation(fields: [roomId], references: [id], onDelete: SetNull)

  resourceType UnitResourceType
  code         String           @db.VarChar(96)
  assetTag     String?          @db.VarChar(64)
  name         String           @db.VarChar(160)

  // Category (required by interface; nullable for legacy rows)
  resourceCategory UnitResourceCategory?

  // Specifications
  manufacturer String? @db.VarChar(120)
  model        String? @db.VarChar(120)
  serialNumber String? @db.VarChar(120)

  // Capabilities
  hasMonitor           Boolean @default(false)
  hasOxygenSupply      Boolean @default(false)
  hasSuction           Boolean @default(false)
  hasVentilatorSupport Boolean @default(false)
  isPowerRequired      Boolean @default(false)

  // State Management
  state             UnitResourceState @default(AVAILABLE)
  isActive          Boolean           @default(true)
  assignedPatientId String?           @db.VarChar(64)

  // Scheduling
  isSchedulable       Boolean @default(false)
  slotDurationMinutes Int?

  // Maintenance
  lastMaintenanceDate DateTime?
  nextMaintenanceDate DateTime?
  warrantyExpiryDate  DateTime?

  // Commissioning
  commissionedAt DateTime?

  reservedReason String? @db.VarChar(500)
  blockedReason  String? @db.VarChar(500)

  createdAt                       DateTime                         @default(now())
  updatedAt                       DateTime                         @updatedAt
  deactivatedAt                   DateTime?
  deactivationReason              String?                          @db.VarChar(500)
  deactivatedByUserId             String?
  deactivatedByUser               User?                            @relation("UnitResourceDeactivatedBy", fields: [deactivatedByUserId], references: [id], onDelete: SetNull)
  bookings                        ProcedureBooking[]
  // Diagnostics mappings
  diagnosticServicePointResources DiagnosticServicePointResource[]
  diagnosticCapabilityResources   DiagnosticCapabilityResource[]
  EquipmentPlacement              EquipmentPlacement[]

  @@unique([unitId, code], name: "unitId_resourceCode")
  @@unique([branchId, assetTag], name: "branchId_resourceAssetTag")
  @@index([branchId, unitId, isActive])
  @@index([branchId, resourceType, isSchedulable])
  @@index([branchId, assetTag])
  @@index([deactivatedByUserId])
}

model BranchInfraConfig {
  id       String @id @default(cuid())
  branchId String @unique
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  housekeepingGateEnabled Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ---------------- Equipment Register ----------------

enum EquipmentCategory {
  GENERAL
  RADIOLOGY
  ULTRASOUND
}

enum EquipmentOperationalStatus {
  OPERATIONAL
  DOWN
  MAINTENANCE
  RETIRED
}

model EquipmentAsset {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  code String @db.VarChar(64)
  name String @db.VarChar(160)

  category EquipmentCategory @default(GENERAL)

  make   String?
  model  String?
  serial String?

  ownerDepartmentId String?
  ownerDepartment   Department? @relation("EquipmentOwnerDepartment", fields: [ownerDepartmentId], references: [id], onDelete: SetNull)

  unitId         String?
  roomId         String?
  locationNodeId String?

  operationalStatus EquipmentOperationalStatus @default(OPERATIONAL)

  amcVendor       String?
  amcValidFrom    DateTime?
  amcValidTo      DateTime?
  warrantyValidTo DateTime?

  pmFrequencyDays Int?
  nextPmDueAt     DateTime?

  aerbLicenseNo String?
  aerbValidTo   DateTime?

  pcpndtRegNo   String?
  pcpndtValidTo DateTime?

  isSchedulable Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  downtimeTickets                 DowntimeTicket[]
  // Diagnostics mappings
  diagnosticServicePointEquipment DiagnosticServicePointEquipment[]
  diagnosticCapabilityEquipment   DiagnosticCapabilityEquipment[]

  // Equipment Register extensions
  placement  EquipmentPlacement?
  revisions  EquipmentAssetRevision[]
  movements  EquipmentMovement[]
  documents  EquipmentDocument[]
  contracts  EquipmentContract[]
  maintTasks EquipmentMaintenanceTask[]
  evidences  EquipmentComplianceEvidence[]

  @@unique([branchId, code], name: "branchId_equipmentCode")
  @@index([branchId, category])
}

enum DowntimeStatus {
  OPEN
  CLOSED
}

model DowntimeTicket {
  id      String         @id @default(cuid())
  assetId String
  asset   EquipmentAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  reason String
  notes  String?
  status DowntimeStatus @default(OPEN)

  openedAt DateTime  @default(now())
  closedAt DateTime?

  createdAt                DateTime                   @default(now())
  updatedAt                DateTime                   @updatedAt
  EquipmentMaintenanceTask EquipmentMaintenanceTask[]

  @@index([assetId, status])
}

// ---------------- Service Catalog + Charge Master + Mapping ----------------

model ChargeMasterItem {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  code String @db.VarChar(48)
  name String @db.VarChar(160)

  category String?
  unit     String?

  // ✅ Charge unit enforcement (end-to-end)
  chargeUnit ServiceChargeUnit @default(PER_UNIT)

  // ✅ Tax mapping (preferred over placeholder enums)
  taxCodeId      String?
  taxCode        TaxCode? @relation(fields: [taxCodeId], references: [id], onDelete: SetNull)
  isTaxInclusive Boolean  @default(false)
  hsnSac         String?  @db.VarChar(16)

  // Optional: rounding/deposit/refund/etc.
  billingPolicy Json?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  mappings                ServiceChargeMapping[]
  ServicePackageComponent ServicePackageComponent[]
  tariffRates             TariffRate[]
  billedPackages          ServicePackage[]          @relation("ServicePackage_BillingChargeMaster")

  @@unique([branchId, code], name: "branchId_code")
  @@index([branchId, isActive])
  @@index([branchId, taxCodeId])
}

model ServiceItem {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  code String @db.VarChar(48)
  name String @db.VarChar(160)

  // Legacy categorization (keep)
  category String  @db.VarChar(80)
  unit     String?

  // Advanced typing
  type ServiceItemType @default(OTHER)

  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  externalId String? @db.VarChar(80)

  // Optional OT/procedure metadata
  procedureKind   String? @db.VarChar(80)
  anesthesiaClass String? @db.VarChar(80)

  // Orderability + lifecycle
  isOrderable     Boolean                @default(true)
  isActive        Boolean                @default(true)
  isBillable      Boolean                @default(true)
  lifecycleStatus ServiceLifecycleStatus @default(PUBLISHED)

  // Governance / workflow actors (maker-checker)
  createdByUserId   String?
  createdByUser     User?     @relation("ServiceItemCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  updatedByUserId   String?
  updatedByUser     User?     @relation("ServiceItemUpdatedBy", fields: [updatedByUserId], references: [id], onDelete: SetNull)
  submittedByUserId String?
  submittedByUser   User?     @relation("ServiceItemSubmittedBy", fields: [submittedByUserId], references: [id], onDelete: SetNull)
  submittedAt       DateTime?
  approvedByUserId  String?
  approvedByUser    User?     @relation("ServiceItemApprovedBy", fields: [approvedByUserId], references: [id], onDelete: SetNull)
  approvedAt        DateTime?
  publishedByUserId String?
  publishedByUser   User?     @relation("ServiceItemPublishedBy", fields: [publishedByUserId], references: [id], onDelete: SetNull)
  publishedAt       DateTime?

  // Clinical & ordering constraints (structured + text)
  consentRequired       Boolean @default(false)
  preparationText       String?
  instructionsText      String?
  contraindicationsText String?

  minAgeYears       Int?
  maxAgeYears       Int?
  genderRestriction String? @db.VarChar(16) // "MALE"|"FEMALE"|"OTHER" or your convention
  cooldownMins      Int? // duplicate-order rule window (simple)

  // Operational definition
  requiresAppointment   Boolean @default(false)
  estimatedDurationMins Int?
  prepMins              Int?
  recoveryMins          Int?
  tatMinsRoutine        Int?
  tatMinsStat           Int?

  // Billing definition
  chargeUnit       ServiceChargeUnit?
  taxApplicability TaxApplicability?
  taxCodeId        String?
  taxCode          TaxCode?           @relation(fields: [taxCodeId], references: [id], onDelete: SetNull)
  billingPolicy    Json? // rounding, deposit, refund, inclusive/exclusive flags, etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  mappings ServiceChargeMapping[]
  fixIts   FixItTask[]

  // Optional: link to DiagnosticItem (unified orderables)
  diagnosticItem       DiagnosticItem?                  @relation("DiagnosticItem_ServiceItem")
  // Advanced child tables
  aliases              ServiceItemAlias[]
  contexts             ServiceItemContext[]
  resourceRequirements ServiceItemResourceRequirement[]
  clinicalRules        ServiceItemClinicalRule[]
  seriesPolicies       ServiceSeriesPolicy[]
  versions             ServiceItemVersion[]

  // Cataloguing
  catalogueItems              ServiceCatalogueItem[]
  ServicePackageComponent     ServicePackageComponent[]
  OrderSetItem                OrderSetItem[]
  ServiceItemStandardMapping  ServiceItemStandardMapping[]
  ServiceAvailabilityCalendar ServiceAvailabilityCalendar[]
  ExternalDirectoryMapping    ExternalDirectoryMapping[]

  @@unique([branchId, code], name: "branchId_serviceCode")
  @@unique([branchId, externalId], name: "branchId_serviceExternalId")
  @@index([branchId, category, isActive])
  @@index([branchId, type, isActive])
  @@index([branchId, lifecycleStatus, isActive])
}

model ServiceItemAlias {
  id            String      @id @default(cuid())
  serviceItemId String
  serviceItem   ServiceItem @relation(fields: [serviceItemId], references: [id], onDelete: Cascade)

  alias    String  @db.VarChar(160)
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([serviceItemId, alias])
  @@index([serviceItemId, isActive])
}

model ServiceItemContext {
  id            String      @id @default(cuid())
  serviceItemId String
  serviceItem   ServiceItem @relation(fields: [serviceItemId], references: [id], onDelete: Cascade)

  context   CareContext
  isEnabled Boolean     @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([serviceItemId, context])
  @@index([serviceItemId, isEnabled])
}

model ServiceItemResourceRequirement {
  id            String      @id @default(cuid())
  serviceItemId String
  serviceItem   ServiceItem @relation(fields: [serviceItemId], references: [id], onDelete: Cascade)

  resourceType UnitResourceType
  quantity     Int              @default(1)

  // optional constraints for readiness / go-live rules
  constraints Json?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([serviceItemId, resourceType, isActive])
}

model ServiceItemClinicalRule {
  id            String      @id @default(cuid())
  serviceItemId String
  serviceItem   ServiceItem @relation(fields: [serviceItemId], references: [id], onDelete: Cascade)

  // e.g. "REQUIRES_DIAGNOSIS", "PREGNANCY_WARNING", "DUPLICATE_ORDER_COOLDOWN"
  ruleType String  @db.VarChar(64)
  payload  Json?
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([serviceItemId, ruleType, isActive])
}

model ServiceSeriesPolicy {
  id            String      @id @default(cuid())
  serviceItemId String
  serviceItem   ServiceItem @relation(fields: [serviceItemId], references: [id], onDelete: Cascade)

  totalSessions     Int?
  maxSessionsPerDay Int?
  expiryDays        Int?
  scheduleTemplate  Json?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([serviceItemId, isActive])
}

model ServiceItemVersion {
  id            String      @id @default(cuid())
  serviceItemId String
  serviceItem   ServiceItem @relation(fields: [serviceItemId], references: [id], onDelete: Cascade)

  version Int
  status  ServiceLifecycleStatus

  snapshot Json

  createdByUserId String?
  createdByUser   User?   @relation("ServiceItemVersionCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([serviceItemId, version])
  @@index([serviceItemId, effectiveFrom])
}

model ServiceChargeMapping {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  serviceItemId String
  serviceItem   ServiceItem @relation(fields: [serviceItemId], references: [id], onDelete: Cascade)

  chargeMasterItemId String
  chargeMasterItem   ChargeMasterItem @relation(fields: [chargeMasterItemId], references: [id], onDelete: Cascade)

  effectiveFrom DateTime
  effectiveTo   DateTime?
  version       Int       @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([branchId, serviceItemId, effectiveFrom])
}

model ServiceCatalogue {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  code String @db.VarChar(48)
  name String @db.VarChar(160)

  description String?

  scope   CatalogueScope   @default(BRANCH)
  channel CatalogueChannel @default(DEFAULT)

  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  context    CareContext?
  payerGroup String?

  status  CatalogueStatus @default(DRAFT)
  version Int             @default(1)

  // Governance / workflow actors (maker-checker)
  createdByUserId   String?
  createdByUser     User?     @relation("ServiceCatalogueCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  updatedByUserId   String?
  updatedByUser     User?     @relation("ServiceCatalogueUpdatedBy", fields: [updatedByUserId], references: [id], onDelete: SetNull)
  submittedByUserId String?
  submittedByUser   User?     @relation("ServiceCatalogueSubmittedBy", fields: [submittedByUserId], references: [id], onDelete: SetNull)
  submittedAt       DateTime?
  approvedByUserId  String?
  approvedByUser    User?     @relation("ServiceCatalogueApprovedBy", fields: [approvedByUserId], references: [id], onDelete: SetNull)
  approvedAt        DateTime?
  publishedByUserId String?
  publishedByUser   User?     @relation("ServiceCataloguePublishedBy", fields: [publishedByUserId], references: [id], onDelete: SetNull)
  publishedAt       DateTime?

  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items    ServiceCatalogueItem[]
  versions ServiceCatalogueVersion[]

  @@unique([branchId, code])
  @@index([branchId, channel, status])
  @@index([branchId, context, status])
  @@index([branchId, payerGroup, status])
}

model ServiceCatalogueItem {
  id          String           @id @default(cuid())
  catalogueId String
  catalogue   ServiceCatalogue @relation(fields: [catalogueId], references: [id], onDelete: Cascade)

  serviceItemId String
  serviceItem   ServiceItem @relation(fields: [serviceItemId], references: [id], onDelete: Restrict)

  sortOrder Int     @default(0)
  isVisible Boolean @default(true)

  // Overrides: price/TAT/resource mapping/availability flags etc (payer/branch can override)
  overrides Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([catalogueId, serviceItemId])
  @@index([catalogueId, sortOrder])
}

model ServiceCatalogueVersion {
  id          String           @id @default(cuid())
  catalogueId String
  catalogue   ServiceCatalogue @relation(fields: [catalogueId], references: [id], onDelete: Cascade)

  version Int
  status  CatalogueStatus

  snapshot Json

  createdByUserId String?
  createdByUser   User?   @relation("ServiceCatalogueVersionCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  effectiveFrom DateTime
  effectiveTo   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([catalogueId, version])
  @@index([catalogueId, effectiveFrom])
}

model ServicePackage {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  code String @db.VarChar(48)
  name String @db.VarChar(160)

  description String?

  status  PackageStatus @default(DRAFT)
  version Int           @default(1)

  // ✅ Package pricing rules
  pricingMode   PackagePricingMode @default(COMPONENT_SUM)
  pricingValue  Decimal?           @db.Decimal(12, 2)
  pricingPolicy Json?

  // If billed as a single line item
  billingChargeMasterItemId String?
  billingChargeMasterItem   ChargeMasterItem? @relation("ServicePackage_BillingChargeMaster", fields: [billingChargeMasterItemId], references: [id], onDelete: SetNull)

  // Charge unit for package billing
  chargeUnit ServiceChargeUnit @default(PER_PACKAGE)

  // Tax for package line (optional)
  taxCodeId      String?
  taxCode        TaxCode? @relation(fields: [taxCodeId], references: [id], onDelete: SetNull)
  isTaxInclusive Boolean  @default(false)

  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?

  // Governance / workflow actors (maker-checker)
  createdByUserId   String?
  createdByUser     User?     @relation("ServicePackageCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  updatedByUserId   String?
  updatedByUser     User?     @relation("ServicePackageUpdatedBy", fields: [updatedByUserId], references: [id], onDelete: SetNull)
  submittedByUserId String?
  submittedByUser   User?     @relation("ServicePackageSubmittedBy", fields: [submittedByUserId], references: [id], onDelete: SetNull)
  submittedAt       DateTime?
  approvedByUserId  String?
  approvedByUser    User?     @relation("ServicePackageApprovedBy", fields: [approvedByUserId], references: [id], onDelete: SetNull)
  approvedAt        DateTime?
  publishedByUserId String?
  publishedByUser   User?     @relation("ServicePackagePublishedBy", fields: [publishedByUserId], references: [id], onDelete: SetNull)
  publishedAt       DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  components   ServicePackageComponent[]
  versions     ServicePackageVersion[]
  OrderSetItem OrderSetItem[]

  @@unique([branchId, code])
  @@index([branchId, status])
  @@index([branchId, pricingMode])
}

model ServicePackageComponent {
  id        String         @id @default(cuid())
  packageId String
  pkg       ServicePackage @relation(fields: [packageId], references: [id], onDelete: Cascade)

  componentType PackageComponentType

  serviceItemId      String?
  diagnosticItemId   String?
  chargeMasterItemId String?

  serviceItem    ServiceItem?      @relation(fields: [serviceItemId], references: [id], onDelete: Restrict)
  diagnosticItem DiagnosticItem?   @relation(fields: [diagnosticItemId], references: [id], onDelete: Restrict)
  chargeMaster   ChargeMasterItem? @relation(fields: [chargeMasterItemId], references: [id], onDelete: Restrict)

  quantity   Int     @default(1)
  isIncluded Boolean @default(true)

  // Conditional rules, auto-add, exclusions, etc.
  condition Json?

  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([packageId, sortOrder])
}

model ServicePackageVersion {
  id        String         @id @default(cuid())
  packageId String
  pkg       ServicePackage @relation(fields: [packageId], references: [id], onDelete: Cascade)

  version Int
  status  PackageStatus

  snapshot Json

  createdByUserId String?
  createdByUser   User?   @relation("ServicePackageVersionCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  effectiveFrom DateTime
  effectiveTo   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([packageId, version])
  @@index([packageId, effectiveFrom])
}

model OrderSet {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  code String @db.VarChar(48)
  name String @db.VarChar(160)

  description String?

  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  context CareContext?
  channel CatalogueChannel @default(ORDER_SET)

  status  OrderSetStatus @default(DRAFT)
  version Int            @default(1)

  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?

  // Governance / workflow actors (maker-checker)
  createdByUserId   String?
  createdByUser     User?     @relation("OrderSetCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  updatedByUserId   String?
  updatedByUser     User?     @relation("OrderSetUpdatedBy", fields: [updatedByUserId], references: [id], onDelete: SetNull)
  submittedByUserId String?
  submittedByUser   User?     @relation("OrderSetSubmittedBy", fields: [submittedByUserId], references: [id], onDelete: SetNull)
  submittedAt       DateTime?
  approvedByUserId  String?
  approvedByUser    User?     @relation("OrderSetApprovedBy", fields: [approvedByUserId], references: [id], onDelete: SetNull)
  approvedAt        DateTime?
  publishedByUserId String?
  publishedByUser   User?     @relation("OrderSetPublishedBy", fields: [publishedByUserId], references: [id], onDelete: SetNull)
  publishedAt       DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items    OrderSetItem[]
  versions OrderSetVersion[]

  @@unique([branchId, code])
  @@index([branchId, context, status])
  @@index([branchId, departmentId, status])
}

model OrderSetItem {
  id         String   @id @default(cuid())
  orderSetId String
  orderSet   OrderSet @relation(fields: [orderSetId], references: [id], onDelete: Cascade)

  itemType OrderSetItemType

  serviceItemId    String?
  diagnosticItemId String?
  packageId        String?

  serviceItem    ServiceItem?    @relation(fields: [serviceItemId], references: [id], onDelete: Restrict)
  diagnosticItem DiagnosticItem? @relation(fields: [diagnosticItemId], references: [id], onDelete: Restrict)
  pkg            ServicePackage? @relation(fields: [packageId], references: [id], onDelete: Restrict)

  quantity   Int     @default(1)
  isOptional Boolean @default(false)
  rules      Json?

  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderSetId, sortOrder])
}

model OrderSetVersion {
  id         String   @id @default(cuid())
  orderSetId String
  orderSet   OrderSet @relation(fields: [orderSetId], references: [id], onDelete: Cascade)

  version Int
  status  OrderSetStatus

  snapshot Json

  createdByUserId String?
  createdByUser   User?   @relation("OrderSetVersionCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  effectiveFrom DateTime
  effectiveTo   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([orderSetId, version])
  @@index([orderSetId, effectiveFrom])
}

model StandardCodeSet {
  id          String             @id @default(cuid())
  code        String             @db.VarChar(48)
  name        String             @db.VarChar(160)
  system      StandardCodeSystem @default(INTERNAL)
  description String?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  entries StandardCodeEntry[]

  @@unique([system, code])
  @@index([system, isActive])
}

model StandardCodeEntry {
  id        String          @id @default(cuid())
  codeSetId String
  codeSet   StandardCodeSet @relation(fields: [codeSetId], references: [id], onDelete: Cascade)

  code     String  @db.VarChar(64)
  display  String  @db.VarChar(200)
  category String?

  attributes Json?

  isActive Boolean @default(true)

  createdAt                  DateTime                     @default(now())
  updatedAt                  DateTime                     @updatedAt
  ServiceItemStandardMapping ServiceItemStandardMapping[]

  @@unique([codeSetId, code])
  @@index([codeSetId, isActive])
}

model ServiceItemStandardMapping {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  serviceItemId String
  serviceItem   ServiceItem @relation(fields: [serviceItemId], references: [id], onDelete: Cascade)

  entryId String
  entry   StandardCodeEntry @relation(fields: [entryId], references: [id], onDelete: Restrict)

  isPrimary Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([branchId, serviceItemId, entryId])
  @@index([branchId, isPrimary])
}

model ServiceAvailabilityCalendar {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  serviceItemId String
  serviceItem   ServiceItem @relation(fields: [serviceItemId], references: [id], onDelete: Cascade)

  name     String  @db.VarChar(160)
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  rules     ServiceAvailabilityRule[]
  blackouts ServiceBlackout[]

  @@index([branchId, isActive])
  @@index([serviceItemId, isActive])
}

model ServiceAvailabilityRule {
  id         String                      @id @default(cuid())
  calendarId String
  calendar   ServiceAvailabilityCalendar @relation(fields: [calendarId], references: [id], onDelete: Cascade)

  dayOfWeek   Int // 0=Sun..6=Sat
  startMinute Int // 0..1439
  endMinute   Int // 1..1440
  capacity    Int @default(0)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([calendarId, dayOfWeek, isActive])
}

model ServiceBlackout {
  id         String                      @id @default(cuid())
  calendarId String
  calendar   ServiceAvailabilityCalendar @relation(fields: [calendarId], references: [id], onDelete: Cascade)

  from DateTime
  to   DateTime

  reason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([calendarId, from])
}

model ExternalDirectorySource {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  systemType ExternalSystemType
  name       String             @db.VarChar(160)

  // optional metadata (endpoint names, directory names, credentials ref, etc.)
  meta Json?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  entries  ExternalDirectoryEntry[]
  mappings ExternalDirectoryMapping[]

  @@index([branchId, systemType, isActive])
}

model ExternalDirectoryEntry {
  id       String                  @id @default(cuid())
  sourceId String
  source   ExternalDirectorySource @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  externalCode String @db.VarChar(80)
  name         String @db.VarChar(200)

  // e.g. "SERVICE_ITEM", "DIAGNOSTIC_ITEM"
  kind String @db.VarChar(40)

  payload Json?

  isActive Boolean @default(true)

  createdAt                DateTime                   @default(now())
  updatedAt                DateTime                   @updatedAt
  ExternalDirectoryMapping ExternalDirectoryMapping[]

  @@unique([sourceId, externalCode])
  @@index([sourceId, kind, isActive])
}

model ExternalDirectoryMapping {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  sourceId String
  source   ExternalDirectorySource @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  entryId String
  entry   ExternalDirectoryEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)

  serviceItemId String?
  serviceItem   ServiceItem? @relation(fields: [serviceItemId], references: [id], onDelete: SetNull)

  status    String  @default("MAPPED")
  isPrimary Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([branchId, sourceId, entryId])
  @@index([branchId, isPrimary])
}

// ---------------- Fix-It Queue ----------------

enum FixItTaskType {
  SERVICE_CHARGE_MAPPING_MISSING
  SERVICE_AVAILABILITY_MISSING
  TARIFF_RATE_MISSING
  TAX_CODE_MISSING
  TAX_CODE_INACTIVE
  PACKAGE_PRICING_MISSING
  CHARGE_UNIT_MISMATCH
  CLONE_MISSING_SERVICE_ITEM
  CLONE_MISSING_DIAGNOSTIC_ITEM
  CLONE_MISSING_CHARGE_MASTER_ITEM
}

enum FixItEntityType {
  SERVICE_ITEM
  CHARGE_MASTER_ITEM
  TAX_CODE
  TARIFF_PLAN
  TARIFF_RATE
  SERVICE_CATALOGUE
  SERVICE_PACKAGE
  ORDER_SET
  DIAGNOSTIC_ITEM
}

enum FixItSeverity {
  BLOCKER
  WARNING
  INFO
}

enum FixItStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  DISMISSED
}

model FixItTask {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  type     FixItTaskType
  status   FixItStatus   @default(OPEN)
  severity FixItSeverity @default(BLOCKER)

  entityType FixItEntityType?
  entityId   String?

  title   String
  details Json?

  serviceItemId String?
  serviceItem   ServiceItem? @relation(fields: [serviceItemId], references: [id], onDelete: SetNull)

  assignedToUserId String?
  assignedToUser   User?   @relation("FixItAssignedTo", fields: [assignedToUserId], references: [id], onDelete: SetNull)

  resolvedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([branchId, status])
  @@index([branchId, severity, status])
  @@index([branchId, entityType])
}

// ---------------- Bulk Import Jobs ----------------

enum BulkImportStatus {
  VALIDATED
  COMMITTED
  FAILED
}

enum BulkImportEntityType {
  LOCATIONS
  UNITS
  ROOMS
  RESOURCES
  EQUIPMENT
  SERVICE_ITEMS
  CHARGE_MASTER
}

model BulkImportJob {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  entityType BulkImportEntityType
  status     BulkImportStatus     @default(VALIDATED)

  fileName String?

  payload Json
  errors  Json?

  totalRows   Int
  validRows   Int
  invalidRows Int

  committedAt DateTime?

  createdByUserId String?
  createdByUser   User?   @relation("ImportJobCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([branchId, entityType, status])
}

// ---------------- Scheduling (OT / Procedure-capable Units) ----------------

enum BookingStatus {
  SCHEDULED
  CANCELLED
  COMPLETED
}

model ProcedureBooking {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  unitId String
  unit   Unit   @relation(fields: [unitId], references: [id], onDelete: Cascade)

  resourceId String
  resource   UnitResource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  patientId    String?
  departmentId String?

  startAt DateTime
  endAt   DateTime
  status  BookingStatus @default(SCHEDULED)

  consentOk    Boolean @default(false)
  anesthesiaOk Boolean @default(false)
  checklistOk  Boolean @default(false)

  createdByUserId String?
  createdByUser   User?   @relation("BookingCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  cancelledAt DateTime?

  createdAt DateTime @default(now())

  @@index([branchId, resourceId, startAt, endAt])
  @@index([branchId, unitId, startAt])
}

// ---------------- Go-Live Validator Snapshot ----------------

model GoLiveReport {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  score    Int
  blockers Json
  warnings Json
  snapshot Json

  createdByUserId String?
  createdByUser   User?   @relation("GoLiveCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([branchId, createdAt])
}

// =========================
// Operation Theatre Setup
// =========================

enum OtSuiteStatus {
  draft
  ready
  active
  booked
  in_use
  maintenance
  archived
}

enum OtSpaceType {
  THEATRE
  RECOVERY_BAY
  PREOP_HOLDING
  INDUCTION_ROOM
  SCRUB_ROOM
  STERILE_STORE
  ANESTHESIA_STORE
  EQUIPMENT_STORE
  STAFF_CHANGE
  OTHER
}

enum OtTheatreType {
  GENERAL
  MODULAR
  LAMINAR
  HYBRID
}

enum OtAirflowType {
  STANDARD
  LAMINAR
}

enum OtPressureType {
  POSITIVE
  NEGATIVE
  NEUTRAL
}

enum OtEquipmentCategory {
  ANESTHESIA_MACHINE
  AIRWAY_MANAGEMENT
  VENTILATION_RESPIRATORY
  PATIENT_MONITORING
  HEMODYNAMIC_MONITORING
  SURGICAL_INSTRUMENTS
  OR_FURNITURE
  OR_LIGHTING
  ELECTROSURGERY_ENERGY
  ENDOSCOPY_LAPAROSCOPY
  IMAGING_INTRAOP
  STERILIZATION_CSSD
  DISINFECTION_CLEANING
  STERILE_STORAGE_PACKAGING
  MEDICAL_GASES
  SUCTION_SYSTEMS
  POWER_BACKUP
  PATIENT_WARMING
  DVT_PROPHYLAXIS
  SAFETY_EMERGENCY
  RECOVERY_PACU_EQUIPMENT
  IT_AV_EQUIPMENT
  CONSUMABLES_DISPOSABLES
  OTHER
}

model OtSuite {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation("OtSuite_Branch", fields: [branchId], references: [id])

  // Optional: link suite to a location node representing OT complex area (floor/wing)
  locationNodeId String?
  locationNode   LocationNode? @relation("OtSuite_LocationNode", fields: [locationNodeId], references: [id])

  code   String
  name   String
  status OtSuiteStatus @default(draft)

  // Suite-level config (turnaround time, cleaning time, min recovery bays, etc.)
  config Json?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  spaces    OtSpace[]
  equipment OtEquipment[]

  @@unique([branchId, code])
  @@index([branchId])
  @@index([locationNodeId])
}

model OtSpace {
  id      String  @id @default(cuid())
  suiteId String
  suite   OtSuite @relation(fields: [suiteId], references: [id], onDelete: Cascade)

  type OtSpaceType
  code String
  name String

  // Optional: map each OT space to a specific LocationNode (room) in your location tree
  locationNodeId String?
  locationNode   LocationNode? @relation("OtSpace_LocationNode", fields: [locationNodeId], references: [id])

  notes String?
  meta  Json?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  theatre     OtTheatre?
  recoveryBay OtRecoveryBay?
  equipment   OtEquipment[]

  @@unique([suiteId, code])
  @@index([suiteId, type])
  @@index([locationNodeId])
}

model OtTheatre {
  id      String  @id @default(cuid())
  spaceId String  @unique
  space   OtSpace @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  theatreType OtTheatreType  @default(GENERAL)
  airflow     OtAirflowType  @default(STANDARD)
  pressure    OtPressureType @default(POSITIVE)

  // Optional classification fields (keep flexible for later)
  isoClass String?
  meta     Json?

  // If your DB is Postgres, String[] is fine. Otherwise switch to Json.
  specialtyCodes String[] @default([])

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tables OtTable[]

  @@index([spaceId])
}

model OtRecoveryBay {
  id      String  @id @default(cuid())
  spaceId String  @unique
  space   OtSpace @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  bedCount     Int @default(1)
  monitorCount Int @default(0)
  oxygenPoints Int @default(0)

  meta Json?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OtTable {
  id        String    @id @default(cuid())
  theatreId String
  theatre   OtTheatre @relation(fields: [theatreId], references: [id], onDelete: Cascade)

  code      String
  name      String
  isPrimary Boolean @default(true)

  manufacturer String?
  model        String?
  serialNo     String?
  installedAt  DateTime?

  meta Json?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([theatreId, code])
  @@index([theatreId])
}

model OtEquipment {
  id String @id @default(cuid())

  suiteId String
  suite   OtSuite @relation(fields: [suiteId], references: [id], onDelete: Cascade)

  // Optional: assign equipment to a specific OT space (theatre/recovery/etc.)
  spaceId String?
  space   OtSpace? @relation(fields: [spaceId], references: [id], onDelete: SetNull)

  category OtEquipmentCategory @default(OTHER)
  name     String
  qty      Int                 @default(1)

  manufacturer String?
  model        String?
  serialNo     String?

  lastServiceAt           DateTime?
  nextServiceAt           DateTime?
  maintenanceIntervalDays Int?

  meta Json?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([suiteId, category])
  @@index([spaceId])
}

// ---------------- Diagnostics Facilities (Infrastructure) ----------------
enum DiagnosticServicePointType {
  LAB
  RADIOLOGY
  CARDIO_DIAGNOSTICS
  NEURO_DIAGNOSTICS
  PULMONARY_DIAGNOSTICS
  ENDOSCOPY
  OTHER
}

enum DiagnosticModality {
  // Imaging
  XRAY
  ULTRASOUND
  CT
  MRI
  MAMMOGRAPHY
  FLUOROSCOPY

  // Cardio / Neuro / Pulmonary
  ECG
  ECHO
  TMT
  HOLTER
  PFT
  EEG
  EMG_NCV

  // Lab / Collection
  LAB
  SAMPLE_COLLECTION

  // Procedure rooms
  PROCEDURE_ROOM

  OTHER
}

enum DiagnosticKind {
  LAB
  IMAGING
  PROCEDURE
}

enum DiagnosticResultDataType {
  NUMERIC
  TEXT
  BOOLEAN
  CHOICE
}

enum DiagnosticTemplateKind {
  IMAGING_REPORT
  LAB_REPORT
}

enum DiagnosticPackVersionStatus {
  DRAFT
  ACTIVE
  RETIRED
}

model DiagnosticSection {
  id        String   @id @default(cuid())
  branchId  String
  code      String
  name      String
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  categories DiagnosticCategory[]
  items      DiagnosticItem[]

  @@unique([branchId, code])
  @@index([branchId, isActive])
}

model DiagnosticCategory {
  id        String   @id @default(cuid())
  branchId  String
  sectionId String
  code      String
  name      String
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  section DiagnosticSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  items   DiagnosticItem[]

  @@unique([branchId, code])
  @@index([branchId, sectionId, isActive])
}

model SpecimenType {
  id            String   @id @default(cuid())
  branchId      String
  code          String
  name          String
  container     String?
  minVolumeMl   Float?
  handlingNotes String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  items DiagnosticItem[]

  @@unique([branchId, code])
  @@index([branchId, isActive])
}

model DiagnosticItem {
  id       String         @id @default(cuid())
  branchId String
  code     String
  name     String
  kind     DiagnosticKind

  // taxonomy
  sectionId  String
  categoryId String?

  // lab
  specimenId     String?
  tatMinsRoutine Int?
  tatMinsStat    Int?

  // imaging/procedure
  requiresAppointment Boolean @default(false)
  preparationText     String?
  consentRequired     Boolean @default(false)

  // Optional: link to ServiceItem master for unified orderables/catalogues
  serviceItemId String?
  serviceItem   ServiceItem? @relation("DiagnosticItem_ServiceItem", fields: [serviceItemId], references: [id], onDelete: SetNull)

  // panels
  isPanel Boolean @default(false)

  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  section  DiagnosticSection   @relation(fields: [sectionId], references: [id], onDelete: Restrict)
  category DiagnosticCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  specimen SpecimenType?       @relation(fields: [specimenId], references: [id], onDelete: SetNull)

  // panel composition
  panelChildren DiagnosticPanelItem[] @relation("PanelParent")
  panelParents  DiagnosticPanelItem[] @relation("PanelChild")

  // lab results
  parameters DiagnosticParameter[]

  // templates
  templates               DiagnosticTemplate[]
  // Facilities & resources layer: which service points can perform this item
  capabilities            DiagnosticCapability[]
  ServicePackageComponent ServicePackageComponent[]
  OrderSetItem            OrderSetItem[]

  @@unique([branchId, code])
  @@unique([serviceItemId])
  @@index([branchId, kind, isActive])
  @@index([branchId, sectionId, categoryId])
}

model DiagnosticPanelItem {
  id        String   @id @default(cuid())
  panelId   String
  itemId    String
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  panel DiagnosticItem @relation("PanelParent", fields: [panelId], references: [id], onDelete: Cascade)
  item  DiagnosticItem @relation("PanelChild", fields: [itemId], references: [id], onDelete: Restrict)

  @@unique([panelId, itemId])
  @@index([panelId, isActive])
}

model DiagnosticParameter {
  id          String                   @id @default(cuid())
  testId      String
  code        String
  name        String
  dataType    DiagnosticResultDataType
  unit        String?
  precision   Int? // decimals
  allowedText String? // for CHOICE: comma separated values (simple MVP)

  // critical thresholds (for NUMERIC)
  criticalLow  Float?
  criticalHigh Float?

  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  test   DiagnosticItem             @relation(fields: [testId], references: [id], onDelete: Cascade)
  ranges DiagnosticReferenceRange[]

  @@unique([testId, code])
  @@index([testId, isActive])
}

model DiagnosticReferenceRange {
  id          String @id @default(cuid())
  parameterId String

  // demographics
  sex        String? // M/F/O or null
  ageMinDays Int?
  ageMaxDays Int?

  // range
  low       Float?
  high      Float?
  textRange String?

  // notes / remarks (display-only)
  notes String?

  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  parameter DiagnosticParameter @relation(fields: [parameterId], references: [id], onDelete: Cascade)

  @@index([parameterId, isActive])
}

model DiagnosticTemplate {
  id        String                 @id @default(cuid())
  itemId    String
  kind      DiagnosticTemplateKind @default(IMAGING_REPORT)
  name      String
  body      String
  isActive  Boolean                @default(true)
  createdAt DateTime               @default(now())
  updatedAt DateTime               @updatedAt

  item DiagnosticItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId, kind, isActive])
}

model DiagnosticServicePoint {
  id String @id @default(cuid())

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  // Mandatory: every diagnostic unit must be tagged to a location node within branch
  locationNodeId String
  locationNode   LocationNode @relation(fields: [locationNodeId], references: [id], onDelete: Restrict)

  // Optional: link to existing infra Unit (if you want), but not required
  unitId String?
  unit   Unit?   @relation(fields: [unitId], references: [id], onDelete: SetNull)

  code String @db.VarChar(64)
  name String @db.VarChar(160)

  type DiagnosticServicePointType @default(OTHER)

  isActive  Boolean @default(true)
  sortOrder Int     @default(0)
  notes     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  rooms     DiagnosticServicePointRoom[]
  resources DiagnosticServicePointResource[]
  equipment DiagnosticServicePointEquipment[]

  // Optional routing contract for future operations
  capabilities DiagnosticCapability[]

  @@unique([branchId, code])
  @@index([branchId, type, isActive, sortOrder])
  @@index([branchId, locationNodeId])
  @@index([branchId, unitId])
}

model DiagnosticServicePointRoom {
  id       String @id @default(cuid())
  branchId String

  servicePointId String
  servicePoint   DiagnosticServicePoint @relation(fields: [servicePointId], references: [id], onDelete: Cascade)

  roomId String
  room   UnitRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)

  modality  DiagnosticModality @default(OTHER)
  sortOrder Int                @default(0)
  isActive  Boolean            @default(true)
  notes     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([servicePointId, roomId])
  @@index([branchId, servicePointId, isActive])
  @@index([branchId, roomId])
  @@index([branchId, modality, isActive])
}

model DiagnosticServicePointResource {
  id       String @id @default(cuid())
  branchId String

  servicePointId String
  servicePoint   DiagnosticServicePoint @relation(fields: [servicePointId], references: [id], onDelete: Cascade)

  resourceId String
  resource   UnitResource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  modality  DiagnosticModality @default(OTHER)
  sortOrder Int                @default(0)
  isActive  Boolean            @default(true)
  notes     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([servicePointId, resourceId])
  @@index([branchId, servicePointId, isActive])
  @@index([branchId, resourceId])
  @@index([branchId, modality, isActive])
}

model DiagnosticServicePointEquipment {
  id       String @id @default(cuid())
  branchId String

  servicePointId String
  servicePoint   DiagnosticServicePoint @relation(fields: [servicePointId], references: [id], onDelete: Cascade)

  equipmentId String
  equipment   EquipmentAsset @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  modality  DiagnosticModality @default(OTHER)
  sortOrder Int                @default(0)
  isActive  Boolean            @default(true)
  notes     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([servicePointId, equipmentId])
  @@index([branchId, servicePointId, isActive])
  @@index([branchId, equipmentId])
  @@index([branchId, modality, isActive])
}

model DiagnosticCapability {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  diagnosticItemId String
  diagnosticItem   DiagnosticItem @relation(fields: [diagnosticItemId], references: [id], onDelete: Cascade)

  servicePointId String
  servicePoint   DiagnosticServicePoint @relation(fields: [servicePointId], references: [id], onDelete: Cascade)

  // Optional override (item.kind=IMAGING but modality could be XRAY vs USG etc.)
  modality DiagnosticModality?

  // future operations use these
  defaultDurationMins Int?
  isPrimary           Boolean @default(false)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Optional constraints: restrict to specific rooms/resources/equipment
  allowedRooms     DiagnosticCapabilityRoom[]
  allowedResources DiagnosticCapabilityResource[]
  allowedEquipment DiagnosticCapabilityEquipment[]

  @@unique([servicePointId, diagnosticItemId])
  @@index([branchId, diagnosticItemId, isActive])
  @@index([branchId, servicePointId, isActive])
  @@index([modality, isActive])
}

model DiagnosticCapabilityRoom {
  id       String @id @default(cuid())
  branchId String

  capabilityId String
  capability   DiagnosticCapability @relation(fields: [capabilityId], references: [id], onDelete: Cascade)

  roomId String
  room   UnitRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([capabilityId, roomId])
  @@index([branchId, capabilityId, isActive])
  @@index([branchId, roomId])
}

model DiagnosticCapabilityResource {
  id       String @id @default(cuid())
  branchId String

  capabilityId String
  capability   DiagnosticCapability @relation(fields: [capabilityId], references: [id], onDelete: Cascade)

  resourceId String
  resource   UnitResource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([capabilityId, resourceId])
  @@index([branchId, capabilityId, isActive])
  @@index([branchId, resourceId])
}

model DiagnosticCapabilityEquipment {
  id       String @id @default(cuid())
  branchId String

  capabilityId String
  capability   DiagnosticCapability @relation(fields: [capabilityId], references: [id], onDelete: Cascade)

  equipmentId String
  equipment   EquipmentAsset @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([capabilityId, equipmentId])
  @@index([branchId, capabilityId, isActive])
  @@index([branchId, equipmentId])
}

model DiagnosticPack {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  labType     String?
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  versions DiagnosticPackVersion[]
}

model DiagnosticPackVersion {
  id      String                      @id @default(cuid())
  packId  String
  pack    DiagnosticPack              @relation(fields: [packId], references: [id], onDelete: Cascade)
  version Int
  status  DiagnosticPackVersionStatus @default(DRAFT)
  notes   String?
  payload Json

  createdByUserId String?
  createdByUser   User?   @relation("DiagnosticPackVersionCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([packId, version])
  @@index([packId, status])
}

// ---------------------------------------------------------------------------
// Equipment Register Extensions (Additive; no breaking changes)
// ---------------------------------------------------------------------------

enum EquipmentDocumentType {
  AERB_LICENSE
  PCPNDT_CERTIFICATE
  SHIELDING_PLAN
  CALIBRATION_CERTIFICATE
  INSTALLATION_REPORT
  USER_MANUAL
  SOP
  WARRANTY_CARD
  AMC_CONTRACT
  SERVICE_REPORT
  INSURANCE_POLICY
  OTHER
}

enum EquipmentContractType {
  WARRANTY
  AMC
  CMC
  LEASE
  RENTAL
  INSURANCE
  OTHER
}

enum EquipmentMaintenanceType {
  PM
  CALIBRATION
  QUALIFICATION
  SAFETY_TEST
  REPAIR
  OTHER
}

enum EquipmentMaintenanceStatus {
  DUE
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  SKIPPED
  CANCELLED
}

enum EquipmentEvidenceStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum EquipmentMovementReason {
  INSTALLATION
  TRANSFER
  TEMPORARY_MOVE
  STORAGE
  REPLACEMENT
  DECOMMISSION
  OTHER
}

enum GovernedChangeStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  CANCELLED
  APPLIED
}

// --- 1) Effective-dated snapshot history (no destructive edits) ---
model EquipmentAssetRevision {
  id      String         @id @default(cuid())
  assetId String
  asset   EquipmentAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  // Snapshot fields (copied from EquipmentAsset at time of change)
  code     String            @db.VarChar(64)
  name     String            @db.VarChar(160)
  category EquipmentCategory

  make   String?
  model  String?
  serial String?

  ownerDepartmentId String?

  operationalStatus EquipmentOperationalStatus
  isSchedulable     Boolean

  amcVendor       String?
  amcValidFrom    DateTime?
  amcValidTo      DateTime?
  warrantyValidTo DateTime?

  pmFrequencyDays Int?
  nextPmDueAt     DateTime?

  aerbLicenseNo String?
  aerbValidTo   DateTime?

  pcpndtRegNo   String?
  pcpndtValidTo DateTime?

  // Effective dating
  effectiveFrom DateTime
  effectiveTo   DateTime?

  // Governance traceability
  createdByUserId String?
  createdByUser   User?   @relation("EquipmentRevisionCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([assetId, effectiveFrom])
  @@index([code])
}

// --- 2) Placement bound to your topology (LocationNode / Unit / Room / Resource) ---
model EquipmentPlacement {
  id      String         @id @default(cuid())
  assetId String         @unique
  asset   EquipmentAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  locationNodeId String?
  locationNode   LocationNode? @relation(fields: [locationNodeId], references: [id], onDelete: SetNull)

  unitId String?
  unit   Unit?   @relation(fields: [unitId], references: [id], onDelete: SetNull)

  roomId String?
  room   UnitRoom? @relation(fields: [roomId], references: [id], onDelete: SetNull)

  resourceId String?
  resource   UnitResource? @relation(fields: [resourceId], references: [id], onDelete: SetNull)

  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?

  createdByUserId String?
  createdByUser   User?   @relation("EquipmentPlacementCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([branchId, locationNodeId])
  @@index([branchId, unitId])
  @@index([branchId, roomId])
  @@index([branchId, resourceId])
}

// --- 3) Movement log (portable/shared asset reality) ---
model EquipmentMovement {
  id      String         @id @default(cuid())
  assetId String
  asset   EquipmentAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  reason EquipmentMovementReason @default(TRANSFER)
  notes  String?

  fromLocationNodeId String?
  fromUnitId         String?
  fromRoomId         String?
  fromResourceId     String?

  toLocationNodeId String?
  toUnitId         String?
  toRoomId         String?
  toResourceId     String?

  movedAt DateTime @default(now())

  movedByUserId String?
  movedByUser   User?   @relation("EquipmentMovedBy", fields: [movedByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([assetId, movedAt])
  @@index([branchId, movedAt])
}

// --- 4) Documents & evidence (licenses, calibration certs, manuals, contracts) ---
model EquipmentDocument {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  assetId String
  asset   EquipmentAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  type  EquipmentDocumentType
  title String                @db.VarChar(200)

  fileUrl  String
  fileMime String?
  fileSize Int?
  checksum String?

  refNo     String?
  issuedAt  DateTime?
  validFrom DateTime?
  validTo   DateTime?

  meta Json?

  uploadedByUserId String?
  uploadedByUser   User?   @relation("EquipmentDocUploadedBy", fields: [uploadedByUserId], references: [id], onDelete: SetNull)

  createdAt                   DateTime                      @default(now())
  updatedAt                   DateTime                      @updatedAt
  EquipmentComplianceEvidence EquipmentComplianceEvidence[]

  @@index([assetId, type])
  @@index([branchId, type])
  @@index([branchId, validTo])
}

// --- 5) Contracts (AMC/CMC/Lease/Insurance), without deleting existing quick fields ---
model EquipmentContract {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  assetId String
  asset   EquipmentAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  type       EquipmentContractType
  contractNo String?

  vendorName    String?
  vendorContact Json?

  startAt DateTime?
  endAt   DateTime?

  terms    Json?
  isActive Boolean @default(true)

  createdByUserId String?
  createdByUser   User?   @relation("EquipmentContractCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([assetId, type, isActive])
  @@index([branchId, type, endAt])
}

// --- 6) Maintenance scheduling + execution records (beyond “nextPmDueAt”) ---
model EquipmentMaintenanceTask {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  assetId String
  asset   EquipmentAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  type   EquipmentMaintenanceType
  status EquipmentMaintenanceStatus @default(DUE)

  dueAt        DateTime
  scheduledFor DateTime?
  startedAt    DateTime?
  completedAt  DateTime?

  downtimeTicketId String?
  downtimeTicket   DowntimeTicket? @relation(fields: [downtimeTicketId], references: [id], onDelete: SetNull)

  performedByVendor  String?
  performedByStaffId String?
  performedByStaff   Staff?  @relation(fields: [performedByStaffId], references: [id], onDelete: SetNull)

  checklist    Json?
  measurements Json?
  outcomeNotes String?

  createdByUserId String?
  createdByUser   User?   @relation("EquipmentMaintCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([branchId, dueAt, status])
  @@index([assetId, status])
}

// --- 7) Verified compliance evidence (Compliance Officer workflow) ---
model EquipmentComplianceEvidence {
  id       String @id @default(cuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  assetId String
  asset   EquipmentAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  complianceCode String @db.VarChar(64) // e.g., "AERB", "PCPNDT"
  evidenceType   String @db.VarChar(64) // e.g., "LICENSE", "QC_REPORT"

  documentId String?
  document   EquipmentDocument? @relation(fields: [documentId], references: [id], onDelete: SetNull)

  status EquipmentEvidenceStatus @default(PENDING)

  verifiedAt       DateTime?
  verifiedByUserId String?
  verifiedByUser   User?     @relation("EquipmentEvidenceVerifiedBy", fields: [verifiedByUserId], references: [id], onDelete: SetNull)

  notes String?
  meta  Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([branchId, complianceCode, status])
  @@index([assetId, complianceCode])
}

// --- 8) Maker–checker-ready governance (generic for Setup Studio edits) ---
model GovernedChangeRequest {
  id       String  @id @default(cuid())
  branchId String?
  branch   Branch? @relation(fields: [branchId], references: [id], onDelete: SetNull)

  entity   String // e.g., "EquipmentAsset", "EquipmentContract"
  entityId String?
  action   String // e.g., "CREATE", "UPDATE", "RETIRE", "MOVE"

  payload     Json
  effectiveAt DateTime @default(now())

  status GovernedChangeStatus @default(DRAFT)

  createdByUserId String?
  createdByUser   User?   @relation("GovernedChangeCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  submittedAt       DateTime?
  submittedByUserId String?
  submittedByUser   User?     @relation("GovernedChangeSubmittedBy", fields: [submittedByUserId], references: [id], onDelete: SetNull)

  approvedAt       DateTime?
  approvedByUserId String?
  approvedByUser   User?     @relation("GovernedChangeApprovedBy", fields: [approvedByUserId], references: [id], onDelete: SetNull)
  approvalNote     String?

  rejectedAt       DateTime?
  rejectedByUserId String?
  rejectedByUser   User?     @relation("GovernedChangeRejectedBy", fields: [rejectedByUserId], references: [id], onDelete: SetNull)
  rejectionReason  String?

  appliedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([branchId, status, createdAt])
  @@index([entity, entityId, status])
}

enum ServiceLifecycleStatus {
  DRAFT
  IN_REVIEW
  APPROVED
  PUBLISHED
  DEPRECATED
}

enum ServiceChargeUnit {
  PER_UNIT
  PER_VISIT
  PER_TEST
  PER_HOUR
  PER_DAY
  PER_SIDE
  PER_LEVEL
  PER_SESSION

  PER_PROCEDURE
  PER_PACKAGE
}

enum TaxType {
  GST
  TDS
  OTHER
}

enum PayerKind {
  CASH
  INSURANCE
  TPA
  CORPORATE
  GOVERNMENT
  OTHER
}

enum ContractStatus {
  DRAFT
  ACTIVE
  SUSPENDED
  EXPIRED
  TERMINATED
}

enum TariffPlanKind {
  PRICE_LIST
  PAYER_CONTRACT
}

enum TariffPlanStatus {
  DRAFT
  ACTIVE
  RETIRED
}

enum PackagePricingMode {
  COMPONENT_SUM
  FIXED
  DISCOUNT_PERCENT
  DISCOUNT_AMOUNT
  CAP
}

enum TaxApplicability {
  GST_EXEMPT
  GST_STANDARD
  GST_ZERO
  GST_REDUCED
}

enum CatalogueScope {
  ENTERPRISE
  BRANCH
}

enum CatalogueStatus {
  DRAFT
  IN_REVIEW
  APPROVED
  PUBLISHED
  RETIRED
}

enum PackageStatus {
  DRAFT
  IN_REVIEW
  APPROVED
  PUBLISHED
  RETIRED
}

enum PackageComponentType {
  SERVICE_ITEM
  DIAGNOSTIC_ITEM
  CHARGE_MASTER_ITEM
}

enum OrderSetStatus {
  DRAFT
  IN_REVIEW
  APPROVED
  PUBLISHED
  RETIRED
}

enum OrderSetItemType {
  SERVICE_ITEM
  DIAGNOSTIC_ITEM
  SERVICE_PACKAGE
}

enum StandardCodeSystem {
  INTERNAL
  LOINC
  CPT
  HCPCS
  SNOMED
  ICD10PCS
  OTHER
}

enum ExternalSystemType {
  LIS
  RIS
  ERP
  OTHER
}
